<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>èµµè†å·çš„ä¸ªäººåšå®¢</title>
  
  <subtitle>èµµè†å·çš„ä¸ªäººåšå®¢</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://jingzhouzhao.github.io/"/>
  <updated>2021-05-08T06:48:57.879Z</updated>
  <id>https://jingzhouzhao.github.io/</id>
  
  <author>
    <name>èµµè†å·</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Nettyä¸­FastThreadLocalæºç è§£æ</title>
    <link href="https://jingzhouzhao.github.io/archives/4b47846d.html"/>
    <id>https://jingzhouzhao.github.io/archives/4b47846d.html</id>
    <published>2021-05-08T02:25:25.000Z</published>
    <updated>2021-05-08T06:48:57.879Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>ThreadLocal</code>ä¸€ä¸ªç‰¹æ®Šå˜ä½“ï¼Œå½“ä»<code>FastThreadLocalThread</code>è®¿é—®æ—¶ï¼Œå¯è·å¾—æ›´é«˜çš„è®¿é—®æ€§èƒ½ã€‚<br>åœ¨å†…éƒ¨ï¼Œ <code>FastThreadLocal</code>åœ¨æ•°ç»„ä¸­ä½¿ç”¨å¸¸é‡ç´¢å¼•æ¥æŸ¥æ‰¾å˜é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å“ˆå¸Œç å’Œå“ˆå¸Œè¡¨ã€‚ å°½ç®¡çœ‹ä¼¼éå¸¸å¾®å¦™ï¼Œä½†ä¸ä½¿ç”¨å“ˆå¸Œè¡¨ç›¸æ¯”ï¼Œå®ƒåœ¨æ€§èƒ½ä¸Šå´æœ‰ä¸€ç‚¹ä¼˜åŠ¿ï¼Œå¹¶ä¸”åœ¨ç»å¸¸è®¿é—®æ—¶å¾ˆæœ‰ç”¨ã€‚<br>è¦åˆ©ç”¨æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ‚¨çš„çº¿ç¨‹å¿…é¡»æ˜¯<code>FastThreadLocalThread</code>æˆ–å…¶å­ç±»å‹ã€‚ ç”±äºè¿™ä¸ªåŸå› ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>DefaultThreadFactory</code>åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹å‡ä¸º<code>FastThreadLocalThread</code> ã€‚<br>è¯·æ³¨æ„ï¼Œåªæœ‰åœ¨æ‰©å±•<code>FastThreadLocalThread</code>çº¿ç¨‹ä¸Šæ‰å¯ä»¥ä½¿ç”¨å¿«é€Ÿè·¯å¾„ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µæ¥å­˜å‚¨å¿…è¦çš„çŠ¶æ€ã€‚ ä»»ä½•å…¶ä»–ç±»å‹çš„çº¿ç¨‹çš„è®¿é—®éƒ½å›é€€åˆ°å¸¸è§„<code>ThreadLocal</code> ã€‚</p><p>ä¸Šé¢è¿™æ®µæè¿°æ¥è‡ª<code>FastThreadLocal</code>æºç ä¸­çš„æ–‡æ¡£ï¼Œä»ä¸­å¯ä»¥çŸ¥é“<code>FastThreadLocal</code>å¿…é¡»å’Œ<code>FastThreadLocalThread</code>æˆ–å…¶å­ç±»å‹ä¸€èµ·ä½¿ç”¨æ‰å¯ä»¥è¾¾åˆ°Fastçš„æ•ˆæœã€‚</p><h2 id="FastThreadLocalThread"><a href="#FastThreadLocalThread" class="headerlink" title="FastThreadLocalThread"></a>FastThreadLocalThread</h2><p>æ—¢ç„¶å¿…é¡»è¦å’Œ<code>FastThreadLocalThread</code>    ä¸€èµ·ä½¿ç”¨ï¼Œé‚£å°±æ¥çœ‹çœ‹<code>FastThreadLocalThread</code>åˆ°åº•æœ‰ä»€ä¹ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A special &#123;<span class="doctag">@link</span> Thread&#125; that provides fast access to &#123;<span class="doctag">@link</span> FastThreadLocal&#125; variables.</span></span><br><span class="line"><span class="comment"> * ä¸€ç§ç‰¹æ®Šçš„&#123;<span class="doctag">@link</span> Thread&#125;ï¼Œå¯ä»¥å¿«é€Ÿè®¿é—®&#123;<span class="doctag">@link</span> FastThreadLocal&#125;å˜é‡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastThreadLocalThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// This will be set to true if we have a chance to wrap the Runnable.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> cleanupFastThreadLocals;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InternalThreadLocalMap threadLocalMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastThreadLocalThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cleanupFastThreadLocals = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastThreadLocalThread</span><span class="params">(Runnable target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(FastThreadLocalRunnable.wrap(target));</span><br><span class="line">        cleanupFastThreadLocals = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure><p>çœç•¥äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°<code>FastThreadLocalThread</code>ç»§æ‰¿è‡ª<code>Thread</code>ï¼Œé¢å¤–å¤šäº†ä¸€ä¸ª<code>InternalThreadLocalMap threadLocalMap</code>ï¼Œä»docä¸­å¯ä»¥çœ‹å‡ºè¿™ä¸ªå˜é‡å°±æ˜¯å…³é”®ã€‚</p><h2 id="InternalThreadLocalMap"><a href="#InternalThreadLocalMap" class="headerlink" title="InternalThreadLocalMap"></a>InternalThreadLocalMap</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The internal data structure that stores the thread-local variables for Netty and all &#123;<span class="doctag">@link</span> FastThreadLocal&#125;s.</span></span><br><span class="line"><span class="comment"> * Note that this class is for internal use only and is subject to change at any time.  Use &#123;<span class="doctag">@link</span> FastThreadLocal&#125;</span></span><br><span class="line"><span class="comment"> * unless you know what you are doing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalThreadLocalMap</span> <span class="keyword">extends</span> <span class="title">UnpaddedInternalThreadLocalMap</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = <span class="keyword">new</span> ThreadLocal&lt;InternalThreadLocalMap&gt;();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger nextIndex = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Used by &#123;<span class="doctag">@link</span> FastThreadLocal&#125; */</span></span><br><span class="line">    Object[] indexedVariables;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Object UNSET = <span class="keyword">new</span> Object();</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = Thread.currentThread();</span><br><span class="line">        <span class="keyword">if</span> (thread <span class="keyword">instanceof</span> FastThreadLocalThread) &#123;</span><br><span class="line">            <span class="keyword">return</span> fastGet((FastThreadLocalThread) thread);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> slowGet();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">fastGet</span><span class="params">(FastThreadLocalThread thread)</span> </span>&#123;</span><br><span class="line">        InternalThreadLocalMap threadLocalMap = thread.threadLocalMap();</span><br><span class="line">        <span class="keyword">if</span> (threadLocalMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            thread.setThreadLocalMap(threadLocalMap = <span class="keyword">new</span> InternalThreadLocalMap());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> threadLocalMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">slowGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = UnpaddedInternalThreadLocalMap.slowThreadLocalMap;</span><br><span class="line">        InternalThreadLocalMap ret = slowThreadLocalMap.get();</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ret = <span class="keyword">new</span> InternalThreadLocalMap();</span><br><span class="line">            slowThreadLocalMap.set(ret);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextVariableIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = nextIndex.getAndIncrement();</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            nextIndex.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"too many thread-local indexed variables"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;    </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if and only if a new thread-local variable has been created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setIndexedVariable</span><span class="params">(<span class="keyword">int</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        Object[] lookup = indexedVariables;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; lookup.length) &#123;</span><br><span class="line">            Object oldValue = lookup[index];</span><br><span class="line">            lookup[index] = value;</span><br><span class="line">            <span class="keyword">return</span> oldValue == UNSET;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            expandIndexedVariableTableAndSet(index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>InternalThreadLocalMap</code>ç»§æ‰¿è‡ª<code>UnpaddedInternalThreadLocalMap</code>ï¼Œä¸ºäº†å¥½çœ‹ä¸€ç‚¹æˆ‘æŠŠçˆ¶ç±»ä¸­çš„ç›¸å…³ä»£ç æ”¾åˆ°äº†ä¸€èµ·ï¼Œdubboå€Ÿé‰´nettyä»£ç ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ã€‚</p><h2 id="FastThreadLocal"><a href="#FastThreadLocal" class="headerlink" title="FastThreadLocal"></a>FastThreadLocal</h2><p>æœ€åçœ‹çœ‹<code>FastThreadLocal</code>æ˜¯æ€ä¹ˆæŠŠè¿™å‡ ä¸ªæ ¸å¿ƒç±»ç»™ä¸²èµ·æ¥çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastThreadLocal</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> variablesToRemoveIndex = InternalThreadLocalMap.nextVariableIndex();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastThreadLocal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        index = InternalThreadLocalMap.nextVariableIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current value for the current thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.get();</span><br><span class="line">        Object v = threadLocalMap.indexedVariable(index);</span><br><span class="line">        <span class="keyword">if</span> (v != InternalThreadLocalMap.UNSET) &#123;</span><br><span class="line">            <span class="keyword">return</span> (V) v;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> initialize(threadLocalMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> V <span class="title">initialize</span><span class="params">(InternalThreadLocalMap threadLocalMap)</span> </span>&#123;</span><br><span class="line">        V v = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            v = initialValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            PlatformDependent.throwException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        threadLocalMap.setIndexedVariable(index, v);</span><br><span class="line">        addToVariablesToRemove(threadLocalMap, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the initial value for this thread-local variable.</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ä¼šæŠŠè¦†ç›–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> V <span class="title">initialValue</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://files.catbox.moe/nxk8yt.png" alt></p><h2 id="å…«å¦"><a href="#å…«å¦" class="headerlink" title="å…«å¦"></a>å…«å¦</h2><p><a href="https://github.com/apache/dubbo/pull/1745" target="_blank" rel="noopener">https://github.com/apache/dubbo/pull/1745</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;&lt;code&gt;ThreadLocal&lt;/code&gt;ä¸€ä¸ªç‰¹æ®Šå˜ä½“ï¼Œå½“ä»&lt;code&gt;FastThreadLocalThread&lt;/code&gt;è®¿é—®æ—¶
      
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Mybatisæ‰¹é‡æ›´æ–°çš„ä¸€ä¸ªå°é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/e8013d2a.html"/>
    <id>https://jingzhouzhao.github.io/archives/e8013d2a.html</id>
    <published>2021-03-25T09:20:15.000Z</published>
    <updated>2021-03-25T09:34:47.232Z</updated>
    
    <content type="html"><![CDATA[<p>æ‰¹é‡æ›´æ–°çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚update case whenï¼Œforeach updateç­‰ï¼Œä»Šå¤©åœ¨ä½¿ç”¨å…¶ä¸­ä¸€ç§foreach updateæ—¶ä¸€ç›´æŠ¥SQLè¯­æ³•é”™è¯¯ï¼Œçœ‹äº†åŠå¤©æ²¡çœ‹å‡ºå“ªé‡Œæœ‰é—®é¢˜:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id&#x3D;&quot;updateBatch&quot; parameterType&#x3D;&quot;list&quot;&gt;</span><br><span class="line">    &lt;foreach collection&#x3D;&quot;list&quot; item&#x3D;&quot;item&quot; separator&#x3D;&quot;;&quot; index&#x3D;&quot;index&quot;&gt;</span><br><span class="line">      update test</span><br><span class="line">      &lt;set&gt;</span><br><span class="line">        status &#x3D; #&#123;item.status,jdbcType&#x3D;BIGINT&#125;,</span><br><span class="line">        amount &#x3D; #&#123;item.amount,jdbcType&#x3D;BIGINT&#125;,</span><br><span class="line">        version &#x3D; version+1,</span><br><span class="line">        gmt_modified &#x3D; now(),</span><br><span class="line">      &lt;&#x2F;set&gt;</span><br><span class="line">      &lt;where&gt;</span><br><span class="line">        id &#x3D; #&#123;item.id&#125;</span><br><span class="line">      &lt;&#x2F;where&gt;</span><br><span class="line">    &lt;&#x2F;foreach&gt;</span><br><span class="line">  &lt;&#x2F;update&gt;</span><br></pre></td></tr></table></figure><p>éå¸¸ç®€å•çš„update SQLï¼Œé€šè¿‡Mybatis foreach ç”Ÿæˆå¤šä¸ªupdate SQLåŒæ—¶æ‰§è¡Œï¼Œä½†æ˜¯è¿è¡Œæ—¶ä¸€ç›´æŠ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;update test</span><br><span class="line">       SET amount &#x3D; -116534270,</span><br><span class="line">        version&#39; at line 10</span><br><span class="line">; bad SQL grammar []; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;update test</span><br><span class="line">       SET amount &#x3D; -116534270,</span><br><span class="line">        version&#39; at line 10</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™ä¸ªé”™è¯¯ä¸‹æ„è¯†çš„è®¤ä¸ºè‚¯å®šæ˜¯sqlå“ªé‡Œå†™çš„ä¸å¯¹æœ‰è¯­æ³•é”™è¯¯ï¼Œå¯æ˜¯æ£€æŸ¥äº†åŠå¤©æ²¡å‘ç°é—®é¢˜ï¼Œè€Œä¸”å°†æŠ¥é”™çš„sql é€šè¿‡navicatè¿è¡Œä¹Ÿå¯ä»¥é€šè¿‡ã€‚</p><p>åæ¥æŸ¥åˆ°å¦‚æœæ‰¹é‡æ‰§è¡Œè¯­å¥éœ€è¦å°†database connection urlä¸­åŠ ä¸Šå¦‚ä¸‹å‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allowMultiQueries&#x3D;true</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„urlä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:&#x2F;&#x2F;x.x.x.x:3306&#x2F;xxxx?allowMultiQueries&#x3D;true&amp;autoReconnect&#x3D;true&amp;useUnicode&#x3D;true&amp;characterset&#x3D;utf8mb4</span><br></pre></td></tr></table></figure><p>ä¸å¾—ä¸è¯´MySQLæŠ¥é”™ä¿¡æ¯å®åœ¨æ˜¯å¤ªæ¨¡ç³Šäº†ã€‚ğŸ˜“</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ‰¹é‡æ›´æ–°çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚update case whenï¼Œforeach updateç­‰ï¼Œä»Šå¤©åœ¨ä½¿ç”¨å…¶ä¸­ä¸€ç§foreach updateæ—¶ä¸€ç›´æŠ¥SQLè¯­æ³•é”™è¯¯ï¼Œçœ‹äº†åŠå¤©æ²¡çœ‹å‡ºå“ªé‡Œæœ‰é—®é¢˜:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;tabl
      
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
      <category term="MySQL" scheme="https://jingzhouzhao.github.io/tags/MySQL/"/>
    
      <category term="Mybatis" scheme="https://jingzhouzhao.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>è®°ä¸€æ¬¡çº¿ä¸Šæ­»é”æ’æŸ¥</title>
    <link href="https://jingzhouzhao.github.io/archives/9e47523f.html"/>
    <id>https://jingzhouzhao.github.io/archives/9e47523f.html</id>
    <published>2021-03-23T03:46:15.000Z</published>
    <updated>2021-03-23T06:48:00.368Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´å¶å°”ä¼šæ”¶åˆ°çº¿ä¸ŠMySQLæ­»é”å‘Šè­¦é€šçŸ¥ï¼Œç”±äºæœ‰è¡¥å¿æœºåˆ¶ï¼Œæœ€ç»ˆä¸šåŠ¡ä¼šå¤„ç†æˆåŠŸï¼Œæ‰€ä»¥æ²¡å¤ªå…³å¿ƒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span><br></pre></td></tr></table></figure><p>æœ€è¿‘åˆæ”¶åˆ°äº†ç›¸åŒçš„å‘Šè­¦ï¼Œå¯èƒ½ä¸æ˜¯å¶ç„¶äº‹ä»¶ï¼Œäºæ˜¯å¼€å§‹æ’æŸ¥ã€‚<br>é¦–å…ˆç¿»çœ‹äº†æ—¥å¿—ï¼Œç»“åˆä»£ç ï¼Œæ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜ã€‚äº‹å‘æ—¶åº”è¯¥ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§æ‰¹é‡å¹¶å‘äº‹ä»¶ã€‚</p><p>äºæ˜¯å‘DBAè¦æ¥äº†deadlock logï¼Œæ—¥å¿—å†…å®¹å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2021-03-22 16:02:01 0x7f1cfc289700</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 153411874, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 8 lock struct(s), heap size 1136, 23 row lock(s), undo log entries 22</span><br><span class="line">MySQL thread id 8203444, OS thread handle 139762013996800, query id 766107488 updating</span><br><span class="line">update test</span><br><span class="line">SET status &#x3D; 4,</span><br><span class="line">version &#x3D; version+1,</span><br><span class="line">gmt_modified &#x3D; &#39;2021-03-22 16:02:01&#39; </span><br><span class="line">where  id &#x3D; 1</span><br><span class="line">and version&#x3D;14</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table &#96;test&#96; trx id 153411874 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 40 PHYSICAL RECORD: n_fields 45; compact format; info bits 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 153411876, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">8 lock struct(s), heap size 1136, 7 row lock(s), undo log entries 6</span><br><span class="line">MySQL thread id 8204162, OS thread handle 139762466330368, query id 766107489  updating</span><br><span class="line">update test</span><br><span class="line">         SET approval_status &#x3D; 5,</span><br><span class="line">                biz_date &#x3D; &#39;2021-02-23 00:00:00&#39;,</span><br><span class="line">                modified_id &#x3D; 123,</span><br><span class="line">                modified_name &#x3D; &#39;xxx&#39;,</span><br><span class="line">                contact_company_id &#x3D; 456,</span><br><span class="line">                contact_company_n</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table &#96;test&#96; trx id 153411876 lock_mode X locks rec but not gap</span><br><span class="line">Record lock, heap no 40 PHYSICAL RECORD: n_fields 45; compact format; info bits 0</span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table &#96;test&#96; trx id 153411876 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 28 PHYSICAL RECORD: n_fields 45; compact format; info bits 0</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ—¥å¿—åªä¿ç•™äº†å…³é”®éƒ¨åˆ†ï¼Œè¡¨åç­‰ä¹Ÿè¿›è¡Œäº†è„±æ•ã€‚<br>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªäº‹åŠ¡éƒ½åœ¨ç­‰å¾…PRIMARYä¹Ÿå°±æ˜¯ä¸»é”®ç´¢å¼•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table &#96;test&#96;</span><br></pre></td></tr></table></figure><p>ç„¶åå†ç»“åˆæ—¥å¿—ä¸­çš„SQLå’Œä»£ç ï¼Œå‘ç°é—®é¢˜çš„åŸå› å¦‚ä¸‹:</p><p>ä¸€å…±æ¶‰åŠ3ä¸ªç³»ç»Ÿï¼Œåˆ†åˆ«æ˜¯Sã€Cã€Fï¼Œåœ¨Sç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªä¸šåŠ¡æ“ä½œå®Œæˆåä¼šç»™Cï¼ŒFå‘æ¶ˆæ¯ï¼ŒCæ”¶åˆ°Sçš„æ¶ˆæ¯å¤„ç†å®Œæˆåä¹Ÿä¼šç»™Få‘ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¦‚å›¾æ‰€ç¤º:</p><p><img src="https://i.loli.net/2021/03/23/cqBePdigLzNIUhF.png" alt="9b1b7abc8bdf0a3113e751fce4700924.png"></p><p>åœ¨Fä¸­å‡ ä¹åŒæ—¶å¼€å¯äº†ä¸¤ä¸ªäº‹åŠ¡ï¼Œå¹¶ä¸”ä¸¤ä¸ªæ¶ˆæ¯åœ¨Fä¸­æ¶‰åŠçš„è®°å½•æ˜¯ç›¸åŒçš„ï¼Œidåˆ†åˆ«æ˜¯1ï¼Œ2ï¼Œè¡¨ä¸ºtestã€‚<br>äºæ˜¯å‡ºç°äº†äº‹åŠ¡ä¸€:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL1:</span><br><span class="line">update test set status &#x3D; 4 ...... where id&#x3D;1</span><br><span class="line"></span><br><span class="line">SQL2:</span><br><span class="line">update test set status &#x3D; 4 ...... where id&#x3D;2</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡äºŒ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL1:</span><br><span class="line">update test SET approval_status &#x3D; 5 ...... where id &#x3D;2</span><br><span class="line"></span><br><span class="line">SQL2:</span><br><span class="line">update test SET approval_status &#x3D; 5 ...... where id &#x3D;1</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡ä¸€å…ˆæŒæœ‰id=1çš„é”ï¼Œäº‹åŠ¡äºŒæŒæœ‰id=2çš„é”ï¼Œäº‹åŠ¡ä¸€å°è¯•è·å–id=2çš„é”ï¼Œäº‹åŠ¡äºŒå°è¯•è·å–id=1çš„é”ï¼Œæ‰€ä»¥æ­»é”äº†ã€‚æœ€åMySQLå›æ»šäº†äº‹åŠ¡äºŒã€‚</p><p>å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯ç”±äºäº§å“å’Œç³»ç»Ÿè®¾è®¡ä¸åˆç†å¯¼è‡´çš„ï¼Œç›®å‰æ­£åœ¨é‡æ„ä¸­ã€‚</p><p>å¦‚æœä¸‹æ¬¡å†å‘ç”Ÿæ­»é”ç›´æ¥çœ‹deadlock logå§ï¼Œæ²¡å¿…è¦æµªè´¹æ—¶é—´ç¿»ä»£ç çœ‹ä¸šåŠ¡æ—¥å¿—äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å‰æ®µæ—¶é—´å¶å°”ä¼šæ”¶åˆ°çº¿ä¸ŠMySQLæ­»é”å‘Šè­¦é€šçŸ¥ï¼Œç”±äºæœ‰è¡¥å¿æœºåˆ¶ï¼Œæœ€ç»ˆä¸šåŠ¡ä¼šå¤„ç†æˆåŠŸï¼Œæ‰€ä»¥æ²¡å¤ªå…³å¿ƒã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line
      
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
      <category term="MySQL" scheme="https://jingzhouzhao.github.io/tags/MySQL/"/>
    
      <category term="Deadlock" scheme="https://jingzhouzhao.github.io/tags/Deadlock/"/>
    
  </entry>
  
  <entry>
    <title>å…³é—­ä»£ç å—ç§»åŠ¨</title>
    <link href="https://jingzhouzhao.github.io/archives/7f244d3f.html"/>
    <id>https://jingzhouzhao.github.io/archives/7f244d3f.html</id>
    <published>2020-08-25T07:22:10.000Z</published>
    <updated>2020-08-25T07:26:32.886Z</updated>
    
    <content type="html"><![CDATA[<p>Mac å¼€å¯äº†ä¸‰æŒ‡æ‹–æ‹½ï¼Œå‘ç°åœ¨IDEAçš„æŸäº›Projectä¸­ï¼Œé€‰ä¸­ä»£ç å—æ—¶ï¼Œè€æ˜¯æ‹–åŠ¨ä»£ç ã€‚è§£å†³åŠæ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Editor â€“&gt; General -&gt; Enable Dragâ€™nâ€™Drop functionality in Editor</span><br></pre></td></tr></table></figure><p>å…³é—­å³å¯ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Mac å¼€å¯äº†ä¸‰æŒ‡æ‹–æ‹½ï¼Œå‘ç°åœ¨IDEAçš„æŸäº›Projectä¸­ï¼Œé€‰ä¸­ä»£ç å—æ—¶ï¼Œè€æ˜¯æ‹–åŠ¨ä»£ç ã€‚è§£å†³åŠæ³•ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;li
      
    
    </summary>
    
      <category term="è¸©å‘è®°å½•" scheme="https://jingzhouzhao.github.io/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨mybatisæ ‡ç­¾æ›¿æ¢ç¡¬ç¼–ç </title>
    <link href="https://jingzhouzhao.github.io/archives/ad1a887a.html"/>
    <id>https://jingzhouzhao.github.io/archives/ad1a887a.html</id>
    <published>2020-08-10T16:00:00.000Z</published>
    <updated>2020-08-13T03:39:22.220Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h2><p>åˆ©ç”¨mybatisæ ‡ç­¾æ›¿æ¢ç¡¬ç¼–ç </p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨é¡¹ç›®ä¸­å¶å°”çœ‹åˆ°è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"querySqlString"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">       1=1</span><br><span class="line">       <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"fundsOrderIdList != null and fundsOrderIdList.size()&gt;0"</span>&gt;</span></span><br><span class="line">           and funds_order_id IN</span><br><span class="line">           <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"fundsOrderIdList"</span> <span class="attr">item</span>=<span class="string">"id"</span> <span class="attr">index</span>=<span class="string">"index"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">               #&#123;id&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­æœ‰ä¸ª<code>1=1</code>å¾ˆæ‰çœ¼ï¼Œè¿™ä¸ªä¸æ˜¯bugï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Œåªæ˜¯ç¨‹åºå‘˜ä¸–ä»£ä¼ æ‰¿ä¸‹æ¥çš„ä¸€ä¸ªä¹ æƒ¯ã€‚</p><a id="more"></a><h2 id="æ•…äº‹"><a href="#æ•…äº‹" class="headerlink" title="æ•…äº‹"></a>æ•…äº‹</h2><p>åœ¨å¾ˆä¹…ä»¥å‰ï¼Œå……æ»¡æ™ºæ…§çš„ç¨‹åºå‘˜ä¸ºäº†è§£å†³åŠ¨æ€æ¡ä»¶æ‹¼æ¥çš„é—®é¢˜ï¼Œå‘æ˜äº†<code>1=1</code>è¿™ä¸ªå†™æ³•ï¼Œå¯¹åº”çš„è¿˜æœ‰<code>1=0</code>çš„å†™æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå†™æ³•åœ¨ä»¥å‰æ˜¯æ€ä¹ˆè§£å†³é—®é¢˜çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">"select * from car_table where 1=1"</span></span><br><span class="line"><span class="keyword">for</span>(Condtion condition:conditions)&#123;</span><br><span class="line">    <span class="comment">/**å‡å¦‚æ²¡æœ‰1=1ï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶ç›´æ¥æ‹¼æ¥ä¸Šandè¯­æ³•å°±é”™è¯¯äº†</span></span><br><span class="line"><span class="comment">    *è¿˜å¾—åšå‡ºé¢å¤–åˆ¤æ–­æ‰è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    sql = sql + <span class="string">" and "</span> + condition.field + <span class="string">" = "</span> + condition.value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡®å®å¾ˆå·§å¦™ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰æ€§èƒ½é—®é¢˜ï¼Œä¸ä¿¡æˆ‘ç»™ä½ ä¸¾ä¸ªğŸŒ°:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pay_channel_with_bank <span class="keyword">where</span> <span class="number">1</span>=<span class="number">1</span> <span class="keyword">and</span> channel_code = <span class="string">'50008'</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ¡å¾ˆç®€å•çš„SQLï¼Œå…¶ä¸­å°±æœ‰<code>1=1</code>çš„å†™æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼˜åŒ–åå®é™…æ‰§è¡Œçš„SQL:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pay_channel_with_bank <span class="keyword">where</span> <span class="number">1</span>=<span class="number">1</span> <span class="keyword">and</span> channel_code = <span class="string">'50008'</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">WARNINGS</span>;</span><br><span class="line">å®é™…æ‰§è¡Œçš„SQL:</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> æ­¤å¤„çœç•¥å¾ˆå¤š<span class="keyword">column</span> <span class="keyword">from</span> <span class="string">`online_paychannel`</span>.<span class="string">`pay_channel_with_bank`</span> <span class="keyword">where</span> (<span class="string">`online_paychannel`</span>.<span class="string">`pay_channel_with_bank`</span>.<span class="string">`channel_code`</span> = <span class="number">50008</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>1=1</code>å·²ç»è¢«ä¼˜åŒ–æ‰äº†ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>è™½ç„¶è¿™ç§å†™æ³•æ²¡å•¥å¤§é—®é¢˜ï¼Œä½†æ˜¯ä»£ç æ˜¯ç»™äººçœ‹çš„ã€‚å¦‚æœä¸äº†è§£è¿™ç§å†™æ³•ï¼Œä¹ä¸€çœ¼çœ‹è¿‡å»è‚¯å®šæœ‰ç‚¹æ‡µã€‚</p><p>è€Œä¸”æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„Mybatisæä¾›çš„<code>&lt;where&gt;</code>æ ‡ç­¾æœ¬èº«å°±ä¼šå¸®æˆ‘ä»¬åšä¼˜åŒ–:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyPrefix</span><span class="params">(StringBuilder sql, String trimmedUppercaseSql)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!prefixApplied) &#123;</span><br><span class="line">        prefixApplied = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (prefixesToOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (String toRemove : prefixesToOverride) &#123;</span><br><span class="line">            <span class="comment">//æ­¤å¤„ä¼šç§»é™¤ä¸€äº›å‰ç¼€  </span></span><br><span class="line">            <span class="keyword">if</span> (trimmedUppercaseSql.startsWith(toRemove)) &#123;</span><br><span class="line">              sql.delete(<span class="number">0</span>, toRemove.trim().length());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (prefix != <span class="keyword">null</span>) &#123;</span><br><span class="line">          sql.insert(<span class="number">0</span>, <span class="string">" "</span>);</span><br><span class="line">          sql.insert(<span class="number">0</span>, prefix);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>WhereSqlNode</code>ä¸­å®šä¹‰çš„<code>prefixesToOverride</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; prefixList = Arrays.asList(<span class="string">"AND "</span>,<span class="string">"OR "</span>,<span class="string">"AND\n"</span>, <span class="string">"OR\n"</span>, <span class="string">"AND\r"</span>, <span class="string">"OR\r"</span>, <span class="string">"AND\t"</span>, <span class="string">"OR\t"</span>);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä½¿ç”¨äº†<code>&lt;where&gt;</code>æ ‡ç­¾åå¯ä»¥æ”¾å¿ƒå¤§èƒ†çš„å»æ‰<code>1=1</code>ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å»ºè®®&quot;&gt;&lt;a href=&quot;#å»ºè®®&quot; class=&quot;headerlink&quot; title=&quot;å»ºè®®&quot;&gt;&lt;/a&gt;å»ºè®®&lt;/h2&gt;&lt;p&gt;åˆ©ç”¨mybatisæ ‡ç­¾æ›¿æ¢ç¡¬ç¼–ç &lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;åœ¨é¡¹ç›®ä¸­å¶å°”çœ‹åˆ°è¿™æ ·çš„ä»£ç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;sql&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;querySqlString&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;where&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       1=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;test&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;fundsOrderIdList != null and fundsOrderIdList.size()&amp;gt;0&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           and funds_order_id IN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;collection&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;fundsOrderIdList&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;item&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;id&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;index&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;index&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;open&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;(&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;close&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;)&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;separator&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;,&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               #&amp;#123;id&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;foreach&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;if&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è¿™æ®µä»£ç ä¸­æœ‰ä¸ª&lt;code&gt;1=1&lt;/code&gt;å¾ˆæ‰çœ¼ï¼Œè¿™ä¸ªä¸æ˜¯bugï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Œåªæ˜¯ç¨‹åºå‘˜ä¸–ä»£ä¼ æ‰¿ä¸‹æ¥çš„ä¸€ä¸ªä¹ æƒ¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>å‘½ä»¤æ”¶è—</title>
    <link href="https://jingzhouzhao.github.io/archives/afa41a9c.html"/>
    <id>https://jingzhouzhao.github.io/archives/afa41a9c.html</id>
    <published>2020-07-22T02:45:53.000Z</published>
    <updated>2020-07-23T11:19:16.164Z</updated>
    
    <content type="html"><![CDATA[<h2 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h2><h4 id="å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™"><a href="#å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™" class="headerlink" title="å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)"></a>å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)</h4><ul><li><p>é‡å¯ <code>command+R</code> è¿›å…¥æ¢å¤ç•Œé¢</p></li><li><p>å®ç”¨å·¥å…· - ç»ˆç«¯ è¾“å…¥ï¼š<code>csrutil disable</code></p></li><li><p>é‡å¯ï¼š<code>reboot</code></p></li><li><p>æ‰“å¼€ç»ˆç«¯ï¼ŒæŒ‚è½½æ ¹ç›®å½•ï¼š<code>sudo mount -uw /</code></p><a id="more"></a><h2 id="brew"><a href="#brew" class="headerlink" title="brew"></a>brew</h2></li></ul><h4 id="æ›´æ–°app"><a href="#æ›´æ–°app" class="headerlink" title="æ›´æ–°app"></a>æ›´æ–°app</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cu -a -f</span><br></pre></td></tr></table></figure><h2 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h2><h4 id="ä¿å­˜å †å¿«ç…§"><a href="#ä¿å­˜å †å¿«ç…§" class="headerlink" title="ä¿å­˜å †å¿«ç…§"></a>ä¿å­˜å †å¿«ç…§</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=heapdump.hprof pid</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;mac&quot;&gt;&lt;a href=&quot;#mac&quot; class=&quot;headerlink&quot; title=&quot;mac&quot;&gt;&lt;/a&gt;mac&lt;/h2&gt;&lt;h4 id=&quot;å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™&quot;&gt;&lt;a href=&quot;#å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™&quot; class=&quot;headerlink&quot; title=&quot;å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)&quot;&gt;&lt;/a&gt;å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;é‡å¯ &lt;code&gt;command+R&lt;/code&gt; è¿›å…¥æ¢å¤ç•Œé¢&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;å®ç”¨å·¥å…· - ç»ˆç«¯ è¾“å…¥ï¼š&lt;code&gt;csrutil disable&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;é‡å¯ï¼š&lt;code&gt;reboot&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;æ‰“å¼€ç»ˆç«¯ï¼ŒæŒ‚è½½æ ¹ç›®å½•ï¼š&lt;code&gt;sudo mount -uw /&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>å¸¸è§é›†ç¾¤æ–¹å¼</title>
    <link href="https://jingzhouzhao.github.io/archives/6a6e8ff1.html"/>
    <id>https://jingzhouzhao.github.io/archives/6a6e8ff1.html</id>
    <published>2020-06-16T05:45:53.000Z</published>
    <updated>2020-06-16T05:47:23.201Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸»ä»ï¼ˆmaster-slaveï¼‰"><a href="#ä¸»ä»ï¼ˆmaster-slaveï¼‰" class="headerlink" title="ä¸»ä»ï¼ˆmaster-slaveï¼‰"></a>ä¸»ä»ï¼ˆmaster-slaveï¼‰</h3><p>å†™masterï¼ŒåŒæ­¥åˆ°slave ã€‚slaveå¯ç”¨äºè¯»ã€‚å¸¸è§mysqlï¼Œredisã€‚</p><h3 id="å“¨å…µ"><a href="#å“¨å…µ" class="headerlink" title="å“¨å…µ"></a>å“¨å…µ</h3><p>åœ¨ä¸»ä»çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†masterå®•æœºæ—¶ï¼Œslaveè‡ªåŠ¨åˆ‡æ¢ä¸ºmasterã€‚</p><h3 id="cluster"><a href="#cluster" class="headerlink" title="cluster"></a>cluster</h3><p>é›†ç¾¤å†…æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯åˆ†ç‰‡ã€‚é€šè¿‡åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®æ²Ÿé€šã€‚</p><p>ä¾‹å¦‚redisï¼Œé€šè¿‡Gossip åè®®ï¼Œåœ¨é›†ç¾¤å†…åŒæ­¥ï¼Œå„ä¸ªåˆ†ç‰‡çš„å“ˆå¸Œæ§½ä¿¡æ¯ã€‚</p><p>ä¾¿äºé‡å®šå‘è¯·æ±‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸»ä»ï¼ˆmaster-slaveï¼‰&quot;&gt;&lt;a href=&quot;#ä¸»ä»ï¼ˆmaster-slaveï¼‰&quot; class=&quot;headerlink&quot; title=&quot;ä¸»ä»ï¼ˆmaster-slaveï¼‰&quot;&gt;&lt;/a&gt;ä¸»ä»ï¼ˆmaster-slaveï¼‰&lt;/h3&gt;&lt;p&gt;å†™masterï¼ŒåŒæ­¥åˆ°sla
      
    
    </summary>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ RMQ_SYS_TRANS_HALF_TOPIC çˆ†æ‰çš„é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/cfa05355.html"/>
    <id>https://jingzhouzhao.github.io/archives/cfa05355.html</id>
    <published>2020-06-05T05:22:44.000Z</published>
    <updated>2021-04-01T02:05:00.878Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>SaaSé¡¹ç›®ä¸œéƒ­ååº”ï¼Œé¡¹ç›®ä¸­å‘çš„äº‹åŠ¡æ¶ˆæ¯ä¸€ç›´åœ¨<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ä¸­ï¼Œå¹¶ä¸”ä¸æ–­å¢é•¿ã€‚éšå³æˆ‘ä»¬æŸ¥çœ‹RocketMQæ—¥å¿—å‘ç°å¦‚ä¸‹æƒ…å†µï¼š<img src="https://files.catbox.moe/gdp5ap.png" alt></p><p>è¿™ä¸ªæœ¬æ¥æ˜¯RocketMQæ­£å¸¸çš„é€»è¾‘ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯åæ²¡æœ‰æäº¤çŠ¶æ€çš„è¯ï¼Œå½“è¾¾åˆ°è¶…æ—¶æ—¶é—´åï¼ŒRocketMQä¼šå›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ã€‚è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯å›æŸ¥çš„æ¬¡æ•°è¶…é™ï¼Œæ¶ˆæ¯è¢«ç§»åˆ°äº†<code>TRANS_CHECK_MAXTIME_TOPIC</code>ä¸­ã€‚</p><p>ä¸æ­£å¸¸çš„æ˜¯<code>REAL_TOPIC</code>å˜æˆäº†<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ï¼Œæ­£å¸¸åº”è¯¥æ˜¯åŸå§‹çš„ä¸šåŠ¡æ¶ˆæ¯TOPICæ‰å¯¹ã€‚äºæ˜¯æˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜å¼€å§‹æ’æŸ¥èµ·æ¥ã€‚</p><a id="more"></a><h2 id="è¿½è¸ª"><a href="#è¿½è¸ª" class="headerlink" title="è¿½è¸ª"></a>è¿½è¸ª</h2><h4 id="ä¸€ã€æ’æŸ¥"><a href="#ä¸€ã€æ’æŸ¥" class="headerlink" title="ä¸€ã€æ’æŸ¥"></a>ä¸€ã€æ’æŸ¥</h4><p>ä¸€å¼€å§‹æˆ‘ä»¬ä»¥ä¸ºæ˜¯Producerçš„é—®é¢˜ï¼Œå› ä¸ºå¾—åˆ°çš„åé¦ˆæ˜¯è¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰è¢«â€œæ¶ˆè´¹â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å§‹æ’æŸ¥Produceræ‰€åœ¨çš„é¡¹ç›®ã€‚å‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚åæ¥æˆ‘ä»¬è§‚å¯Ÿåˆ°ä¸Šè¿°æ—¥å¿—ä¸­æœ‰ä¸€ä¸ªDELAY=3ï¼Œç»“åˆåœ¨ç½‘ä¸ŠæŸ¥è¯¢çš„<a href="http://mail-archives.apache.org/mod_mbox/rocketmq-dev/201910.mbox/%3C157129868332.7323.16435164322004213562.gitbox@gitbox.apache.org%3E" target="_blank" rel="noopener">èµ„æ–™</a>ï¼Œè®¤ä¸ºå¯èƒ½æ˜¯è§¦å‘äº†RocketMQçš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯äº‹åŠ¡æ¶ˆæ¯è¿›è¡Œäº†å»¶è¿Ÿå‘é€ã€‚æˆ‘ä»¬ä»¥ä¸ºå¿«æ¥è¿‘çœŸç›¸äº†ï¼Œæˆ‘ä»¬å¼€å§‹æŸ¥æ‰¾Produceræ˜¯å¦åœ¨å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶è®¾ç½®äº†DELAYå‚æ•°ã€‚å¾ˆå¿«æˆ‘ä»¬å°±å¤±æœ›äº†ï¼ŒProduceræ²¡æœ‰ä»»ä½•åœ°æ–¹è®¾ç½®äº†DELAYå‚æ•°ã€‚</p><h4 id="äºŒã€ç¿»é˜…æºç "><a href="#äºŒã€ç¿»é˜…æºç " class="headerlink" title="äºŒã€ç¿»é˜…æºç "></a>äºŒã€ç¿»é˜…æºç </h4><p>æˆ‘ä»¬å›å¤´å»çœ‹ä¸Šé¢é‚£ä¸ªæ—¥å¿—ï¼Œå‘ç°<code>RECONSUME_TIME=1</code>å¹¶ä¸”<code>RETRY_TOPIC</code>ä¹Ÿä¸ä¸ºç©ºï¼Œè¿™è¯´æ˜è¿™ä¸ªæ¶ˆæ¯è‚¯å®šæ˜¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°äº†ï¼Œä½†æ˜¯ç”±äºæŸç§åŸå› æ¶ˆè´¹å¤±è´¥äº†ï¼Œè§¦å‘äº†é‡è¯•ã€‚äºæ˜¯æˆ‘ä»¬å¼€å§‹çœ‹RocketMQé‡è¯•ç›¸å…³æºç ã€‚æˆ‘ä»¬é¦–å…ˆæ‰¾åˆ°äº†DELAY=3è¿™ä¸ªå‚æ•°çš„æ¥æºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨æˆ‘ä»¬çš„æ¶ˆè´¹è€…ä¸­è®¾ç½®äº†ConsumeConcurrentlyContext å»¶æ—¶çº§åˆ«</span></span><br><span class="line">context.setDelayLevelWhenNextConsume(getDelayLevelWhenNextConsume(reconsumeTimes));</span><br><span class="line"><span class="comment">//å¯ä»¥çœ‹åˆ°è¿™ä¸ªdelayLevelæœ€ç»ˆæ˜¯ä¼šè¢«å‘é€åˆ°broker</span></span><br><span class="line"><span class="comment">//org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService#sendMessageBack</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageBack</span><span class="params">(<span class="keyword">final</span> MessageExt msg, <span class="keyword">final</span> ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> delayLevel = context.getDelayLevelWhenNextConsume();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap topic with namespace before sending back message.</span></span><br><span class="line">  msg.setTopic(<span class="keyword">this</span>.defaultMQPushConsumer.withNamespace(msg.getTopic()));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.defaultMQPushConsumerImpl.sendMessageBack(msg, delayLevel, context.getMessageQueue().getBrokerName());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">"sendMessageBack exception, group: "</span> + <span class="keyword">this</span>.consumerGroup + <span class="string">" msg: "</span> + msg.toString(), e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰¾åˆ°å¯¹åº”brokerç‰ˆæœ¬(4.6.0)çš„æºç ä¸€æ­¥æ­¥æ‰¾åˆ°äº†è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.store.CommitLog#putMessage</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line"><span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE</span><br><span class="line">    || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</span><br><span class="line">  <span class="comment">// Delay Delivery</span></span><br><span class="line">  <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">      msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    topic = ScheduleMessageService.SCHEDULE_TOPIC;</span><br><span class="line">    queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Backup real topic, queueId</span></span><br><span class="line">    MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">    MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">    msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line"></span><br><span class="line">    msg.setTopic(topic);</span><br><span class="line">    msg.setQueueId(queueId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ç…§ä¹‹å‰æ—¥å¿—é‡Œçš„å‚æ•°ï¼Œ<code>sysFlag=8,delay=3</code>ï¼Œæˆ‘ä»¬è®¤ä¸ºå¾ˆå¯èƒ½èµ°äº†è¿™æ®µé€»è¾‘ï¼Œç„¶åè§¦å‘äº†äº‹åŠ¡æ¶ˆæ¯è¿›è¡Œäº†å»¶è¿Ÿå‘é€çš„é—®é¢˜ã€‚ç»§ç»­çœ‹äº†å»¶æ—¶æ¶ˆæ¯å‘é€çš„é€»è¾‘ï¼Œæ²¡æœ‰æ‰¾åˆ°é—®é¢˜ï¼Œè€Œä¸”è¿™ä¹Ÿè§£é‡Šä¸äº†ä¸ºä»€ä¹ˆ<code>REAL_TOPIC</code>å˜æˆäº†``RMQ_SYS_TRANS_HALF_TOPIC`</p><h4 id="ä¸‰ã€çœŸç›¸"><a href="#ä¸‰ã€çœŸç›¸" class="headerlink" title="ä¸‰ã€çœŸç›¸"></a>ä¸‰ã€çœŸç›¸</h4><p>ä¸Šé¢è¿˜æåˆ°äº†ä¸€ä¸ª<code>RETRY_TOPIC</code>ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰çš„æ’æŸ¥è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç°æœ‰ä»€ä¹ˆåœ°æ–¹è®¾ç½®ï¼Œäºæ˜¯æˆ‘ä»¬æœç´¢äº†ä¸€æŠŠï¼Œå‘ç°åœ¨è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl#sendMessageBack</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageBack</span><span class="params">(MessageExt msg, <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> String brokerName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String brokerAddr = (<span class="keyword">null</span> != brokerName) ? <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</span><br><span class="line">            : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</span><br><span class="line">        <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</span><br><span class="line">            <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class="number">5000</span>, getMaxReconsumeTimes());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"sendMessageBack Exception, "</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</span><br><span class="line"></span><br><span class="line">        Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</span><br><span class="line"></span><br><span class="line">        String originMsgId = MessageAccessor.getOriginMessageId(msg);</span><br><span class="line">        MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</span><br><span class="line"></span><br><span class="line">        newMsg.setFlag(msg.getFlag());</span><br><span class="line">        MessageAccessor.setProperties(newMsg, msg.getProperties());</span><br><span class="line">       <span class="comment">//è¿™é‡Œè®¾ç½®äº†RETRY_TOPIC</span></span><br><span class="line">        MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</span><br><span class="line">        MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class="number">1</span>));</span><br><span class="line">        MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</span><br><span class="line">       </span><br><span class="line">        newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), <span class="keyword">this</span>.defaultMQPushConsumer.getNamespace()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾æ˜¯ä¸ªå¼‚å¸¸æµç¨‹ï¼Œé‚£ä¹ˆåˆ°åº•æ˜¯ä»€ä¹ˆå¯¼è‡´äº†è¿™ä¸ªå¼‚å¸¸æµç¨‹å‘¢ï¼Ÿæ—¢ç„¶çŸ¥é“æ˜¯åœ¨æ¶ˆè´¹çš„æ—¶å€™å‡ºäº†å¼‚å¸¸ï¼Œäºæ˜¯æˆ‘ä»¬æ‰¾åˆ°å¯¹åº”çš„æ¶ˆè´¹è€…æ—¥å¿—ï¼Œå‘ç°å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="https://files.catbox.moe/42fapz.png" alt></p><p>è¿™é‡ŒBrokerè¿”å›çš„é”™è¯¯æ˜¯<code>MESSAGE_ILIEGAL</code>ï¼Œåœ¨å›è¿‡å¤´å»çœ‹é‡è¯•ç›¸å…³ä»£ç ï¼Œæœ‰äº†ä¹‹å‰çš„ç»éªŒè¿™æ¬¡å¾ˆå¿«å°±å®šä½åˆ°äº†å¯èƒ½æŠ¥è¿™ä¸ªé”™è¯¯çš„åœ°æ–¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¬¬ä¸€å¤„ï¼šorg.apache.rocketmq.store.DefaultMessageStore#putMessage </span></span><br><span class="line"><span class="keyword">if</span> (msg.getTopic().length() &gt; Byte.MAX_VALUE) &#123;</span><br><span class="line"> log.warn(<span class="string">"putMessage message topic length too long "</span> + msg.getTopic().length());</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, <span class="keyword">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//ç¬¬äºŒå¤„ï¼šorg.apache.rocketmq.store.CommitLog.DefaultAppendMessageCallback#doAppend(long, java.nio.ByteBuffer, int, org.apache.rocketmq.store.MessageExtBrokerInner)</span></span><br><span class="line"><span class="keyword">if</span> (propertiesLength &gt; Short.MAX_VALUE) &#123;</span><br><span class="line">  log.warn(<span class="string">"putMessage message properties length too long. length=&#123;&#125;"</span>, propertiesData.length);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</span><br><span class="line">                    beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</span><br></pre></td></tr></table></figure><p>æœæ–­æ‰¾è¿ç»´è¦äº†<code>store.log</code>ï¼Œå‘ç°å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARN SendMessageThread_1 - putMessage message topic length too long 149</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åº”è¯¥å°±æ˜¯ç¬¬ä¸€å¤„çš„é—®é¢˜äº†ã€‚è‡³æ­¤é—®é¢˜çš„åŸå› åŸºæœ¬æ‰¾åˆ°äº†ï¼Œä½†è¿˜æœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li><p>ä¸ºä»€ä¹ˆTOPICä¼šè¶…é•¿ï¼Ÿ</p><p>é‡è¯•çš„æ¶ˆæ¯TOPICè§„åˆ™ä¸º%RETRY%+consumerGroupï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup())</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬çš„consumerGroupçš„è§„åˆ™ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> group + <span class="string">"_"</span> + getTopic() + <span class="string">"_"</span> + getTags();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰é—®é¢˜çš„consumerçš„tagsä¸ºï¼š<code>SAAS_PURCHASE_PURCHASE_ORDER_UPDATE||SAAS_PURCHASE_PURCHASE_ORDER_OPEN_RECEVIED||SAAS_PURCHASE_PURCHASE_ORDER_COMPLETED_RECEVIED</code></p><p>æ‰€ä»¥æœ€ç»ˆæ‹¼å‡ºæ¥çš„TOPICè¶…å‡ºäº†é•¿åº¦ã€‚</p></li><li><p>ä¸ºä»€ä¹ˆèµ°äº†Catché‡Œé¢çš„æµç¨‹å°±ä¼šå¯¼è‡´HALFé˜Ÿåˆ—çˆ†æ‰ï¼Ÿ</p><p>è¿™æ˜¯ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„RocketMQ-clientç‰ˆæœ¬ä¸º<code>4.5.0</code>ï¼Œè¿™ä¸ªç‰ˆæœ¬Catché‡Œçš„ä»£ç æœ‰ä¸ªbugï¼Œæ²¡æœ‰æ¸…é™¤æ‰åŸå§‹æ¶ˆæ¯çš„äº‹åŠ¡æ¶ˆæ¯æ ‡å¿—<code>TRANS_MSG=true</code>ã€‚æ‰€ä»¥è¿™ä¸ªæ¶ˆæ¯å‘å‡ºå»ååœ¨brokerç«¯åˆä¼šèµ°äº‹åŠ¡æ¶ˆæ¯çš„æµç¨‹ï¼Œå¹¶ä¸”è¿˜æ˜¯å¸¦å»¶æ—¶çš„ã€‚è¿™ä¼šå¯¼è‡´çœŸå®çš„TOPICä¸¢æ‰ã€‚</p><p>ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ä¸€ä¸‹ï¼š</p><p><img src="https://files.catbox.moe/ssraef.png" alt></p><p>äº‹åŠ¡æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œtopicè½¬ä¸º<code>%RETRY%xxxx</code>å‘é€åˆ°brokerï¼Œç”±äºäº‹åŠ¡æ¶ˆæ¯æ ‡å¿—æ²¡æœ‰è¢«æ¸…é™¤ï¼Œäºæ˜¯topicè½¬æˆäº†<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ã€‚åˆç”±äºdelayå‚æ•°æ²¡æœ‰è¢«æ¸…é™¤ï¼Œtopicæœ€åè¢«è½¬ä¸ºäº†<code>schedule_topic_xxxx</code>ã€‚ç­‰åˆ°scheduleæ‰§è¡Œæ—¶ï¼Œæ¶ˆæ¯ä¼šå‘åˆ°<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ä¸­ã€‚ç”±äºä¸æ˜¯Producerå‘çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰€ä»¥æ‹¿ä¸åˆ°LocalTransactionStateã€‚åªèƒ½ç­‰å¾…äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‚</p><p>è¿™æ—¶åˆšå¥½åˆç¢°åˆ°æˆ‘ä»¬çš„LocalTransactionListenerçš„ä¸€ä¸ªé—®é¢˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">  Object msg = HessianUtils.decode(messageExt.getBody());</span><br><span class="line">  String topic = messageExt.getTopic();</span><br><span class="line">  String tag = messageExt.getTags();</span><br><span class="line">  <span class="comment">//ç”±äºæ‹¿ç€rmq_sys_trans_half_topicæ¥è·å–handleræ‰€ä»¥è‚¯å®šè·å–ä¸åˆ°ã€‚</span></span><br><span class="line">  LocalTransactionHandler localTransacationHandler = getLocalTransacationHandler(topic, tag);</span><br><span class="line"></span><br><span class="line">  String msgId = messageExt.getMsgId();</span><br><span class="line">  <span class="keyword">if</span>( localTransacationHandler == <span class="keyword">null</span> )&#123;</span><br><span class="line">    logger.error(<span class="string">"localTransacationHandler is empty should never happened! msgId=&#123;&#125;, arg=&#123;&#125;"</span>, msgId, JSON.toJSONString(msg));</span><br><span class="line">    <span class="comment">//äºæ˜¯è¿™ä¸ªåœ°æ–¹ä¼šè¿”å›COMMIT_MESSAGE</span></span><br><span class="line">    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">boolean</span> checkResult = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    checkResult = localTransacationHandler.localTransactionCheck(msgId, msg);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    logger.error(<span class="string">"localTransacationCheck failed! msgId=&#123;&#125;, arg=&#123;&#125;"</span>, msgId, JSON.toJSONString(msg), e);</span><br><span class="line">    checkResult = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> checkResult ? LocalTransactionState.COMMIT_MESSAGE : LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Brokeræ”¶åˆ°<code>COMMIT_MESSAGE</code>åä¼šå°†æ¶ˆæ¯å†™å¾€REAL_TOPICä¸­ã€‚è€Œæ­¤æ—¶REAL_TOPICæ—©å·²å˜æˆäº†<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ã€‚å°±è¿™æ ·ï¼Œ<code>RMQ_SYS_TRANS_HALF_TOPIC</code>çˆ†æ‰äº†ã€‚</p></li></ol><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><ol><li><p>é¦–å…ˆæˆ‘ä»¬å°†handlerä¸ºç©ºæ—¶è¿”å›<code>COMMIT_MESSAGE</code>ï¼Œæ”¹ä¸ºäº†<code>ROLLBACK_MESSAGE</code>ã€‚</p></li><li><p>å‡çº§stoneä¸­RocketMQä¸º4.6.1ï¼Œå¯ä»¥çœ‹åˆ°åœ¨Catchä»£ç ä¸­å¤šäº†ä¸€è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageAccessor.clearProperty(newMsg, &quot;TRAN_MSG&quot;);</span><br></pre></td></tr></table></figure></li><li><p>æœ‰é—®é¢˜çš„consumerå°†tagæ‹†åˆ†</p><p>ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥åªèƒ½è§£å†³<code>RMQ_SYS_TRANS_HALF_TOPIC</code>çˆ†æ‰çš„é—®é¢˜ã€‚ä½†æ˜¯topicè¶…é•¿è¿˜æ˜¯ä¼šæœ‰é—®é¢˜ã€‚æ‰€ä»¥ç›®å‰æš‚æ—¶æ˜¯å°†consumerçš„tagæ‹†å¼€ã€‚</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç°è±¡&quot;&gt;&lt;a href=&quot;#ç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;ç°è±¡&quot;&gt;&lt;/a&gt;ç°è±¡&lt;/h2&gt;&lt;p&gt;SaaSé¡¹ç›®ä¸œéƒ­ååº”ï¼Œé¡¹ç›®ä¸­å‘çš„äº‹åŠ¡æ¶ˆæ¯ä¸€ç›´åœ¨&lt;code&gt;RMQ_SYS_TRANS_HALF_TOPIC&lt;/code&gt;ä¸­ï¼Œå¹¶ä¸”ä¸æ–­å¢é•¿ã€‚éšå³æˆ‘ä»¬æŸ¥çœ‹RocketMQæ—¥å¿—å‘ç°å¦‚ä¸‹æƒ…å†µï¼š&lt;img src=&quot;https://files.catbox.moe/gdp5ap.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæœ¬æ¥æ˜¯RocketMQæ­£å¸¸çš„é€»è¾‘ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯åæ²¡æœ‰æäº¤çŠ¶æ€çš„è¯ï¼Œå½“è¾¾åˆ°è¶…æ—¶æ—¶é—´åï¼ŒRocketMQä¼šå›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ã€‚è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯å›æŸ¥çš„æ¬¡æ•°è¶…é™ï¼Œæ¶ˆæ¯è¢«ç§»åˆ°äº†&lt;code&gt;TRANS_CHECK_MAXTIME_TOPIC&lt;/code&gt;ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¸æ­£å¸¸çš„æ˜¯&lt;code&gt;REAL_TOPIC&lt;/code&gt;å˜æˆäº†&lt;code&gt;RMQ_SYS_TRANS_HALF_TOPIC&lt;/code&gt;ï¼Œæ­£å¸¸åº”è¯¥æ˜¯åŸå§‹çš„ä¸šåŠ¡æ¶ˆæ¯TOPICæ‰å¯¹ã€‚äºæ˜¯æˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜å¼€å§‹æ’æŸ¥èµ·æ¥ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
      <category term="RocketMQ" scheme="https://jingzhouzhao.github.io/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>è¯»å–Jarä¸­æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</title>
    <link href="https://jingzhouzhao.github.io/archives/f728629b.html"/>
    <id>https://jingzhouzhao.github.io/archives/f728629b.html</id>
    <published>2020-03-19T03:47:54.000Z</published>
    <updated>2020-03-19T05:46:01.558Z</updated>
    
    <content type="html"><![CDATA[<p>è¯»å–Jarä¸­æ–‡ä»¶ä½¿ç”¨ç±»ä¼¼getResourceAsStreamç­‰ä»¥æµçš„æ–¹å¼è·å–å³å¯ã€‚ä½†æ˜¯æƒ³è¦è¯»å–Jarä¸­æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å´ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚</p><a id="more"></a><h2 id="ç¬¬ä¸€ç§æ–¹å¼"><a href="#ç¬¬ä¸€ç§æ–¹å¼" class="headerlink" title="ç¬¬ä¸€ç§æ–¹å¼"></a>ç¬¬ä¸€ç§æ–¹å¼</h2><p>é¦–å…ˆè¦è¯»å–Jarä¸­çš„ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¾—å…ˆææ¸…æ¥šJarä¸­çš„ç›®å½•ç»“æ„ï¼Œä¾‹å¦‚å¸¸è§çš„SpringBootæ‰“åŒ…åçš„Jarä¸­ç›®å½•å¦‚ä¸‹ï¼š</p><p><img src="/archives/f728629b/1.png" alt="1"></p><p>å‡å¦‚æˆ‘ä»¬è¦è¯»å–çš„ç›®å½•æ˜¯<code>BOOT-INF/classes/processes</code>ï¼ˆå¯¹åº”æºæ–‡ä»¶ç›®å½•æ˜¯<code>resources/processes</code>ï¼‰</p><p><img src="/archives/f728629b/2.png" alt="2"></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å½“å‰Jaræ–‡ä»¶è·¯å¾„</span></span><br><span class="line">URL url = <span class="keyword">this</span>.getClass().getClassLoader().getResource(<span class="string">""</span>);</span><br><span class="line">    String jarPath = url.toString().substring(<span class="number">0</span>, url.toString().indexOf(<span class="string">"!/"</span>) + <span class="number">2</span>);</span><br><span class="line">    log.info(<span class="string">"jarPath:&#123;&#125;"</span>, jarPath);</span><br><span class="line">    URL jarURL = <span class="keyword">new</span> URL(jarPath);</span><br><span class="line">    JarURLConnection jarCon = (JarURLConnection) jarURL.openConnection();</span><br><span class="line">    JarFile jarFile = jarCon.getJarFile();</span><br><span class="line"><span class="comment">//è·å–Jarä¸‹æ‰€æœ‰æ–‡ä»¶</span></span><br><span class="line">    Enumeration&lt;JarEntry&gt; entries = jarFile.entries();</span><br><span class="line"><span class="comment">//éå†æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">        JarEntry jarEntry = entries.nextElement();</span><br><span class="line">      <span class="comment">//è·å–æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        String innerPath = jarEntry.getName();</span><br><span class="line">        log.info(<span class="string">"jarEntry Name:&#123;&#125;"</span>, innerPath);</span><br><span class="line">      <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†çš„ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ŒPROCESSES=BOOT-INF/classes/processes</span></span><br><span class="line">        <span class="keyword">if</span> (innerPath.startsWith(PROCESSES) &amp;&amp; !jarEntry.isDirectory()) &#123;</span><br><span class="line">          <span class="comment">//è·å–åˆ°æ–‡ä»¶æµ</span></span><br><span class="line">            InputStream inputStream = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(innerPath);</span><br><span class="line">          <span class="comment">//doSomething</span></span><br><span class="line">          <span class="comment">//......</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹å¼ä¼˜ç¼ºç‚¹ï¼šæ— ç¬¬ä¸‰æ–¹åº“ä¾èµ–ï¼Œç”¨çš„éƒ½æ˜¯JDK ç›¸å…³APIã€‚ä½†æ˜¯åªèƒ½åœ¨jaræ¨¡å¼ä¸‹è¿è¡Œï¼Œæœ¬åœ°è°ƒè¯•ä¼šå‡ºé”™ã€‚</p><h2 id="ç¬¬äºŒç§æ–¹å¼"><a href="#ç¬¬äºŒç§æ–¹å¼" class="headerlink" title="ç¬¬äºŒç§æ–¹å¼"></a>ç¬¬äºŒç§æ–¹å¼</h2><p>å¦‚æœæœ‰ä½¿ç”¨åˆ°Springï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯æ‰“æˆJarè¿è¡Œè¿˜æ˜¯æœ¬åœ°è¿è¡Œï¼Œè·å–æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å°±å¾ˆç®€å•äº†ã€‚ä¸»è¦æ˜¯åˆ©ç”¨äº†Spring çš„<code>ResourcePatternResolver</code>ï¼Œè¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    List&lt;Resource&gt; resourceList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//PROCESS_DEFINITION_LOCATION_SUFFIXES = Arrays.asLIst("**.bpmn20.xml","**.bpmn")</span></span><br><span class="line">    <span class="keyword">for</span> (String suffix : PROCESS_DEFINITION_LOCATION_SUFFIXES) &#123;</span><br><span class="line">      <span class="comment">//PROCESS_DEFINITION_LOCATION_SUFFIXES = classpath://processes/</span></span><br><span class="line">        <span class="comment">//æ‹¼æ¥è·¯å¾„pattern</span></span><br><span class="line">        String path = PROCESS_DEFINITION_LOCATION_PREFIX + suffix;</span><br><span class="line">      <span class="comment">//é€šè¿‡ResourcePatternResolverè·å–èµ„æºæ–‡ä»¶,</span></span><br><span class="line">        <span class="comment">//resourceLoader = @Autowired ResourcePatternResolver resourceLoader</span></span><br><span class="line">        Resource[] resources = resourceLoader.getResources(path);</span><br><span class="line">        <span class="keyword">if</span> (resources != <span class="keyword">null</span> &amp;&amp; resources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            resourceList.addAll(Arrays.asList(resources));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//é€šè¿‡resource.getInputStream()å³å¯è·å–æ–‡ä»¶æµ</span></span><br><span class="line"><span class="comment">//doSomething</span></span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure><p>æ­¤æ–¹å¼ä¼˜ç¼ºç‚¹ï¼Œä¾èµ–äº†Springæ¡†æ¶ï¼Œä½†æ˜¯å¯¹è¿è¡Œç¯å¢ƒæ²¡æœ‰è¦æ±‚ã€‚</p><p>æ€»ç»“ï¼š</p><p>æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œæ¯•ç«Ÿç°åœ¨åŸºæœ¬ä¸Šéƒ½ä¼šä½¿ç”¨åˆ°Springã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¯»å–Jarä¸­æ–‡ä»¶ä½¿ç”¨ç±»ä¼¼getResourceAsStreamç­‰ä»¥æµçš„æ–¹å¼è·å–å³å¯ã€‚ä½†æ˜¯æƒ³è¦è¯»å–Jarä¸­æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å´ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>tk.mybatisä¸Activitiå…±å­˜é—®é¢˜è§£å†³</title>
    <link href="https://jingzhouzhao.github.io/archives/7008e148.html"/>
    <id>https://jingzhouzhao.github.io/archives/7008e148.html</id>
    <published>2020-03-05T12:53:07.000Z</published>
    <updated>2020-03-05T13:03:39.084Z</updated>
    
    <content type="html"><![CDATA[<p>ç”±äºtk.mybatisä¾èµ–äº†persistence-apiï¼Œä¼šè®©Activitiè£…é…JpaProcessEngineAutoConfigurationï¼Œå› ä¸ºå…¶@conditonalOnclass(name = â€œjavax.persistence.EntityManagerFactoryâ€)ã€‚</p><p>ä½†å®é™…æ²¡æœ‰ä½¿ç”¨JPAï¼Œå¯¼è‡´å¯åŠ¨æŠ¥é”™ã€‚å¦‚æœæ’é™¤persistence-apiï¼Œåˆä¼šå¯¼è‡´tk.mybatisæŠ¥é”™ã€‚</p><p>å‚è€ƒäº†ä¸€ç•ªå…¶å®ƒçš„äººåšæ³•ï¼Œæ— è®ºæ˜¯å„ç§æ’é™¤è¿˜æ˜¯æ·»åŠ ä¾èµ–éƒ½æ— æ•ˆã€‚</p><p>æœ€ç»ˆè‡ªå·±çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š</p><p>é¦–å…ˆæ’é™¤activiti jpaçš„è‡ªåŠ¨è£…é…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication(exclude&#x3D;&#123;JpaProcessEngineAutoConfiguration.class&#125;)ã€‚</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰¾åˆ°activitiä¸­çš„<code>DataSourceProcessEngineAutoConfiguration.class</code> å¤åˆ¶å‡ºæºç ï¼Œåœ¨è‡ªå·±çš„é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªåŒåæ–‡ä»¶ï¼ˆä¸åŒåä¹Ÿè¡Œï¼‰ã€‚ç„¶åç²˜è´´å†…å®¹åˆ°æ–°å»ºçš„æ–‡ä»¶ä¸­ã€‚æœ€ååˆ æ‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ConditionalOnMissionClass(name &#x3D; &quot;javax.persistence.EntityManagerFactory&quot;)</span><br></pre></td></tr></table></figure><p>Ok,æå®šï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ç”±äºtk.mybatisä¾èµ–äº†persistence-apiï¼Œä¼šè®©Activitiè£…é…JpaProcessEngineAutoConfigurationï¼Œå› ä¸ºå…¶@conditonalOnclass(name = â€œjavax.persistence.EntityManage
      
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Activiti" scheme="https://jingzhouzhao.github.io/tags/Activiti/"/>
    
  </entry>
  
  <entry>
    <title>è¢«éš”ç¦»çš„ç¬¬7å¤©</title>
    <link href="https://jingzhouzhao.github.io/archives/3eda1a9.html"/>
    <id>https://jingzhouzhao.github.io/archives/3eda1a9.html</id>
    <published>2020-03-03T05:22:11.000Z</published>
    <updated>2020-03-03T05:28:00.747Z</updated>
    
    <content type="html"><![CDATA[<p>è¢«éš”ç¦»çš„ç¬¬7å¤©ï¼Œæ¯å¤©æ¥åˆ°æ— æ•°ä¸ªéƒ¨é—¨çš„ç”µè¯ï¼Œé‡ä½“æ¸©ï¼ŒæŠ¥æƒ…å†µã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¢«éš”ç¦»çš„ç¬¬7å¤©ï¼Œæ¯å¤©æ¥åˆ°æ— æ•°ä¸ªéƒ¨é—¨çš„ç”µè¯ï¼Œé‡ä½“æ¸©ï¼ŒæŠ¥æƒ…å†µã€‚&lt;/p&gt;

      
    
    </summary>
    
      <category term="ç”Ÿæ´»" scheme="https://jingzhouzhao.github.io/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>æ›´æ¢ç”µè„‘åhexo deployè®¿é—®å‡ºç°404çš„é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/32745de6.html"/>
    <id>https://jingzhouzhao.github.io/archives/32745de6.html</id>
    <published>2019-10-16T10:49:53.000Z</published>
    <updated>2019-10-16T11:14:24.615Z</updated>
    
    <content type="html"><![CDATA[<p>æ›´æ¢ç”µè„‘åé‡æ–°æ‹‰ä¸‹hexoç›¸å…³sourcesï¼Œå®‰è£…å®Œæˆhexo-cliä»¥åŠhexo-deployer-gitå’Œå…¶ä»–node_modulesã€‚</p><p>æ‰§è¡Œhexo clean &amp;&amp; hexo g </p><p>ç„¶åæ‰§è¡Œhexo dã€‚</p><a id="more"></a><p>å®Œæˆåå‘ç°è®¿é—®å‡ºç°404ï¼Œæç¤º<strong>There isnâ€™t a GitHub Pages site here.</strong></p><p>å¹¶ä¸”githubå‘äº†å¤§é‡è­¦å‘Šé‚®ä»¶ï¼Œæœ‰å¾—æ²¡å¾—ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You are attempting to use a Jekyll theme, &quot;icarus&quot;, which is not supported by GitHub Pages.</span><br></pre></td></tr></table></figure><p>å®šä½é—®é¢˜ï¼š</p><ol><li>æŸ¥çœ‹github pageså¯¹åº”repositoryï¼Œå‘ç°é‡Œé¢çš„æ–‡ä»¶å®Œå…¨ä¸æ­£ç¡®ï¼Œä¸æ˜¯hexo gç”Ÿæˆçš„æ–‡ä»¶ã€‚è€Œå˜æˆäº†åšå®¢å¯¹åº”çš„æºæ–‡ä»¶ã€‚</li><li>æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦æ­£ç¡®ç”Ÿæˆï¼Œpublicç›®å½•ä¸‹æ­£ç¡®ç”Ÿæˆã€‚</li><li>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤ï¼Œè¯´æ˜é—®é¢˜å‡ºåœ¨deployã€‚</li></ol><p>è§£å†³é—®é¢˜ï¼š</p><p>åˆ é™¤<code>.deploy_git</code>ï¼Œé‡æ–°<code>hexo d</code>ï¼Œä¸€åˆ‡æ¢å¤æ­£å¸¸ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ›´æ¢ç”µè„‘åé‡æ–°æ‹‰ä¸‹hexoç›¸å…³sourcesï¼Œå®‰è£…å®Œæˆhexo-cliä»¥åŠhexo-deployer-gitå’Œå…¶ä»–node_modulesã€‚&lt;/p&gt;
&lt;p&gt;æ‰§è¡Œhexo clean &amp;amp;&amp;amp; hexo g &lt;/p&gt;
&lt;p&gt;ç„¶åæ‰§è¡Œhexo dã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="è¸©å‘è®°å½•" scheme="https://jingzhouzhao.github.io/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
    
  </entry>
  
  <entry>
    <title>PriorityQueueè§£æ</title>
    <link href="https://jingzhouzhao.github.io/archives/f50feeee.html"/>
    <id>https://jingzhouzhao.github.io/archives/f50feeee.html</id>
    <published>2019-10-10T02:13:00.000Z</published>
    <updated>2019-10-16T09:05:40.007Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è½¬è½½è‡³githubï¼š<a href="https://github.com/CarpenterLee/JCFInternals/blob/master/markdown/8-PriorityQueue.md" target="_blank" rel="noopener">https://github.com/CarpenterLee/JCFInternals/blob/master/markdown/8-PriorityQueue.md</a></p></blockquote><h1 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h1><h1 id="æ€»ä½“ä»‹ç»"><a href="#æ€»ä½“ä»‹ç»" class="headerlink" title="æ€»ä½“ä»‹ç»"></a>æ€»ä½“ä»‹ç»</h1><p>å‰é¢ä»¥Java <em>ArrayDeque</em>ä¸ºä¾‹è®²è§£äº†<em>Stack</em>å’Œ<em>Queue</em>ï¼Œå…¶å®è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—å«åš<em>PriorityQueue</em>ï¼Œå³ä¼˜å…ˆé˜Ÿåˆ—ã€‚<strong>ä¼˜å…ˆé˜Ÿåˆ—çš„ä½œç”¨æ˜¯èƒ½ä¿è¯æ¯æ¬¡å–å‡ºçš„å…ƒç´ éƒ½æ˜¯é˜Ÿåˆ—ä¸­æƒå€¼æœ€å°çš„</strong>ï¼ˆJavaçš„ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡å–æœ€å°å…ƒç´ ï¼ŒC++çš„ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡å–æœ€å¤§å…ƒç´ ï¼‰ã€‚è¿™é‡Œç‰µæ¶‰åˆ°äº†å¤§å°å…³ç³»ï¼Œ<strong>å…ƒç´ å¤§å°çš„è¯„åˆ¤å¯ä»¥é€šè¿‡å…ƒç´ æœ¬èº«çš„è‡ªç„¶é¡ºåºï¼ˆ<em>natural ordering</em>ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ—¶ä¼ å…¥çš„æ¯”è¾ƒå™¨</strong>ï¼ˆ<em>Comparator</em>ï¼Œç±»ä¼¼äºC++çš„ä»¿å‡½æ•°ï¼‰ã€‚</p><a id="more"></a><p>Javaä¸­<em>PriorityQueue</em>å®ç°äº†<em>Queue</em>æ¥å£ï¼Œä¸å…è®¸æ”¾å…¥<code>null</code>å…ƒç´ ï¼›å…¶é€šè¿‡å †å®ç°ï¼Œå…·ä½“è¯´æ˜¯é€šè¿‡å®Œå…¨äºŒå‰æ ‘ï¼ˆ<em>complete binary tree</em>ï¼‰å®ç°çš„<strong>å°é¡¶å †</strong>ï¼ˆä»»æ„ä¸€ä¸ªéå¶å­èŠ‚ç‚¹çš„æƒå€¼ï¼Œéƒ½ä¸å¤§äºå…¶å·¦å³å­èŠ‚ç‚¹çš„æƒå€¼ï¼‰ï¼Œä¹Ÿå°±æ„å‘³ç€å¯ä»¥é€šè¿‡æ•°ç»„æ¥ä½œä¸º<em>PriorityQueue</em>çš„åº•å±‚å®ç°ã€‚</p><p><img src="https://github.com/CarpenterLee/JCFInternals/raw/master/PNGFigures/PriorityQueue_base.png" alt="PriorityQueue_base.png"></p><p>ä¸Šå›¾ä¸­æˆ‘ä»¬ç»™æ¯ä¸ªå…ƒç´ æŒ‰ç…§å±‚åºéå†çš„æ–¹å¼è¿›è¡Œäº†ç¼–å·ï¼Œå¦‚æœä½ è¶³å¤Ÿç»†å¿ƒï¼Œä¼šå‘ç°çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹çš„ç¼–å·æ˜¯æœ‰è”ç³»çš„ï¼Œæ›´ç¡®åˆ‡çš„è¯´çˆ¶å­èŠ‚ç‚¹çš„ç¼–å·ä¹‹é—´æœ‰å¦‚ä¸‹å…³ç³»ï¼š</p><p><code>leftNo = parentNo*2+1</code></p><p><code>rightNo = parentNo*2+2</code></p><p><code>parentNo = (nodeNo-1)/2</code></p><p>é€šè¿‡ä¸Šè¿°ä¸‰ä¸ªå…¬å¼ï¼Œå¯ä»¥è½»æ˜“è®¡ç®—å‡ºæŸä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä»¥åŠå­èŠ‚ç‚¹çš„ä¸‹æ ‡ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥ç”¨æ•°ç»„æ¥å­˜å‚¨å †çš„åŸå› ã€‚</p><p><em>PriorityQueue</em>çš„<code>peek()</code>å’Œ<code>element</code>æ“ä½œæ˜¯å¸¸æ•°æ—¶é—´ï¼Œ<code>add()</code>, <code>offer()</code>, æ— å‚æ•°çš„<code>remove()</code>ä»¥åŠ<code>poll()</code>æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯<em>log(N)</em>ã€‚</p><h1 id="æ–¹æ³•å‰–æ"><a href="#æ–¹æ³•å‰–æ" class="headerlink" title="æ–¹æ³•å‰–æ"></a>æ–¹æ³•å‰–æ</h1><h2 id="add-å’Œoffer"><a href="#add-å’Œoffer" class="headerlink" title="add()å’Œoffer()"></a>add()å’Œoffer()</h2><p><code>add(E e)</code>å’Œ<code>offer(E e)</code>çš„è¯­ä¹‰ç›¸åŒï¼Œéƒ½æ˜¯å‘ä¼˜å…ˆé˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ ï¼Œåªæ˜¯<code>Queue</code>æ¥å£è§„å®šäºŒè€…å¯¹æ’å…¥å¤±è´¥æ—¶çš„å¤„ç†ä¸åŒï¼Œå‰è€…åœ¨æ’å…¥å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œååˆ™åˆ™ä¼šè¿”å›<code>false</code>ã€‚å¯¹äº<em>PriorityQueue</em>è¿™ä¸¤ä¸ªæ–¹æ³•å…¶å®æ²¡ä»€ä¹ˆå·®åˆ«ã€‚</p><p><img src="https://github.com/CarpenterLee/JCFInternals/raw/master/PNGFigures/PriorityQueue_offer.png" alt="PriorityQueue_offer.png"></p><p>æ–°åŠ å…¥çš„å…ƒç´ å¯èƒ½ä¼šç ´åå°é¡¶å †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//offer(E e)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>)<span class="comment">//ä¸å…è®¸æ”¾å…¥nullå…ƒç´ </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">int</span> i = size;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">        grow(i + <span class="number">1</span>);<span class="comment">//è‡ªåŠ¨æ‰©å®¹</span></span><br><span class="line">    size = i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>)<span class="comment">//é˜Ÿåˆ—åŸæ¥ä¸ºç©ºï¼Œè¿™æ˜¯æ’å…¥çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        queue[<span class="number">0</span>] = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftUp(i, e);<span class="comment">//è°ƒæ•´</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæ‰©å®¹å‡½æ•°<code>grow()</code>ç±»ä¼¼äº<code>ArrayList</code>é‡Œçš„<code>grow()</code>å‡½æ•°ï¼Œå°±æ˜¯å†ç”³è¯·ä¸€ä¸ªæ›´å¤§çš„æ•°ç»„ï¼Œå¹¶å°†åŸæ•°ç»„çš„å…ƒç´ å¤åˆ¶è¿‡å»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯<code>siftUp(int k, E x)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºæ’å…¥å…ƒç´ <code>x</code>å¹¶ç»´æŒå †çš„ç‰¹æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//siftUp()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftUp</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> parent = (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;<span class="comment">//parentNo = (nodeNo-1)/2</span></span><br><span class="line">        Object e = queue[parent];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)<span class="comment">//è°ƒç”¨æ¯”è¾ƒå™¨çš„æ¯”è¾ƒæ–¹æ³•</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = e;</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°åŠ å…¥çš„å…ƒç´ <code>x</code>å¯èƒ½ä¼šç ´åå°é¡¶å †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦è¿›è¡Œè°ƒæ•´ã€‚è°ƒæ•´çš„è¿‡ç¨‹ä¸ºï¼š<strong>ä»<code>k</code>æŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼Œå°†<code>x</code>é€å±‚ä¸å½“å‰ç‚¹çš„<code>parent</code>è¿›è¡Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼Œç›´åˆ°æ»¡è¶³<code>x &gt;= queue[parent]</code>ä¸ºæ­¢</strong>ã€‚æ³¨æ„è¿™é‡Œçš„æ¯”è¾ƒå¯ä»¥æ˜¯å…ƒç´ çš„è‡ªç„¶é¡ºåºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¾é æ¯”è¾ƒå™¨çš„é¡ºåºã€‚</p><h2 id="element-å’Œpeek"><a href="#element-å’Œpeek" class="headerlink" title="element()å’Œpeek()"></a>element()å’Œpeek()</h2><p><code>element()</code>å’Œ<code>peek()</code>çš„è¯­ä¹‰å®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯è·å–ä½†ä¸åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—ä¸­æƒå€¼æœ€å°çš„é‚£ä¸ªå…ƒç´ ï¼ŒäºŒè€…å”¯ä¸€çš„åŒºåˆ«æ˜¯å½“æ–¹æ³•å¤±è´¥æ—¶å‰è€…æŠ›å‡ºå¼‚å¸¸ï¼Œåè€…è¿”å›<code>null</code>ã€‚æ ¹æ®å°é¡¶å †çš„æ€§è´¨ï¼Œå †é¡¶é‚£ä¸ªå…ƒç´ å°±æ˜¯å…¨å±€æœ€å°çš„é‚£ä¸ªï¼›ç”±äºå †ç”¨æ•°ç»„è¡¨ç¤ºï¼Œæ ¹æ®ä¸‹æ ‡å…³ç³»ï¼Œ<code>0</code>ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ æ—¢æ˜¯å †é¡¶å…ƒç´ ã€‚æ‰€ä»¥<strong>ç›´æ¥è¿”å›æ•°ç»„<code>0</code>ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ å³å¯</strong>ã€‚</p><p><img src="https://github.com/CarpenterLee/JCFInternals/raw/master/PNGFigures/PriorityQueue_peek.png" alt="PriorityQueue_peek.png"></p><p>ä»£ç ä¹Ÿå°±éå¸¸ç®€æ´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//peek()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> (E) queue[<span class="number">0</span>];<span class="comment">//0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ å°±æ˜¯æœ€å°çš„é‚£ä¸ª</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="remove-å’Œpoll"><a href="#remove-å’Œpoll" class="headerlink" title="remove()å’Œpoll()"></a>remove()å’Œpoll()</h2><p><code>remove()</code>å’Œ<code>poll()</code>æ–¹æ³•çš„è¯­ä¹‰ä¹Ÿå®Œå…¨ç›¸åŒï¼Œéƒ½æ˜¯è·å–å¹¶åˆ é™¤é˜Ÿé¦–å…ƒç´ ï¼ŒåŒºåˆ«æ˜¯å½“æ–¹æ³•å¤±è´¥æ—¶å‰è€…æŠ›å‡ºå¼‚å¸¸ï¼Œåè€…è¿”å›<code>null</code>ã€‚ç”±äºåˆ é™¤æ“ä½œä¼šæ”¹å˜é˜Ÿåˆ—çš„ç»“æ„ï¼Œä¸ºç»´æŠ¤å°é¡¶å †çš„æ€§è´¨ï¼Œéœ€è¦è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚</p><p><img src="https://github.com/CarpenterLee/JCFInternals/raw/master/PNGFigures/PriorityQueue_poll.png" alt="PriorityQueue_poll.png"><br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> s = --size;</span><br><span class="line">    modCount++;</span><br><span class="line">    E result = (E) queue[<span class="number">0</span>];<span class="comment">//0ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ å°±æ˜¯æœ€å°çš„é‚£ä¸ª</span></span><br><span class="line">    E x = (E) queue[s];</span><br><span class="line">    queue[s] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        siftDown(<span class="number">0</span>, x);<span class="comment">//è°ƒæ•´</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç é¦–å…ˆè®°å½•<code>0</code>ä¸‹æ ‡å¤„çš„å…ƒç´ ï¼Œå¹¶ç”¨æœ€åä¸€ä¸ªå…ƒç´ æ›¿æ¢<code>0</code>ä¸‹æ ‡ä½ç½®çš„å…ƒç´ ï¼Œä¹‹åè°ƒç”¨<code>siftDown()</code>æ–¹æ³•å¯¹å †è¿›è¡Œè°ƒæ•´ï¼Œæœ€åè¿”å›åŸæ¥<code>0</code>ä¸‹æ ‡å¤„çš„é‚£ä¸ªå…ƒç´ ï¼ˆä¹Ÿå°±æ˜¯æœ€å°çš„é‚£ä¸ªå…ƒç´ ï¼‰ã€‚é‡ç‚¹æ˜¯<code>siftDown(int k, E x)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯<strong>ä»<code>k</code>æŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼Œå°†<code>x</code>é€å±‚å‘ä¸‹ä¸å½“å‰ç‚¹çš„å·¦å³å­©å­ä¸­è¾ƒå°çš„é‚£ä¸ªäº¤æ¢ï¼Œç›´åˆ°<code>x</code>å°äºæˆ–ç­‰äºå·¦å³å­©å­ä¸­çš„ä»»ä½•ä¸€ä¸ªä¸ºæ­¢</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//siftDown()</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDown</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">    <span class="comment">//é¦–å…ˆæ‰¾åˆ°å·¦å³å­©å­ä¸­è¾ƒå°çš„é‚£ä¸ªï¼Œè®°å½•åˆ°cé‡Œï¼Œå¹¶ç”¨childè®°å½•å…¶ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;<span class="comment">//leftNo = parentNo*2+1</span></span><br><span class="line">        Object c = queue[child];</span><br><span class="line">        <span class="keyword">int</span> right = child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;<span class="comment">//ç„¶åç”¨cå–ä»£åŸæ¥çš„å€¼</span></span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="remove-Object-o"><a href="#remove-Object-o" class="headerlink" title="remove(Object o)"></a>remove(Object o)</h2><p><code>remove(Object o)</code>æ–¹æ³•ç”¨äºåˆ é™¤é˜Ÿåˆ—ä¸­è·Ÿ<code>o</code>ç›¸ç­‰çš„æŸä¸€ä¸ªå…ƒç´ ï¼ˆå¦‚æœæœ‰å¤šä¸ªç›¸ç­‰ï¼Œåªåˆ é™¤ä¸€ä¸ªï¼‰ï¼Œè¯¥æ–¹æ³•ä¸æ˜¯<em>Queue</em>æ¥å£å†…çš„æ–¹æ³•ï¼Œè€Œæ˜¯<em>Collection</em>æ¥å£çš„æ–¹æ³•ã€‚ç”±äºåˆ é™¤æ“ä½œä¼šæ”¹å˜é˜Ÿåˆ—ç»“æ„ï¼Œæ‰€ä»¥è¦è¿›è¡Œè°ƒæ•´ï¼›åˆç”±äºåˆ é™¤å…ƒç´ çš„ä½ç½®å¯èƒ½æ˜¯ä»»æ„çš„ï¼Œæ‰€ä»¥è°ƒæ•´è¿‡ç¨‹æ¯”å…¶å®ƒå‡½æ•°ç¨åŠ ç¹çã€‚å…·ä½“æ¥è¯´ï¼Œ<code>remove(Object o)</code>å¯ä»¥åˆ†ä¸º2ç§æƒ…å†µï¼š1. åˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ã€‚ç›´æ¥åˆ é™¤å³å¯ï¼Œä¸éœ€è¦è°ƒæ•´ã€‚2. åˆ é™¤çš„ä¸æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä»åˆ é™¤ç‚¹å¼€å§‹ä»¥æœ€åä¸€ä¸ªå…ƒç´ ä¸ºå‚ç…§è°ƒç”¨ä¸€æ¬¡<code>siftDown()</code>å³å¯ã€‚æ­¤å¤„ä¸å†èµ˜è¿°ã€‚</p><p><img src="https://github.com/CarpenterLee/JCFInternals/raw/master/PNGFigures/PriorityQueue_remove2.png" alt="PriorityQueue_remove2.png"></p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//remove(Object o)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line"><span class="comment">//é€šè¿‡éå†æ•°ç»„çš„æ–¹å¼æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³o.equals(queue[i])å…ƒç´ çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> i = indexOf(o);</span><br><span class="line">    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> s = --size;</span><br><span class="line">    <span class="keyword">if</span> (s == i) <span class="comment">//æƒ…å†µ1</span></span><br><span class="line">        queue[i] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        E moved = (E) queue[s];</span><br><span class="line">        queue[s] = <span class="keyword">null</span>;</span><br><span class="line">        siftDown(i, moved);<span class="comment">//æƒ…å†µ2</span></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡è½¬è½½è‡³githubï¼š&lt;a href=&quot;https://github.com/CarpenterLee/JCFInternals/blob/master/markdown/8-PriorityQueue.md&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/CarpenterLee/JCFInternals/blob/master/markdown/8-PriorityQueue.md&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;PriorityQueue&quot;&gt;&lt;a href=&quot;#PriorityQueue&quot; class=&quot;headerlink&quot; title=&quot;PriorityQueue&quot;&gt;&lt;/a&gt;PriorityQueue&lt;/h1&gt;&lt;h1 id=&quot;æ€»ä½“ä»‹ç»&quot;&gt;&lt;a href=&quot;#æ€»ä½“ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;æ€»ä½“ä»‹ç»&quot;&gt;&lt;/a&gt;æ€»ä½“ä»‹ç»&lt;/h1&gt;&lt;p&gt;å‰é¢ä»¥Java &lt;em&gt;ArrayDeque&lt;/em&gt;ä¸ºä¾‹è®²è§£äº†&lt;em&gt;Stack&lt;/em&gt;å’Œ&lt;em&gt;Queue&lt;/em&gt;ï¼Œå…¶å®è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—å«åš&lt;em&gt;PriorityQueue&lt;/em&gt;ï¼Œå³ä¼˜å…ˆé˜Ÿåˆ—ã€‚&lt;strong&gt;ä¼˜å…ˆé˜Ÿåˆ—çš„ä½œç”¨æ˜¯èƒ½ä¿è¯æ¯æ¬¡å–å‡ºçš„å…ƒç´ éƒ½æ˜¯é˜Ÿåˆ—ä¸­æƒå€¼æœ€å°çš„&lt;/strong&gt;ï¼ˆJavaçš„ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡å–æœ€å°å…ƒç´ ï¼ŒC++çš„ä¼˜å…ˆé˜Ÿåˆ—æ¯æ¬¡å–æœ€å¤§å…ƒç´ ï¼‰ã€‚è¿™é‡Œç‰µæ¶‰åˆ°äº†å¤§å°å…³ç³»ï¼Œ&lt;strong&gt;å…ƒç´ å¤§å°çš„è¯„åˆ¤å¯ä»¥é€šè¿‡å…ƒç´ æœ¬èº«çš„è‡ªç„¶é¡ºåºï¼ˆ&lt;em&gt;natural ordering&lt;/em&gt;ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ—¶ä¼ å…¥çš„æ¯”è¾ƒå™¨&lt;/strong&gt;ï¼ˆ&lt;em&gt;Comparator&lt;/em&gt;ï¼Œç±»ä¼¼äºC++çš„ä»¿å‡½æ•°ï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Docker-alpineé•œåƒå¯¼è‡´çš„é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/f3674cca.html"/>
    <id>https://jingzhouzhao.github.io/archives/f3674cca.html</id>
    <published>2019-09-26T05:04:26.000Z</published>
    <updated>2019-10-16T09:05:40.003Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå°†ç°æœ‰çš„ä¸€ä¸ªé¡¹ç›®å®¹å™¨åŒ–éƒ¨ç½²ã€‚ç»è¿‡ä¸€æ®µæ—¶é—´çš„æŠ˜è…¾ï¼Œæ€»ç®—æˆåŠŸçš„è·‘èµ·æ¥äº†ã€‚ä½†æ˜¯æœ€è¿‘å‘ç°ä¸€ä¸ªé—®é¢˜ï¼šå›¾å½¢éªŒè¯ç æ²¡æ³•æ˜¾ç¤ºäº†ã€‚</p><a id="more"></a><p>é€šè¿‡æŸ¥æ‰¾æ—¥å¿—å‘ç°ä»¥ä¸‹å¼‚å¸¸å †æ ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NullPointerException: <span class="keyword">null</span></span><br><span class="line">        at sun.awt.X11FontManager.getDefaultPlatformFont(X11FontManager.java:<span class="number">779</span>)</span><br><span class="line">        at sun.font.SunFontManager$<span class="number">2</span>.run(SunFontManager.java:<span class="number">433</span>)</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">        at sun.font.SunFontManager.&lt;init&gt;(SunFontManager.java:<span class="number">376</span>)</span><br><span class="line">        at sun.awt.X11FontManager.&lt;init&gt;(X11FontManager.java:<span class="number">32</span>)</span><br><span class="line">        at sun.reflect.GeneratedConstructorAccessor62.newInstance(Unknown Source)</span><br><span class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:<span class="number">45</span>)</span><br><span class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:<span class="number">526</span>)</span><br><span class="line">        at java.lang.Class.newInstance(Class.java:<span class="number">383</span>)</span><br><span class="line">        at sun.font.FontManagerFactory$<span class="number">1</span>.run(FontManagerFactory.java:<span class="number">83</span>)</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">        at sun.font.FontManagerFactory.getInstance(FontManagerFactory.java:<span class="number">74</span>)</span><br><span class="line">        at java.awt.Font.getFont2D(Font.java:<span class="number">490</span>)</span><br><span class="line">        at java.awt.Font.access$<span class="number">000</span>(Font.java:<span class="number">224</span>)</span><br><span class="line">        at java.awt.Font$FontAccessImpl.getFont2D(Font.java:<span class="number">228</span>)</span><br><span class="line">        at sun.font.FontUtilities.getFont2D(FontUtilities.java:<span class="number">180</span>)</span><br><span class="line">        at sun.java2d.SunGraphics2D.checkFontInfo(SunGraphics2D.java:<span class="number">645</span>)</span><br><span class="line">        at sun.java2d.SunGraphics2D.getFontInfo(SunGraphics2D.java:<span class="number">806</span>)</span><br><span class="line">        at sun.java2d.pipe.GlyphListPipe.drawString(GlyphListPipe.java:<span class="number">50</span>)</span><br><span class="line">        at sun.java2d.SunGraphics2D.drawString(SunGraphics2D.java:<span class="number">2887</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç»“åˆæºç å‘ç°ï¼Œåº”è¯¥æ˜¯æ— æ³•è·å–åˆ°å­—ä½“å¯¼è‡´çš„å¼‚å¸¸ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">graphics.setFont(new Font(&quot;Default&quot;, Font.PLAIN, fsize));</span><br></pre></td></tr></table></figure><p>ç”±äºä»£ç æ²¡æœ‰åšå‡ºè¿‡å˜æ›´ï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®ï¼Œåº”è¯¥æ˜¯ç¯å¢ƒçš„é—®é¢˜äº†ã€‚</p><p>äºæ˜¯æˆ‘è¿›å…¥Dokcerå®¹å™¨æŸ¥çœ‹ç›¸å…³å­—ä½“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it containerId bash</span><br><span class="line">fc-list</span><br></pre></td></tr></table></figure><p>å‘ç°æ— ä»»ä½•å†…å®¹è¾“å‡ºã€‚ç»è¿‡ä¸€ç•ªæŸ¥æ‰¾ï¼Œè§£å†³åŠæ³•å¦‚ä¸‹ï¼š</p><ol><li><p>è¿›å…¥å®¹å™¨å®‰è£…å­—ä½“ï¼ˆåªèƒ½ä¸´æ—¶è§£å†³ï¼Œå½“é‡æ–°æ„å»ºåï¼Œå­—ä½“ä¼šä¸¢å¤±ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apk add --update ttf-dejavu fontconfig &amp;&amp; rm -rf /var/cache/apk/*</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹Dockerfile åœ¨æ„å»ºé•œåƒæ—¶å®‰è£…å­—ä½“ï¼ˆä¼šå½±å“æ„å»ºé€Ÿåº¦ï¼Œå®‰è£…å­—ä½“æ¯”è¾ƒæ…¢ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN apk add --update ttf-dejavu fontconfig &amp;&amp; rm -rf /var/cache/apk/*</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹åŸºç¡€é•œåƒï¼ˆæ¨èï¼‰</p><p>æˆ‘è¿™è¾¹å‡ºé—®é¢˜çš„å®¹å™¨æ˜¯åŸºäº<code>tomcat:8.0-jre7-alpine</code>æ„å»ºçš„ï¼Œalpine tagçš„é•œåƒæ¯”è¾ƒå°ï¼Œæ¯”è¾ƒå¹²å‡€ã€‚</p><p>æˆ‘åˆ°docker hubä¸Šæ‰¾åˆ°äº†ç±»ä¼¼çš„é•œåƒï¼Œ<code>slim</code> tagçš„ã€‚</p><p>ä¿®æ”¹Dockerfileï¼Œå°†<code>FROM tomcat:8.0-jre7-alpine</code> æ”¹ä¸º <code>FROM tomcat:8.0-jre7-slim</code>å³å¯ã€‚</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰æ®µæ—¶é—´æ¥åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå°†ç°æœ‰çš„ä¸€ä¸ªé¡¹ç›®å®¹å™¨åŒ–éƒ¨ç½²ã€‚ç»è¿‡ä¸€æ®µæ—¶é—´çš„æŠ˜è…¾ï¼Œæ€»ç®—æˆåŠŸçš„è·‘èµ·æ¥äº†ã€‚ä½†æ˜¯æœ€è¿‘å‘ç°ä¸€ä¸ªé—®é¢˜ï¼šå›¾å½¢éªŒè¯ç æ²¡æ³•æ˜¾ç¤ºäº†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Dockeréšè®°" scheme="https://jingzhouzhao.github.io/categories/Docker%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Docker" scheme="https://jingzhouzhao.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆè‹¹æœä¸è‡ªå·±åˆ¶é€ èŠ¯ç‰‡</title>
    <link href="https://jingzhouzhao.github.io/archives/52360944.html"/>
    <id>https://jingzhouzhao.github.io/archives/52360944.html</id>
    <published>2019-09-20T02:01:43.000Z</published>
    <updated>2019-10-16T09:05:40.010Z</updated>
    
    <content type="html"><![CDATA[<p>è‹¹æœè¿‘æœŸå‘å¸ƒäº†æœ€æ–°çš„å¤„ç†å™¨Apple A13 Bionicï¼Œç”±å°ç§¯ç”µä»£å·¥ã€‚ä¸ºä»€ä¹ˆè‹¹æœä¸è‡ªå·±åˆ¶é€ è®¾è®¡å‡ºæ¥çš„èŠ¯ç‰‡å‘¢ï¼Ÿ</p><a id="more"></a><p>åŸæ¥ä¸šå†…ä¹ æƒ¯æŠŠåŠå¯¼ä½“è¡Œä¸šçš„å…¬å¸åˆ†ä¸ºä¸‰ç±»ï¼š</p><p>fablessï¼ˆæ— æ™¶åœ†èŠ¯ç‰‡è®¾è®¡å‚ï¼‰ï¼šè¿™æ ·çš„å…¬å¸åªè®¾è®¡èŠ¯ç‰‡ï¼Œä¸è‡ªå·±åˆ¶é€ èŠ¯ç‰‡ã€‚æœ€å¤§çš„fablessä¼ä¸šæœ‰é«˜é€šã€åšé€šã€AMDã€è”å‘ç§‘ã€æ­ä¸Šäººå·¥æ™ºèƒ½è¿™æ³¢çƒ­ç‚¹æœ€è¿‘ç«çš„ä¸è¡Œçš„Nvidiaç­‰ç­‰ã€‚å›½å†…çš„fablessä¼ä¸šæœ‰æ”¶è´­äº†å±•è®¯å’Œé”è¿ªç§‘çš„æ¸…åç´«å…‰ã€åä¸ºæµ·æ€ç­‰ã€‚<br>Foundryï¼ˆä»£å·¥å‚ï¼‰ï¼šè¿™æ ·çš„å…¬å¸ä¸“é—¨ä¸ºåˆ«äººåˆ¶é€ èŠ¯ç‰‡ã€‚æœ€å¤§çš„Foundryä¼ä¸šæœ‰å°ç§¯ç”µï¼ˆTSMCï¼‰ã€GlobalFoundryã€UMCç­‰ã€‚å›½å†…æœ€å¤§çš„æ˜¯ä¸­èŠ¯å›½é™…ã€‚éšç€å·¥è‰ºè¿›æ­¥åˆ°20nmä»¥ä¸‹ï¼Œä»å¹³é¢æ™¶ä½“ç®¡å‘ä¸‰ç»´FinFETæ¼”åŒ–ï¼Œæ–°ä¸€ä»£å·¥è‰ºæ‰€éœ€è¦çš„æŠ•èµ„è¶Šæ¥è¶Šå¤§ï¼Œå·²ç»åªæœ‰å°‘æ•°å‡ ä¸ªç©å®¶èƒ½ç©å¾—èµ·äº†ï¼ˆå°ç§¯ç”µã€ä¸‰æ˜Ÿã€Intelï¼‰ã€‚å›½å†…çš„ä¸­èŠ¯å›½é™…è·Ÿå°ç§¯ç”µæœ‰å‡ ä»£çš„å·®è·ã€‚ä¸­èŠ¯å›½é™…ç›®å‰å•†ç”¨çš„æœ€å…ˆè¿›å·¥è‰ºæ˜¯28nmï¼Œå°ç§¯ç”µ16nmå·²ç»å¤§è§„æ¨¡å•†ç”¨ï¼Œ7nmä¹Ÿé©¬ä¸Šå°±è¦ç”¨èµ·æ¥ã€‚<br>IDMï¼ˆåˆ¶é€ å‚ç›´æ•´åˆï¼‰ï¼šè¿™æ ·çš„å…¬å¸æ—¢è®¾è®¡èŠ¯ç‰‡ï¼Œä¹Ÿè‡ªå·±åˆ¶é€ èŠ¯ç‰‡ã€‚æœ€å¤§çš„æœ‰Intelå’Œä¸‰æ˜Ÿã€‚</p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œåˆ†æ‹…é£é™©ï¼Œè‹¹æœä¸ç”¨èŠ±è´¹å·¨å¤§æŠ•èµ„å»ºç«‹ç”Ÿäº§çº¿ï¼Œå› æ­¤è½»èµ„äº§ï¼Œçµæ´»æ€§é«˜ï¼Œå¯ä»¥å¯¹å¸‚åœºå¿«é€Ÿååº”ï¼Œæ´»åŠ›è¶³ã€‚</p><p>å†è¯´å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸»æµçš„æ‰‹æœºå¤„ç†å™¨å‚å•†ä¸­å¾ˆå°‘è§åˆ°è‹±ç‰¹å°”å‘¢ï¼Ÿ<br>é¦–å…ˆæä¸€ä¸‹CPUçš„ç®€å•æ„æˆï¼šALUï¼ˆç®—æœ¯é€»è¾‘å•å…ƒï¼‰ã€æ§åˆ¶å•å…ƒã€å¯„å­˜å™¨<br>æ§åˆ¶å•å…ƒé€šè¿‡æ—¶é’Ÿæ§åˆ¶ç€æŒ‡ä»¤æ‰§è¡Œçš„èŠ‚å¥ï¼Œå°†æŒ‡ä»¤åŠ è½½å­˜æ”¾åœ¨å¯„å­˜å™¨ã€å¹¶é€šè¿‡ALUè®¡ç®—ã€‚<br>è¿™é‡Œæåˆ°äº†æŒ‡ä»¤ï¼ŒæŒ‡ä»¤åŸºæœ¬ä¸Šåˆ†ä¸ºä¸¤ç±»ï¼šRISCï¼ˆç²¾ç®€æŒ‡ä»¤é›†ï¼‰ ã€CISC ï¼ˆå¤æ‚æŒ‡ä»¤é›†ï¼‰ï¼ŒæŒ‡ä»¤è¶Šå¤æ‚æ„å‘³ç€èƒ½è€—è¶Šé«˜ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œåœ¨ç›®å‰æ‰‹æœºç”µæ± æŠ€æœ¯è¿˜æœªçªç ´çš„æƒ…å†µä¸‹ï¼Œæ‰‹æœºCPUä¼šä¸ŠCISCå—ï¼Ÿ<br>ä¸Šé¢è¯´çš„ä¸¤ä¸ªæŒ‡ä»¤é›†çš„å…¸å‹ä»£è¡¨å°±æ˜¯ARMå’Œx86ï¼ŒARMæ˜¯ç›®å‰ä¸»æµçš„æ‰‹æœºCPUæ¶æ„ï¼Œä¹Ÿå°±æ˜¯ç²¾ç®€æŒ‡ä»¤ã€‚è€Œx86æ‰æ˜¯è‹±ç‰¹å°”ç­‰å‚å•†çš„å¼ºé¡¹ã€‚<br>ä¹Ÿè®¸æ˜¯è‹±ç‰¹å°”å‡ºäºæˆ˜ç•¥è€ƒè™‘æ”¾å¼ƒäº†ç§»åŠ¨å¤„ç†å™¨è¿™å—è›‹ç³•ï¼Œæˆ–è€…è¯´è‹±ç‰¹å°”æ²¡æœ‰æ„æ–™åˆ°è¿™å—è›‹ç³•è¿™ä¹ˆå¤§ã€‚ä¸è¿‡ï¼Œç›®å‰AppèƒŒåå¯¹åº”çš„è¿˜æ˜¯å„ç§Serverï¼ŒServerç¦»ä¸å¼€x86ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š<br><a href="https://www.zhihu.com/question/68283951/answer/262481048" target="_blank" rel="noopener">https://www.zhihu.com/question/68283951/answer/262481048</a><br><a href="https://www.zhihu.com/question/20148756" target="_blank" rel="noopener">https://www.zhihu.com/question/20148756</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è‹¹æœè¿‘æœŸå‘å¸ƒäº†æœ€æ–°çš„å¤„ç†å™¨Apple A13 Bionicï¼Œç”±å°ç§¯ç”µä»£å·¥ã€‚ä¸ºä»€ä¹ˆè‹¹æœä¸è‡ªå·±åˆ¶é€ è®¾è®¡å‡ºæ¥çš„èŠ¯ç‰‡å‘¢ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>golangå†™æ–‡ä»¶å¼‚å¸¸invalid argument</title>
    <link href="https://jingzhouzhao.github.io/archives/848ae75e.html"/>
    <id>https://jingzhouzhao.github.io/archives/848ae75e.html</id>
    <published>2019-09-11T07:10:49.000Z</published>
    <updated>2019-10-16T09:05:40.004Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dst, err := os.OpenFile(path, os.O_CREATE|os.O_APPEND|os.O_RDWR, <span class="number">0644</span>)</span><br><span class="line"><span class="keyword">defer</span> dst.Close()</span><br><span class="line">n, err := dst.Write(buffer.Buffer[<span class="number">0</span>:n])</span><br></pre></td></tr></table></figure><a id="more"></a><p>ä¸Šé¢æ˜¯ä¸€æ®µå¾ˆç®€å•çš„ä»£ç ï¼Œä½†æ˜¯åœ¨é¢‘ç¹è°ƒç”¨çš„æ—¶å€™æŠ¥é”™äº†äº†:<code>invalid argument</code></p><p>è¿™ä¸ªé”™è¯¯ç€å®å¤ªè¯¯å¯¼äººäº†ï¼Œè®©æˆ‘ä»¥ä¸ºæ˜¯ä½¿ç”¨çš„å§¿åŠ¿ä¸å¯¹ï¼Œåæ¥å‘ç°æ²¡æœ‰é—®é¢˜ï¼Œäºæ˜¯å¼€å§‹debugï¼Œåæ¥åœ¨ä¸‹é¢ä¸€æ®µä»£ç ä¸­å‘ç°äº†çœŸæ­£çš„é—®é¢˜ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateFile</span><span class="params">(name *<span class="keyword">uint16</span>, access <span class="keyword">uint32</span>, mode <span class="keyword">uint32</span>, sa *SecurityAttributes, createmode <span class="keyword">uint32</span>, attrs <span class="keyword">uint32</span>, templatefile <span class="keyword">int32</span>)</span> <span class="params">(handle Handle, err error)</span></span> &#123;</span><br><span class="line">r0, _, e1 := Syscall9(procCreateFileW.Addr(), <span class="number">7</span>, <span class="keyword">uintptr</span>(unsafe.Pointer(name)), <span class="keyword">uintptr</span>(access), <span class="keyword">uintptr</span>(mode), <span class="keyword">uintptr</span>(unsafe.Pointer(sa)), <span class="keyword">uintptr</span>(createmode), <span class="keyword">uintptr</span>(attrs), <span class="keyword">uintptr</span>(templatefile), <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">handle = Handle(r0)</span><br><span class="line"><span class="keyword">if</span> handle == InvalidHandle &#123;</span><br><span class="line"><span class="keyword">if</span> e1 != <span class="number">0</span> &#123;</span><br><span class="line">            </span><br><span class="line">err = errnoErr(e1)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">err = EINVAL</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»™å‡ºäº†çœŸæ­£çš„åŸå› ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err &#x3D; errnoErr(e1)&#x2F;&#x2F;è¿™ä¸ªåœ°æ–¹ç»™å‡ºäº†çœŸæ­£çš„é”™è¯¯ï¼šERROR_SHARING_VIOLATION (32)</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å¾®è½¯<a href="https://docs.microsoft.com/en-us/windows/win32/debug/system-error-codes--0-499-æ–‡æ¡£ï¼Œ" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/debug/system-error-codes--0-499-æ–‡æ¡£ï¼Œ</a></p><p>è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The process cannot access the file because it is being used by another process.</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨OpenFileä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œä¹‹å‰ä½¿ç”¨çš„è¿™ä¸ªæ–‡ä»¶çš„file descriptor å¹¶çœŸæ­£æ²¡æœ‰é‡Šæ”¾ï¼Œæ‰€ä»¥å‡ºé”™äº†ã€‚</p><p>è€ŒGolangä¸Šå±‚çš„é”™è¯¯å¹¶æ²¡æœ‰ç»™å‡ºæ˜ç¡®çš„é”™è¯¯ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;dst, err := os.OpenFile(path, os.O_CREATE|os.O_APPEND|os.O_RDWR, &lt;span class=&quot;number&quot;&gt;0644&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; dst.Close()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;n, err := dst.Write(buffer.Buffer[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;:n])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Golangéšè®°" scheme="https://jingzhouzhao.github.io/categories/Golang%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Golang" scheme="https://jingzhouzhao.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>è·Ÿç€Bç«™å­¦Golang(admin-ep-saga)</title>
    <link href="https://jingzhouzhao.github.io/archives/f11de5dd.html"/>
    <id>https://jingzhouzhao.github.io/archives/f11de5dd.html</id>
    <published>2019-09-05T08:50:12.000Z</published>
    <updated>2019-10-16T09:05:40.005Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡å®Œå…¨å‡ºäºå­¦ä¹ çš„ç›®çš„ï¼Œå¦‚æœ‰å¼‚è®®ï¼Œè¯·è”ç³»åˆ é™¤ã€‚</p></blockquote><p>ä¹‹å‰XLäº‹ä»¶æµå‡ºçš„ä¼˜ç§€ä»£ç å¤ªå¤šäº†ï¼Œè¿™æ¬¡é€‰æ‹©çš„æ˜¯ä¸€ä¸ªå¥½åƒä¸å…·ä½“ä¸šåŠ¡æ— å…³çš„æ¨¡å—(admin-ep-saga)æ¥è¿›è¡Œå­¦ä¹ ã€‚</p><a id="more"></a><p>é¦–å…ˆçœ‹çœ‹ç›®å½•ç»“æ„ï¼š</p><p><img src="/archives/f11de5dd/1.png" alt="ç›®å½•ç»“æ„"></p><p>è¿™ä¹ˆå¤šå…ˆçœ‹å“ªä¸€ä¸ªå‘¢ï¼Ÿåœ¨ä¸çŸ¥é“å…·ä½“æ¯ä¸ªåŒ…æ˜¯å¹²ä»€ä¹ˆçš„æƒ…å†µä¸‹ï¼Œåªå¥½ä¸€ä¸ªä¸€ä¸ªçš„çœ‹äº†ã€‚</p><p>å…ˆçœ‹çœ‹<code>api</code>ä¸‹æœ‰äº›ä»€ä¹ˆï¼š</p><p><img src="/archives/f11de5dd/2.png" alt="api"></p><p>ä¸å¾—ä¸è¯´è¿™ä¸ªç›®å½•çš„ç»“æ„ç›¸å½“è§„èŒƒå‘€ï¼Œè™½ç„¶æˆ‘æ²¡æœ‰ç‚¹å¼€å…·ä½“æ–‡ä»¶ï¼Œä½†æ˜¯ä»…ä»…ä»ç›®å½•åå’Œæ–‡ä»¶åå°±èƒ½çŒœå‡ºè¿™ä¸ªç›®å½•ä¸‹æ˜¯å¹²ä»€ä¹ˆçš„ï¼š</p><p>åº”è¯¥æ˜¯ä½¿ç”¨äº†grpcæ¡†æ¶å’Œprotobufåè®®å®šä¹‰çš„æ¥å£ã€‚è¿™ä¸ªæš‚æ—¶å…ˆæ”¾ä¸€è¾¹ï¼Œæˆ‘éœ€è¦å…ˆæ‰¾åˆ°<strong>ç¨‹åºå…¥å£</strong>ï¼Œè¿™æ ·æ‰èƒ½ä¸€æ­¥ä¸€æ­¥çš„å­¦ä¹ ä¼˜ç§€ä»£ç æ˜¯å¦‚ä½•ç¼–å†™çš„ã€‚</p><p>æ¥ä¸‹æ¥æ‰“å¼€<code>cmd</code>:</p><p><img src="/archives/f11de5dd/3.png" alt="cmd"></p><p>è¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><ol><li><code>BUILD</code>çœ‹ç€åº”è¯¥æ˜¯ç”¨æ¥åšæ„å»ºç”¨çš„ï¼Œè¿™ä¸æ˜¯æˆ‘è¿™æ¬¡å­¦ä¹ çš„é‡ç‚¹ï¼Œå…ˆè·³è¿‡ã€‚</li><li><code>saga-admin-test.toml</code> æˆ‘æ‰“å¼€çœ‹äº†ä¸€çœ¼ï¼Œæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä»åå­—å¯ä»¥çœ‹å‡ºåº”è¯¥æ˜¯æµ‹è¯•ç”¨çš„é…ç½®é¡¹ï¼Œåé¢è¿˜ä¼šç¢°åˆ°ã€‚</li><li><code>main.go</code> å¦‚æœä¸å‡ºæ„å¤–ï¼Œè¿™ä¸ªåº”è¯¥å°±æ˜¯<strong>ç¨‹åºå…¥å£</strong>äº†ï¼Œè¿æ°”è¿˜ä¸é”™ï¼Œç¬¬äºŒä¸ªç›®å½•å°±æ‰¾åˆ°äº†å…¥å£ã€‚</li></ol><p>æ¥ä¸‹æ¥è¯¦ç»†çš„çœ‹çœ‹main.goåšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¿™é‡Œæˆ‘å¿½ç•¥äº†ä¸€äº›åŒ…å¯¼å…¥ï¼Œä»¥åŠä¸€äº›å¸¸é‡</span></span><br><span class="line"><span class="comment">å› ä¸ºå¦‚æœæ¯ä¸ªå¯¼å…¥çš„åŒ…éƒ½è¦çœ‹çš„è¯ï¼Œä¼šè¶Šé™·è¶Šæ·±ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//è§£æå‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line">flag.Parse()</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–é…ç½®</span></span><br><span class="line"><span class="keyword">if</span> err := conf.Init(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"conf.Init() error(%v)"</span>, err)</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–Log</span></span><br><span class="line">log.Init(conf.Conf.Log)</span><br><span class="line"><span class="keyword">defer</span> log.Close()</span><br><span class="line">log.Info(<span class="string">"saga-admin start"</span>)</span><br><span class="line"><span class="comment">//å¯åŠ¨ä¸€ä¸ªæœåŠ¡</span></span><br><span class="line">s := service.New()</span><br><span class="line">http.Init(s)</span><br><span class="line">    <span class="comment">//å¯åŠ¨ä¸€ä¸ªgrpcæœåŠ¡</span></span><br><span class="line">grpcsvr, err := grpc.New(<span class="literal">nil</span>, s.Wechat())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º1çš„os.Signalç±»å‹çš„channel</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">//é€šçŸ¥</span></span><br><span class="line">signal.Notify(c, syscall.SIGHUP, syscall.SIGQUIT, syscall.SIGTERM, syscall.SIGINT)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">//ä»å‰é¢åˆ›å»ºçš„channelä¸­è¯»å–signal</span></span><br><span class="line">si := &lt;-c</span><br><span class="line">log.Info(<span class="string">"saga-admin get a signal %s"</span>, si.String())</span><br><span class="line"><span class="keyword">switch</span> si &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯SIGQUITã€SIGTERMã€SIGINTåˆ™å…³é—­ç›¸å…³æœåŠ¡ï¼Œç„¶åé€€å‡º</span></span><br><span class="line"><span class="keyword">case</span> syscall.SIGQUIT, syscall.SIGTERM, syscall.SIGINT:</span><br><span class="line">grpcsvr.Shutdown(context.Background())</span><br><span class="line">log.Info(<span class="string">"saga-admin exit"</span>)</span><br><span class="line">s.Close()</span><br><span class="line">time.Sleep(_durationForClosingServer * time.Second)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> syscall.SIGHUP:</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç²—ç•¥çš„çœ‹äº†ä¸€ä¸‹ä»£ç åï¼Œå¸¦ç€ç–‘é—®ï¼Œä¸€è¡Œä¸€è¡Œçš„æ¥åˆ†æï¼Œé¦–å…ˆç¬¬ä¸€è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag.Parse()</span><br></pre></td></tr></table></figure><p>ä½œä¸ºGolangå°ç™½ï¼Œæˆ‘çŸ¥é“è¿™ä¸ªåº”è¯¥æ˜¯ä½¿ç”¨åœ¨<code>flag.StringVar</code>è¿™æ ·çš„ä»£ç åé¢ï¼Œå®šä¹‰éœ€è¦è·å–çš„å‘½ä»¤è¡Œå‚æ•°ã€‚</p><p>ä½†æ˜¯<code>flag.Parse()</code>ä½œä¸ºç¬¬ä¸€è¡Œä»£ç å‰é¢å¹¶æ²¡æœ‰<code>flag.StringVar</code>ç±»ä¼¼è¿™æ ·çš„ä»£ç å‘€ï¼Œç„¶åæˆ‘æƒ³åˆ°äº†Golangä¸­<code>init</code>å‡½æ•°çš„ä½œç”¨ã€‚äºæ˜¯æˆ‘å¼€å§‹æ‰¾<code>main.go</code>ä¸­å¯¼å…¥çš„å…¶ä»–åŒ…ä¸­æœ‰æ²¡æœ‰å®šä¹‰initå‡½æ•°ï¼Œæœä¸å…¶ç„¶ï¼Œåœ¨<code>saga/conf/conf.go</code>ä¸­æˆ‘æ‰¾åˆ°äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œç”¨æ¥æ¥æ”¶é…ç½®æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">flag.StringVar(&amp;confPath, <span class="string">"conf"</span>, <span class="string">""</span>, <span class="string">"config path"</span>)</span><br><span class="line">    <span class="comment">//è¿™ä¸ªreloadåé¢å†è®²</span></span><br><span class="line">reload = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">10</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°<code>main.go</code>æ¥çœ‹ä¸‹é¢å‡ è¡Œä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := conf.Init(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Error(<span class="string">"conf.Init() error(%v)"</span>, err)</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¿½ç•¥é”™è¯¯åˆ¤æ–­ä»¥åŠæ—¥å¿—æ‰“å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™å‡ è¡Œä¸­æœ€å…³é”®çš„ä»£ç å°±æ˜¯<code>conf.Init()</code>ï¼Œè¿™ä¸ªä»£ç åšäº†äº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿæ¥ä¸‹æ¥è¿›å…¥<code>saga/conf/conf.go</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å¦‚æœé…ç½®æ–‡ä»¶çš„è·¯å¾„ä¸ºç©ºï¼Œåˆ™æ‰§è¡ŒconfigCenter()æ–¹æ³•</span></span><br><span class="line"><span class="keyword">if</span> confPath == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">return</span> configCenter()</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//å¦‚æœé…ç½®æ–‡ä»¶è·¯å¾„ä¸ä¸ºç©ºé€šè¿‡toml.DecodeFile(confPath, &amp;Conf)è§£æé…ç½®åˆ°&amp;Confä¸­</span></span><br><span class="line"><span class="keyword">if</span> _, err = toml.DecodeFile(confPath, &amp;Conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"toml.DecodeFile(%s) err(%+v)"</span>, confPath, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//å•ç‹¬è§£æTeamInfoç›¸å…³é…ç½®</span></span><br><span class="line">Conf = parseTeamInfo(Conf)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> confPath == <span class="string">""</span> &#123;</span><br><span class="line"><span class="keyword">return</span> configCenter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å‡½æ•°åå¯ä»¥çœ‹å‡ºï¼Œå½“æ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„æ˜¯ï¼Œèµ°é…ç½®ä¸­å¿ƒè§£æé…ç½®ã€‚<code>configCenter</code>æˆ‘ä»¬å…ˆæ”¾ä¸€æ”¾ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> _, err = toml.DecodeFile(confPath, &amp;Conf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"toml.DecodeFile(%s) err(%+v)"</span>, confPath, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬å¿½ç•¥é”™è¯¯å’Œæ—¥å¿—å¤„ç†ï¼Œå¯ä»¥çœ‹åˆ°è¿™å‡ è¡Œå…³é”®ä»£ç æ˜¯<code>toml.DecodeFile(confPath, &amp;Conf)</code>ï¼Œ</p><p><code>toml</code>è¿™ä¸ªçœ‹ç€æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Œä¹‹å‰åœ¨<code>cmd</code>åŒ…ä¸‹æˆ‘ä»¬çœ‹åˆ°è¿‡ä¸€ä¸ªè¿™ä¸ªæ ¼å¼çš„æ–‡ä»¶<code>saga-admin-test.toml</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±GitHubè”åˆåˆ›å§‹äººTom Preston-Werner æå‡ºçš„æç®€é…ç½®æ–‡ä»¶æ ¼å¼ã€‚å„ä¸ªè¯­è¨€éƒ½æœ‰ç›¸å…³å®ç°ï¼ŒBZè¿™é‡Œä½¿ç”¨çš„æ˜¯<code>github.com/BurntSushi/toml</code>è¿™ä¸ªåº“ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œè¿™å‡ è¡Œä»£ç æ— éå°±æ˜¯è§£æé…ç½®æ–‡ä»¶ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Conf = parseTeamInfo(Conf)</span><br></pre></td></tr></table></figure><p>å•ç‹¬ç”¨äº†ä¸€ä¸ªæ–¹æ³•æ¥è§£æ<code>TeamInfo</code>è¯´æ˜tomlæ ‡å‡†çš„DecodeFileè§£æä¸äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¿™ä¸ªæ–¹æ³•åšçš„äº‹æƒ…æ¯”è¾ƒç®€å•ï¼Œç›´æ¥é‡‡ç”¨æ³¨é‡Šçš„æ–¹æ³•è®²è§£</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseTeamInfo</span><span class="params">(c *Config)</span> *<span class="title">Config</span></span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">strings.Fieldsï¼Œæˆ‘ä»¬éƒ½çŸ¥é“è¿™ä¸ªæ˜¯æ ¹æ®å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼æˆ–è€…ä¸€äº›ä¸ªç‰¹æ®Šç¬¦å·æ¥æ‹†åˆ†å­—ç¬¦ä¸²ä¸ºArrayçš„æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">æˆ‘ä»¬æ¥çœ‹çœ‹ä¹‹å‰æåˆ°çš„saga-admin-test.tomlä¸­c.Property.Department å®šä¹‰çš„æ˜¯ä»€ä¹ˆï¼š</span></span><br><span class="line"><span class="comment">[property.department]</span></span><br><span class="line"><span class="comment">        label = "ä¸»ç«™ ç›´æ’­ bplus å¼€æ”¾å¹³å° åˆ›ä½œä¸­å¿ƒ å•†ä¸šäº§å“ æ•°æ®ä¸­å¿ƒ è§†é¢‘äº‘ æ¸¸æˆ ç«é¸Ÿ"</span></span><br><span class="line"><span class="comment">        value = "mainsite live bplus openplatform creative advertising datacenter videocloud game firebird"</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">DeLabel := strings.Fields(c.Property.Department.Label)</span><br><span class="line">DeValue := strings.Fields(c.Property.Department.Value)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(DeLabel); i++ &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æ‰€ä»¥è¿™å‡ è¡Œä»£ç ï¼Œå¾ˆæ˜¾è€Œæ˜“è§äº†ï¼Œå°±æ˜¯å°†ä¸Šè¿°çš„label å’Œvalueç»„åˆæˆkey-valueçš„å½¢å¼ç„¶åappendåˆ°å¦å¤–ä¸€ä¸ª(DeInfo)Arrayä¸­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">info := &amp;model.PairKey&#123;</span><br><span class="line">Label: DeLabel[i],</span><br><span class="line">Value: DeValue[i],</span><br><span class="line">&#125;</span><br><span class="line">c.Property.DeInfo = <span class="built_in">append</span>(c.Property.DeInfo, info)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸‹é¢å‡ è¡Œä»£ç åŒä¸Šï¼Œå°±ä¸åœ¨èµ˜è¿°</span></span><br><span class="line">buLabel := strings.Fields(c.Property.Business.Label)</span><br><span class="line">buValue := strings.Fields(c.Property.Business.Value)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(buLabel); i++ &#123;</span><br><span class="line"></span><br><span class="line">info := &amp;model.PairKey&#123;</span><br><span class="line">Label: buLabel[i],</span><br><span class="line">Value: buValue[i],</span><br><span class="line">&#125;</span><br><span class="line">c.Property.BuInfo = <span class="built_in">append</span>(c.Property.BuInfo, info)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯è¯´ï¼Œä¸Šé¢çš„<code>Business</code>å’Œ<code>Department</code>å¤„ç†è¿‡ç¨‹ä¸€æ ·ï¼Œä¸ºå•¥ä¸å°†è¿™ä¸ªè¿‡ç¨‹æå–æˆä¸€ä¸ªå‡½æ•°å‘¢ï¼Ÿæ¥è‡ªå°ç™½çš„ç–‘é—®ã€‚</p><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰è·³è¿‡ä¸€ä¸ªå‡½æ•°<code>configCenter()</code>å—ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configCenter</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œçš„confåº”è¯¥æ˜¯BZä¸€ä¸ªå…¬å…±ç»„ä»¶ï¼Œè¿™é‡Œåšçš„å°±æ˜¯åˆ›å»ºä¸€ä¸ªé…ç½®ä¸­å¿ƒçš„client</span></span><br><span class="line"><span class="keyword">if</span> client, err = conf.New(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//è¿™é‡Œè°ƒç”¨äº†loadå‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> err = load(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//è¿™é‡Œåº”è¯¥æ˜¯æ·»åŠ äº†ä¸€ä¸ªé…ç½®ä¸­å¿ƒçš„ç›‘å¬</span></span><br><span class="line">client.WatchAll()</span><br><span class="line">    <span class="comment">//èµ·ä¸€ä¸ªgoroute</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//è·å–äº‹ä»¶ï¼Œå¦‚æœé…ç½®ä¸­å¿ƒçš„é…ç½®å­˜åœ¨ä¿®æ”¹é‡æ–°è°ƒç”¨loadå‡½æ•°</span></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">range</span> client.Event() &#123;</span><br><span class="line">log.Info(<span class="string">"config reload"</span>)</span><br><span class="line"><span class="keyword">if</span> load() != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"config reload error (%v)"</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//loadæˆåŠŸå¾€reload chanå†™å…¥ä¸€ä¸ªæ•°æ®ï¼Œè¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œç­‰åé¢å†è¯´</span></span><br><span class="line">reload &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¿½ç•¥å…¶å®ƒä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢å®ç°é…ç½®ä¸­å¿ƒé…ç½®åŠ è½½çš„åº”è¯¥æ˜¯loadå‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ç»„å±€éƒ¨å˜é‡</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">s       <span class="keyword">string</span></span><br><span class="line">ok      <span class="keyword">bool</span></span><br><span class="line">tmpConf *Config</span><br><span class="line">)</span><br><span class="line">    <span class="comment">//é€šè¿‡é…ç½®ä¸­å¿ƒçš„clientè·å–é…ç½®ï¼Œè¿™é‡Œçš„_configkeyæ˜¯å¸¸é‡ï¼š"saga-admin.toml"</span></span><br><span class="line"><span class="keyword">if</span> s, ok = client.Value(_configKey); !ok &#123;</span><br><span class="line">err = errors.Errorf(<span class="string">"load config center error [%s]"</span>, _configKey)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//è·Ÿä¹‹å‰ä¸€æ ·é€šè¿‡tomlè§£æé…ç½®</span></span><br><span class="line"><span class="keyword">if</span> _, err = toml.Decode(s, &amp;tmpConf); err != <span class="literal">nil</span> &#123;</span><br><span class="line">err = errors.Wrapf(err, <span class="string">"could not decode config err(%+v)"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//è·Ÿä¹‹å‰ä¸€æ ·å•ç‹¬è§£æTeamInfo</span></span><br><span class="line">Conf = parseTeamInfo(tmpConf)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·®ä¸å¤šåˆšåˆšçœ‹å®Œ<code>main.go</code>ä¸­<code>conf.Init()</code>çš„è°ƒç”¨ï¼Œæ¥ä¸‹æ¥å›åˆ°<code>main.go</code>ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼š</p><p>æˆ‘ä»¬è·³è¿‡Logçš„åˆå§‹åŒ–ï¼Œç›´æ¥çœ‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è°ƒç”¨/saga/serviceä¸­çš„Newå‡½æ•°</span></span><br><span class="line">s := service.New()</span><br><span class="line"><span class="comment">//è°ƒç”¨/saga/httpä¸­çš„Initå‡½æ•°</span></span><br><span class="line">http.Init(s)</span><br></pre></td></tr></table></figure><p>è·³è½¬åˆ°<code>New</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çœ‹çœ‹åšäº†äº›ä»€ä¹ˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> <span class="params">(s *Service)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">err error</span><br><span class="line">)</span><br><span class="line">s = &amp;Service&#123;</span><br><span class="line">dao:  dao.New(),</span><br><span class="line">cron: cron.New(),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err = s.cron.AddFunc(conf.Conf.Property.SyncProject.CheckCron, s.collectprojectproc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err = s.cron.AddFunc(conf.Conf.Property.Git.CheckCron, s.alertProjectPipelineProc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err = s.cron.AddFunc(conf.Conf.Property.SyncData.CheckCron, s.syncdataproc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err = s.cron.AddFunc(conf.Conf.Property.SyncData.CheckCronAll, s.syncalldataproc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err = s.cron.AddFunc(conf.Conf.Property.SyncData.CheckCronWeek, s.syncweekdataproc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">s.cron.Start()</span><br><span class="line"></span><br><span class="line"><span class="comment">// init gitlab client</span></span><br><span class="line">s.gitlab = gitlab.New(conf.Conf.Property.Gitlab.API, conf.Conf.Property.Gitlab.Token)</span><br><span class="line"><span class="comment">// init online gitlab client</span></span><br><span class="line">s.git = gitlab.New(conf.Conf.Property.Git.API, conf.Conf.Property.Git.Token)</span><br><span class="line"><span class="comment">// init wechat client</span></span><br><span class="line">s.wechat = wechat.New(s.dao)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨åšå®šæ—¶ä»»åŠ¡çš„åˆ›å»ºï¼Œ<code>cron</code>ä½¿ç”¨çš„æ˜¯<code>&quot;github.com/robfig/cron&quot;</code>è¿™ä¸ªåº“ï¼Œæˆ‘ä»¬æŒ‘ä¸€ä¸ªçœ‹çœ‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err = s.cron.AddFunc(conf.Conf.Property.SyncProject.CheckCron, s.collectprojectproc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>conf.Conf.Property.SyncProject.CheckCron</code> æ˜¯é…ç½®ä¸­çš„cronè¡¨è¾¾å¼ï¼Œåœ¨<code>saga-admin-test.toml</code>ä¸­çœ‹åˆ°æ˜¯</p><p><code>* */15 * * * ?</code>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä»»åŠ¡æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚</p><p><code>s.collectprojectproc</code> æ˜¯è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹è¿™ä¸ªä»»åŠ¡åšäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span> <span class="title">collectprojectproc</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">    <span class="comment">//å¯ä»¥çœ‹åˆ°å®é™…è°ƒç”¨çš„æ˜¯CollectProjectï¼Œè¿™é‡Œçš„context.TODO()è¡¨ç¤ºcontextè¿˜æœªå®ç°ï¼Œè¿™é‡Œä»…ä»…ç”¨ä½œå ä½ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰</span></span><br><span class="line"><span class="keyword">if</span> err = s.CollectProject(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"s.CollectProject err (%+v)"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span> <span class="title">CollectProject</span><span class="params">(c context.Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//è¿™æ˜¯ä¸€ç»„å±€éƒ¨å˜é‡</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">projects []*gitlab.Project</span><br><span class="line">total    = <span class="number">0</span></span><br><span class="line">page     = <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">log.Info(<span class="string">"Collect Project start"</span>)</span><br><span class="line">    <span class="comment">//è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªmagic numberï¼Œ1000</span></span><br><span class="line"><span class="keyword">for</span> page &lt;= <span class="number">1000</span> &#123;</span><br><span class="line"><span class="comment">//è°ƒç”¨gitlabæ¥å£è·å–æŒ‡å®šé¡µç çš„é¡¹ç›®åˆ—è¡¨ï¼Œè¿™é‡Œçš„s.gitlabæ˜¯åœ¨service.New()ä¸­å®ä¾‹åŒ–çš„ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç–‘é—®ã€‚</span></span><br><span class="line"><span class="keyword">if</span> projects, err = s.gitlab.ListProjects(page); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">num := <span class="built_in">len</span>(projects)</span><br><span class="line"><span class="keyword">if</span> num &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">total = total + num</span><br><span class="line"><span class="comment">//å°†è·å–åˆ°çš„é¡¹ç›®ä¿å­˜åˆ°dbä¸­ï¼Œè¿™ä¸ªinsertDBå°±ä¸å±•å¼€è®²äº†ï¼Œè¿™é‡Œé¢åšçš„å¤§æ¦‚å°±æ˜¯saveOrUpdateçš„äº‹æƒ…ã€‚</span></span><br><span class="line"><span class="keyword">for</span> _, p := <span class="keyword">range</span> projects &#123;</span><br><span class="line"><span class="keyword">if</span> err = s.insertDB(p); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page = page + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">log.Info(<span class="string">"Collect Project end, find %d projects"</span>, total)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>service.New()</code>ä¸­å…¶ä»–çš„cronä¹Ÿå·®ä¸å¤šæ˜¯åšç€ç±»ä¼¼çš„äº‹æƒ…ï¼Œç”±äºå¤ªå¤šï¼Œå°±ä¸åœ¨è¿™é‡Œä¸€ä¸€å±•å¼€ã€‚åˆšåˆšè¯´åˆ°</p><p><code>s.gitlab.ListProjects(page);</code>æˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çœ‹è¿™é‡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s.cron.Start()</span><br><span class="line"><span class="comment">// init gitlab client</span></span><br><span class="line">s.gitlab = gitlab.New(conf.Conf.Property.Gitlab.API, conf.Conf.Property.Gitlab.Token)</span><br><span class="line"><span class="comment">// init online gitlab client</span></span><br><span class="line">s.git = gitlab.New(conf.Conf.Property.Git.API, conf.Conf.Property.Git.Token)</span><br><span class="line"><span class="comment">// init wechat client</span></span><br><span class="line">s.wechat = wechat.New(s.dao)</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°cronçš„startæ˜¯åœ¨gitlabã€gitã€wechatå®ä¾‹åŒ–ä¹‹å‰ï¼Œè€Œcronç›¸å…³çš„ä»»åŠ¡ä¸­åˆä¾èµ–äº†è¿™äº›clientï¼Œé‚£æœ‰æ²¡æœ‰è¿™ä¹ˆä¸€ç§å¯èƒ½ï¼šè¿™ä¸ªç¨‹åºå¯åŠ¨çš„æ—¶å€™æ­£å¥½ç¢°ä¸Šcronè§¦å‘ï¼Œè€Œgitlabï¼Œwechatè¿™äº›clientè¿˜æ²¡æœ‰å®ä¾‹åŒ–ï¼Œæ‰€ä»¥æœ‰æ²¡æœ‰å¯èƒ½å‡ºç°panicï¼Ÿå½“ç„¶äº†ï¼Œè¿™ä¸ªå¯èƒ½æ€§å¾ˆå°ã€‚</p><p>è®©æˆ‘ä»¬å†æ¬¡å›åˆ°main.goä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªhttpæœåŠ¡</span></span><br><span class="line">http.Init(s)</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>Init</code>:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init init</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">(s *service.Service)</span></span> &#123;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªsrvå¾ˆé‡è¦ï¼Œè¿™æ˜¯åœ¨ä¸Šé¢service.New()æœ€åè¿”å›çš„å®ä¾‹ï¼Œåœ¨åé¢ç»å¸¸ç”¨åˆ°</span></span><br><span class="line">srv = s</span><br><span class="line">    <span class="comment">//è¿™ä¸ªpermitæ˜¯go-common/library/net/http/blademaster ä¸­çš„ç»„ä»¶ï¼Œåº”è¯¥æ˜¯ç”¨æ¥åšæ¥å£è®¤è¯çš„</span></span><br><span class="line">authSvc = permit.New2(<span class="literal">nil</span>)</span><br><span class="line"><span class="comment">//ä¸‹é¢å°±æ˜¯å¯åŠ¨http engineäº†ï¼Œè¿™ä¸ªengineå°±æ˜¯ä¸Šé¢æåˆ°çš„è¿™ä¸ªblademaster</span></span><br><span class="line">engine := bm.DefaultServer(conf.Conf.BM)</span><br><span class="line">engine.Ping(ping)</span><br><span class="line">initRouter(engine)</span><br><span class="line"><span class="keyword">if</span> err := engine.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Error(<span class="string">"engine.Start error(%v)"</span>, err)</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸ªhttpæœåŠ¡æ˜¯ä¾èµ–çš„BZå…¬å…±çš„ç»„ä»¶ï¼Œå°±ä¸ç»§ç»­æ·±å…¥äº†ï¼Œæˆ‘æ€•å‡ºä¸æ¥äº†ã€‚æˆ‘ä»¬çœ‹çœ‹<code>initRouter</code>ä¸­å®šä¹‰çš„Routerï¼Œç”±äºå¤ªé•¿ï¼Œæˆ‘åªé€‰æ‹©å¼€å§‹ä¸€æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">version := e.Group(<span class="string">"/ep/admin/saga/v1"</span>, authSvc.Permit2(<span class="string">""</span>))</span><br><span class="line">&#123;</span><br><span class="line">project := version.Group(<span class="string">"/projects"</span>)</span><br><span class="line">&#123;</span><br><span class="line">project.GET(<span class="string">"/favorite"</span>, favoriteProjects)</span><br><span class="line">project.POST(<span class="string">"/favorite/edit"</span>, editFavorite)</span><br><span class="line">project.GET(<span class="string">"/common"</span>, queryCommonProjects)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯å¾ˆå¸¸è§çš„url-mappingäº†ï¼Œè¿™é‡Œçš„<code>favoriteProjects</code>ã€<code>editFavorite</code>ã€<code>queryCommonProjects</code> éƒ½æ˜¯å®šä¹‰åœ¨å½“å‰<code>http</code>åŒ…ä¸‹çš„å‡½æ•°ï¼Œæˆ‘ä»¬é€‰æ‹©<code>favoriteProjects</code>çœ‹ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">favoriteProjects</span><span class="params">(ctx *bm.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">req      = &amp;model.Pagination&#123;&#125;</span><br><span class="line">err      error</span><br><span class="line">userName <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line">    <span class="comment">//è¿™é‡Œåº”è¯¥æ˜¯è§£æè¯·æ±‚å‚æ•°åˆ°reqå˜é‡ä¸­</span></span><br><span class="line"><span class="keyword">if</span> err = ctx.Bind(req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.JSON(<span class="literal">nil</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//è¿™é‡Œæ˜¯è°ƒç”¨å‡½æ•°è·å–å½“å‰ç”¨æˆ·å</span></span><br><span class="line"><span class="keyword">if</span> userName, err = getUsername(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.JSON(<span class="literal">nil</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œæœ€ç»ˆå›åˆ°äº†srvä¸Šï¼Œè°ƒç”¨äº†å®é™…çš„å¤„ç†æ–¹æ³•ã€‚è¿™é‡Œçš„FavoriteProjectså®é™…å°±æ˜¯é€šè¿‡dbæŸ¥è¯¢å½“å‰ç”¨æˆ·æ”¶è—çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°±ä¸ç»§ç»­æ·±å…¥äº†ã€‚</span></span><br><span class="line">ctx.JSON(srv.FavoriteProjects(ctx, req, userName))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆåœ¨<code>http</code>åŒ…ä¸­å°†å‚æ•°ç­‰ä¸€äº›ä¿¡æ¯è¿›è¡Œè§£æï¼Œæœ€åè°ƒç”¨åˆ°äº†<code>service</code>ä¸­çš„æ–¹æ³•ã€‚è¿™ä¸ªå°±å¾ˆåƒJavaä¸­æµè¡Œçš„å†™æ³•ï¼šä»<code>Controller</code>åˆ°<code>Service</code>ï¼Œç¬¦åˆ<code>MVC</code>åˆ†å±‚çš„æ€æƒ³ã€‚</p><p>æœ€åè¿˜æœ‰ä¸€ä¸ªgrpcï¼Œæˆ‘å¤§æ¦‚çœ‹äº†ä¸‹ï¼Œåº”è¯¥æ˜¯ç”¨æ¥ä¼ä¸šå¾®ä¿¡å‘æ¶ˆæ¯çš„ã€‚</p><p>æ€»ç»“ï¼š</p><p>è¿™åº”è¯¥æ˜¯ç”¨æ¥åšgitlab ciå‘Šè­¦ä¹‹ç±»çš„projectï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªprojectå±‚æ¬¡å¾ˆåˆ†æ˜ï¼Œä»£ç çœ‹è¿‡å»ä¸€ç›®äº†ç„¶ã€‚</p><p>æœ€åï¼Œä¹‹å‰è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯<code>reload</code>è¿™ä¸ªå˜é‡ï¼Œåœ¨åˆå§‹åŒ–æ—¶æ˜¯æœ‰é•¿åº¦çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reload = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure><p>é•¿åº¦ä¸º10ï¼Œåœ¨æ¯æ¬¡é…ç½®æ–‡ä»¶ä¿®æ”¹åï¼Œgoroute watchåˆ°eventä¹‹åä¼šå¾€è¿™ä¸ªchannelå†™å…¥ä¸€ä¸ª<code>true</code>ï¼Œä½†æ˜¯çœ‹å®Œæ•´ä¸ªä»£ç ä¹‹åï¼Œå¹¶æ²¡æœ‰çœ‹åˆ°æœ‰åœ°æ–¹ä»è¿™ä¸ªchannelå–å‡ºæ•°æ®ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘æ¼çœ‹äº†ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¿®æ”¹10æ¬¡ä¹‹åï¼Œè¿™ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reload &lt;- <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å°±ä¼šé˜»å¡ï¼Œä»è€Œå¯¼è‡´è¿™ä¸ªgorouteæ— å“åº”ï¼Ÿ</p><p>ç å­—ä¸æ˜“ï¼Œä¸”è½¬ä¸”çæƒœã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡å®Œå…¨å‡ºäºå­¦ä¹ çš„ç›®çš„ï¼Œå¦‚æœ‰å¼‚è®®ï¼Œè¯·è”ç³»åˆ é™¤ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¹‹å‰XLäº‹ä»¶æµå‡ºçš„ä¼˜ç§€ä»£ç å¤ªå¤šäº†ï¼Œè¿™æ¬¡é€‰æ‹©çš„æ˜¯ä¸€ä¸ªå¥½åƒä¸å…·ä½“ä¸šåŠ¡æ— å…³çš„æ¨¡å—(admin-ep-saga)æ¥è¿›è¡Œå­¦ä¹ ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Golangéšè®°" scheme="https://jingzhouzhao.github.io/categories/Golang%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Golang" scheme="https://jingzhouzhao.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€å¼ å›¾è¯´æ˜Golangçš„å¹¶å‘æ¨¡å‹MPG</title>
    <link href="https://jingzhouzhao.github.io/archives/79f4a57c.html"/>
    <id>https://jingzhouzhao.github.io/archives/79f4a57c.html</id>
    <published>2019-09-04T03:10:49.000Z</published>
    <updated>2019-10-16T09:05:40.004Z</updated>
    
    <content type="html"><![CDATA[<p>Golang å¤©ç”Ÿæ”¯æŒå¹¶å‘ï¼ŒGoroutineæ˜¯Go æœ€å¸å¼•äººçš„åœ°æ–¹ï¼Œé‡‡ç”¨çš„æ˜¯CSPå¹¶å‘é€šä¿¡æ¨¡å‹ã€‚åˆ°åº•Goæ˜¯æ€ä¹ˆæ”¯æŒé«˜å¹¶å‘çš„å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦è¯´ä¸€è¯´Golang çš„MPGæ¨¡å‹ã€‚</p><a id="more"></a><ol><li><strong>M</strong> ä»£è¡¨ç€ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ ï¼Œä¸€ä¸ªMå°±æ˜¯ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œgoroutineå°±æ˜¯è·‘åœ¨Mä¹‹ä¸Šçš„</li><li><strong>P</strong> ä»£è¡¨ç€(Processor)å¤„ç†å™¨ï¼Œ å®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œgoroutineçš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªå¯è¿è¡Œçš„goroutineé˜Ÿåˆ—ï¼Œå’Œè‡ªç”±çš„goroutineé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰éœ€è¦å®ƒæ¥æ‰§è¡Œçš„goroutineã€‚</li><li><strong>G</strong> ä»£è¡¨ç€goroutine å®é™…çš„æ•°æ®ç»“æ„ï¼Œå¹¶ç»´æŠ¤è€…goroutine éœ€è¦çš„æ ˆã€ç¨‹åºè®¡æ•°å™¨ä»¥åŠå®ƒæ‰€åœ¨çš„Mç­‰ä¿¡æ¯ã€‚</li><li><strong>Sched</strong> ä»£è¡¨ç€ä¸€ä¸ªè°ƒåº¦å™¨ å®ƒç»´æŠ¤æœ‰å­˜å‚¨ç©ºé—²çš„Mé˜Ÿåˆ—å’Œç©ºé—²çš„Pé˜Ÿåˆ—ï¼Œå¯è¿è¡Œçš„Gé˜Ÿåˆ—ï¼Œè‡ªç”±çš„Gé˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚</li></ol><p>ä¸€å¼ å›¾å°±å¯ä»¥è¯´æ˜MPGæ¨¡å‹ï¼š</p><p><img src="/archives/79f4a57c/1.jpg" alt="MPG"></p><p>å›¾ä¸­çš„â€œåœŸæ‹¨é¼ â€ä»£è¡¨çš„å°±æ˜¯<strong>M</strong>ï¼Œâ€œæ¨è½¦â€ä»£è¡¨çš„æ˜¯<strong>P</strong>ï¼Œâ€œæœ¨å—â€ä»£è¡¨çš„å°±æ˜¯<strong>G</strong>ã€‚åœ¨è¿™å¼ å›¾å¤–è¿˜å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„â€åœŸæ‹¨é¼ â€œè¿™ä¸ªâ€åœŸæ‹¨é¼ â€œå°±æ˜¯â€åŒ…å·¥å¤´â€œ<strong>Sched</strong>ã€‚</p><p><img src="/archives/79f4a57c/2.png" alt="Sched"></p><p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°â€œåœŸæ‹¨é¼ â€œä¸åœåœ°å°†â€œæœ¨å—â€œæ¬è¿åˆ°â€œæ¨è½¦â€œä¸Šï¼Œç„¶åæ¨å»çƒ§ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°â€œåœŸæ‹¨é¼ â€œå› ä¸ºç´¯åäº†ï¼Œè€Œå¤„ç†çš„é€Ÿåº¦å˜æ…¢çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™â€œåŒ…å·¥å¤´â€œå°±å‡ºç°äº†ï¼Œâ€œåŒ…å·¥å¤´â€œéå¸¸ä½“è´´çš„å°†è¿™ä¸ªâ€œåœŸæ‹¨é¼ â€œçš„â€œæ¨è½¦â€œäº¤ç»™å…¶ä»–â€œåœŸæ‹¨é¼ â€œå»å¤„ç†ã€‚å¦‚æœä¸€ä¸ªâ€œåœŸæ‹¨é¼ â€œçš„â€œæ¨è½¦â€œé‡Œé¢çš„â€œæœ¨å—â€œè£…çš„å¤ªå¤šï¼Œâ€œåŒ…å·¥å¤´â€œä¹Ÿä¼šè®©å…¶å®ƒçš„â€œåœŸæ‹¨é¼ â€œå»å¸®å¿™æ‹¿å‡ºä¸€äº›æ¥ã€‚å½“â€œåŒ…å·¥å¤´â€œå‘ç°ç°æœ‰çš„â€œåœŸæ‹¨é¼ â€œå·²ç»å¿™ä¸è¿‡æ¥çš„æ—¶å€™ï¼Œå°±å›å»æ‰¾ä¸€äº›æ–°çš„â€œåœŸæ‹¨é¼ â€œè¿‡æ¥ï¼Œå¹¶ç»™ä»–ä»¬é…å‘â€œæ¨è½¦â€œã€‚ç›´åˆ°æ‰€æœ‰çš„â€œæœ¨å—â€œéƒ½çƒ§å®Œä¸ºæ­¢ã€‚</p><p>ä¸Šé¢è¯´åˆ°çš„å‡ ç§æƒ…å†µï¼š</p><ol><li>â€œåœŸæ‹¨é¼ â€ç´¯åäº†ï¼Œå½¢å®¹çš„æ˜¯IOç­‰è€—æ—¶çš„æ“ä½œã€‚</li><li>å…¶ä»–â€œåœŸæ‹¨é¼ â€å¸®å¿™ï¼Œå½¢å®¹çš„æ˜¯å·¥ä½œçªƒå–ç®—æ³•ï¼ˆwork stealingï¼‰ï¼Œè¿™ä¸ªç®—æ³•åœ¨å¾ˆå¤šè¯­è¨€ä¸­éƒ½æœ‰åº”ç”¨ï¼Œä¾‹å¦‚Javaä¸­çš„Fork/Foinã€‚</li></ol><p>åœ¨Golangä¸­åœŸæ‹¨é¼ é»˜è®¤çš„æ•°é‡æ˜¯CPUçš„æ ¸æ•°ï¼ŒåœŸæ‹¨é¼ é€šè¿‡CSPæ¨¡å‹æ²Ÿé€šã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href="https://zhuanlan.zhihu.com/p/22352969" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/22352969</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Golang å¤©ç”Ÿæ”¯æŒå¹¶å‘ï¼ŒGoroutineæ˜¯Go æœ€å¸å¼•äººçš„åœ°æ–¹ï¼Œé‡‡ç”¨çš„æ˜¯CSPå¹¶å‘é€šä¿¡æ¨¡å‹ã€‚åˆ°åº•Goæ˜¯æ€ä¹ˆæ”¯æŒé«˜å¹¶å‘çš„å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦è¯´ä¸€è¯´Golang çš„MPGæ¨¡å‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Golangéšè®°" scheme="https://jingzhouzhao.github.io/categories/Golang%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Golang" scheme="https://jingzhouzhao.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Go Module å¼•å…¥æœ¬åœ°è‡ªå®šä¹‰åŒ…</title>
    <link href="https://jingzhouzhao.github.io/archives/c8d527a1.html"/>
    <id>https://jingzhouzhao.github.io/archives/c8d527a1.html</id>
    <published>2019-09-04T02:20:49.000Z</published>
    <updated>2019-10-16T09:05:40.004Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æ–‡ç« è½¬è½½è‡³ <a href="http://www.r9it.com/20190611/go-mod-use-dev-package.html#1-å¯ç”¨-go-module" target="_blank" rel="noopener">å°ä¸€è¾ˆæ— äº§é˜¶çº§ç å†œ</a></p></blockquote><p>æœ€è¿‘ç”±äºé¡¹ç›®è¦æ±‚ï¼Œéœ€è¦å¯¹ <code>IPFS</code> æºç è¿›è¡Œä¿®æ”¹ï¼Œç”±äºè‡ªå·±åœ¨æ­¤ä¹‹å‰æ²¡æœ‰æ¥è§¦è¿‡ Go è¯­è¨€ï¼Œåœ¨ä½¿ç”¨ <code>go mod</code> å¯¼å…¥æœ¬åœ°è‡ªå·±å¼€å‘çš„å·¥å…·åŒ…çš„æ—¶å€™æŠ˜è…¾äº†å¥½ä¹…æ‰æå®šã€‚ è®°å½•ä¸€ä¸‹ï¼Œä»¥å¤‡åæœŸæŸ¥é˜…ã€‚ Go è¯­è¨€çš„ Module æ–°ç‰¹æ€§æ˜¯åœ¨ go1.11 çš„å‘å¸ƒä¹‹åæ‰æ”¯æŒçš„ï¼Œè¿™æ˜¯ Go è¯­è¨€æ–°çš„ä¸€å¥—ä¾èµ–ç®¡ç†ç³»ç»Ÿã€‚</p><a id="more"></a><p>æ–‡ç« å¯¼è¯»</p><ul><li><a href="#1-å¯ç”¨-Go-Module">1. å¯ç”¨ Go Module</a></li><li><a href="#2-åˆ›å»º-Go-Module">2. åˆ›å»º Go Module</a></li><li><a href="#3-Go-Module-ç‰ˆæœ¬è§„åˆ™">3. Go Module ç‰ˆæœ¬è§„åˆ™</a></li><li><a href="#4-å¼•å…¥æœ¬åœ°ä¾èµ–åŒ…">4. å¼•å…¥æœ¬åœ°ä¾èµ–åŒ…</a></li><li><a href="#5-ä½¿ç”¨-replace-å°†è¿œç¨‹åŒ…æ›¿æ¢ä¸ºæœ¬åœ°åŒ…æœåŠ¡">5. ä½¿ç”¨ replace å°†è¿œç¨‹åŒ…æ›¿æ¢ä¸ºæœ¬åœ°åŒ…æœåŠ¡</a></li></ul><h1 id="1-å¯ç”¨-Go-Module"><a href="#1-å¯ç”¨-Go-Module" class="headerlink" title="1. å¯ç”¨ Go Module"></a>1. å¯ç”¨ Go Module</h1><p>é¦–å…ˆåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>$GOPATH</code> é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸æ”¯æŒ go mudules çš„ï¼Œå½“ä½ æ‰§è¡Œ <code>go mod init</code> çš„æ—¶å€™ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š</p><blockquote><p>go: modules disabled inside GOPATH/src by GO111MODULE=auto; see â€˜go help modulesâ€™</p></blockquote><p>æˆ‘ä»¬éœ€è¦åœ¨æ‰§è¡Œ <code>go mod</code> å‘½ä»¤ä¹‹å‰ï¼Œå¯¼å‡º <code>GO111MODULE</code> ç¯å¢ƒå˜é‡ï¼Œä½ å¯ä»¥ç›´æ¥ä¸´æ—¶ä¸€æ¬¡æ€§å¯¼å‡ºï¼Œ ä¸ºäº†åé¢æ–¹ä¾¿ï¼Œå»ºè®®ç›´æ¥åœ¨ <code>~/.bashrc</code> æ–‡ä»¶ä¸­å¯¼å‡ºï¼Œ åœ¨æ–‡ä»¶æœ«å°¾åŠ å…¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export GO111MODULE=on</span><br></pre></td></tr></table></figure><p>Bash</p><p>ä»è¿™ä¹Ÿè¡¨æ˜äº† go å°†æ¥æ˜¯è¦åˆ©ç”¨ modules æœºåˆ¶å»æ¶ˆç­ <code>$GOPATH</code> çš„ã€‚</p><h1 id="2-åˆ›å»º-Go-Module"><a href="#2-åˆ›å»º-Go-Module" class="headerlink" title="2. åˆ›å»º Go Module"></a>2. åˆ›å»º Go Module</h1><p>æˆ‘ä»¬ç°åœ¨ <code>$GOPATH</code> ä¸‹é¢å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶åˆå§‹åŒ– module</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir $GOPATH/src/gitee.com/rockyang/testmod -p</span><br><span class="line">cd $GOPATH/src/gitee.com/rockyang/test-gomod</span><br><span class="line">go mod init gitee.com/rockyang/test-gomod</span><br><span class="line">go: creating new go.mod: module gitee.com/rockyang/testmod</span><br></pre></td></tr></table></figure><p>Bash</p><p>è¿™æ—¶ï¼Œæˆ‘ä»¬æ–°å»ºçš„é¡¹ç›®å·²ç»æˆä¸ºäº†ä¸€ä¸ª module äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®ä¸­éšä¾¿å†™å‡ ä¸ªå‡½æ•°å¯¼å‡ºæµ‹è¯•ã€‚</p><p>Note: æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯<a href="https://gitee.com/" target="_blank" rel="noopener">ç äº‘</a>åšé¡¹ç›®æ‰˜ç®¡ï¼Œæ²¡æœ‰ä½¿ç”¨ githubï¼Œå›½å†…ç äº‘ç¡®å®æ¯” github å¿«å¾—å¤šã€‚</p><p>æ¥ä¸‹æ¥ä½ å¯ä»¥é€‰æ‹©æŠŠé¡¹ç›®æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œå¦‚æœä½ çš„ä»“åº“æ˜¯å…¬å¼€çš„è¯ï¼Œåˆ«äººå°±æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>go get</code> å‘½ä»¤å»ä¸‹è½½ä½ çš„é¡¹ç›®äº†ã€‚</p><p>å¦‚æœæ˜¯ç§æœ‰é¡¹ç›®åªæƒ³ç»™å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™ä½ å¯ä»¥å‚è€ƒæˆ‘çš„è¿™ç¯‡åšå®¢çš„åšæ³•ã€‚<a href="http://www.r9it.com/21090611/go-mod-use-private-package.html" target="_blank" rel="noopener">Go Module ä½¿ç”¨ç§æœ‰ä»“åº“ä½œä¸ºé¡¹ç›®ä¾èµ–åŒ…</a></p><h1 id="3-Go-Module-ç‰ˆæœ¬è§„åˆ™"><a href="#3-Go-Module-ç‰ˆæœ¬è§„åˆ™" class="headerlink" title="3. Go Module ç‰ˆæœ¬è§„åˆ™"></a>3. Go Module ç‰ˆæœ¬è§„åˆ™</h1><p>go modules æ˜¯ä¸€ä¸ªç‰ˆæœ¬åŒ–ä¾èµ–ç®¡ç†ç³»ç»Ÿï¼Œç‰ˆæœ¬éœ€è¦éµå¾ªä¸€äº›è§„åˆ™ï¼Œæ‰“å¼€ä¸€ä¸ª <code>go.mod</code> æ–‡ä»¶ï¼Œä½ ä¼šå‘ç°ç±»ä¼¼ä¸‹é¢çš„ä¾èµ–è§„åˆ™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">require (</span><br><span class="line">github.com/filecoin-project/go-leb128 v0.0.0-20190212224330-8d79a5489543</span><br><span class="line">github.com/golang/mock v1.2.0 // indirect</span><br><span class="line">github.com/ipfs/go-bitswap v0.0.2</span><br><span class="line">github.com/libp2p/go-stream-muxer v0.0.1</span><br><span class="line">github.com/minio/blake2b-simd v0.0.0-20160723061019-3f5f724cb5b1</span><br><span class="line">gotest.tools v2.2.0+incompatible // indirect</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Bash</p><p>ä¾èµ–è§„åˆ™ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå‰é¢ä¸€éƒ¨åˆ†æ˜¯åŒ…è·¯å¾„ï¼Œåé¢ä¸€éƒ¨åˆ†è¡¨ç¤ºçš„æ˜¯ç‰ˆæœ¬å·ã€‚ ä½ ä¼šå‘ç°æœ‰ä¸¤ç§ç‰ˆæœ¬å·ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„ git æ ‡ç­¾ï¼Œæ¯”å¦‚ <code>v0.0.2</code>ï¼Œå¦ä¸€ç§å°±æ¯”è¾ƒå¤æ‚ä¸€äº›ï¼Œå®ƒæ˜¯ï¼š<strong>ç‰ˆæœ¬å· + æ—¶é—´æˆ³ +hash</strong> æ¯”å¦‚ï¼š<code>v0.0.0-20190212224330-8d79a5489543</code>ï¼Œå®ƒå…¶å®æ˜¯ç²¾å‡†çš„å¯¹åº”ç€ä¸€ä¸ª <code>git log</code> è®°å½•ï¼Œåé¢çš„å“ˆå¸Œæ˜¯å»æäº¤å“ˆå¸Œçš„å‰ 12 ä½ã€‚</p><p>æ¯”å¦‚æˆ‘å½“å‰çš„æäº¤è®°å½•æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">log</span> </span></span><br><span class="line">commit 4c55783279db32be4f02e193713d5a862b96db85 (HEAD -&gt; master, origin/master)</span><br><span class="line">Author: yangjian &lt;yangjian102621@gmail.com&gt;</span><br><span class="line">Date:   Mon Jun 10 18:34:14 2019 +0800</span><br></pre></td></tr></table></figure><p>Bash</p><p>åˆ™æˆ‘çš„æœ€æ–°ç‰ˆæœ¬å·åº”è¯¥ä¸º <code>v0.0.0-20190610103414-4c55783279db</code></p><h1 id="4-å¼•å…¥æœ¬åœ°ä¾èµ–åŒ…"><a href="#4-å¼•å…¥æœ¬åœ°ä¾èµ–åŒ…" class="headerlink" title="4. å¼•å…¥æœ¬åœ°ä¾èµ–åŒ…"></a>4. å¼•å…¥æœ¬åœ°ä¾èµ–åŒ…</h1><p>å‰é¢é“ºå«äº†è¿™ä¹ˆå¤šï¼Œæ¥ä¸‹æ¥å›åˆ°æˆ‘ä»¬çš„ä¸»é¢˜ï¼Œæˆ‘è¯¥æ€æ ·ä½¿ç”¨æˆ‘ä»¬è‡ªå·±å¼€å‘çš„å·¥å…·åŒ…å‘¢ï¼Ÿ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ–°çš„é¡¹ç›® <code>testmod-demo</code>ï¼Œç°åœ¨æƒ³è¦åœ¨æ–°çš„é¡¹ç›®ä¸­ä½¿ç”¨ testmod ä¸­çš„å·¥å…·åŒ…ï¼Œé‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>go mod</code> åˆå§‹åŒ–è¯¥é¡¹ç›®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd testmod-demo</span><br><span class="line">go mod init gitee.com/rockyang/testmod-demo</span><br></pre></td></tr></table></figure><p>Bash</p><p>åˆå§‹åŒ–ä¹‹åä¼šåœ¨å½“å‰é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ª <code>go.mod</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼å»å¼•å…¥ testmod åŒ…ï¼Œä¸€ç§æ˜¯ç›´æ¥ä¿®æ”¹ <code>go.mod</code> æ–‡ä»¶ï¼Œåœ¨ require é…ç½®ä¸­æ·»åŠ ä¸Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitee.com/rockyang/testmod v0.0.0-20190610103414-4c55783279db</span><br></pre></td></tr></table></figure><p>Bash</p><p>æˆ–è€…ä½¿ç”¨ <code>go mod edit</code> å‘½ä»¤ä¿®æ”¹ä¾èµ–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go mod edit -require="gitee.com/rockyang/testmod@v0.0.0-20190610103414-4c55783279db"</span><br><span class="line">go mod tidy # æ•´ç†ä¾èµ–åŒ…</span><br></pre></td></tr></table></figure><p>Bash</p><h1 id="5-ä½¿ç”¨-replace-å°†è¿œç¨‹åŒ…æ›¿æ¢ä¸ºæœ¬åœ°åŒ…æœåŠ¡"><a href="#5-ä½¿ç”¨-replace-å°†è¿œç¨‹åŒ…æ›¿æ¢ä¸ºæœ¬åœ°åŒ…æœåŠ¡" class="headerlink" title="5. ä½¿ç”¨ replace å°†è¿œç¨‹åŒ…æ›¿æ¢ä¸ºæœ¬åœ°åŒ…æœåŠ¡"></a>5. ä½¿ç”¨ replace å°†è¿œç¨‹åŒ…æ›¿æ¢ä¸ºæœ¬åœ°åŒ…æœåŠ¡</h1><p>è¿™æ—¶å¦‚æœä½ æ‰§è¡Œ <code>go build</code> çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ° <code>gitee.com/rockyang/testmod</code>ï¼Œæ˜¯å› ä¸ºä½ æ²¡æœ‰æŠŠä»“åº“æ¨é€åˆ°è¿œç¨‹ï¼Œæ‰€ä»¥æ— æ³•ä¸‹è½½ã€‚ go module æä¾›äº†å¦å¤–ä¸€ä¸ªæ–¹æ¡ˆ, ä½¿ç”¨ replace, ç¼–è¾‘ go.mod æ–‡ä»¶ï¼Œåœ¨æœ€åé¢æ·»åŠ ï¼š<code>replace gitee.com/rockyang/testmod =&gt; /gopath/src/gitee.com/rockyang/testmod</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module gitee.com/rockyang/testmod-demo</span><br><span class="line"></span><br><span class="line">go 1.12</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">    github.com/gin-gonic/gin v1.3.0</span><br><span class="line">gitee.com/rockyang/testmod@v0.0.0-20190610103414-4c55783279db</span><br><span class="line">    golang.org/x/net v0.0.0-20190320064053-1272bf9dcd53 // indirect</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">replace gitee.com/rockyang/testmod =&gt; /gopath/src/gitee.com/rockyang/testmod</span><br></pre></td></tr></table></figure><p>Bash</p><blockquote><p>è¿™é‡Œçš„ /gopath/src/gitee.com/rockyang/testmod æ˜¯æœ¬åœ°çš„åŒ…è·¯å¾„</p></blockquote><p>ç„¶åå†æ‰§è¡Œ <code>go build</code> ä½ ä¼šçœ‹åˆ°ä½ æƒ³è¦çš„ç»“æœã€‚</p><hr><p>ä»¥ä¸Šä¸ºåŸä½œè€…åŸæ–‡ï¼Œè½¬è½½è¿™ç¯‡æ–‡ç« çš„åŸå› æ˜¯å› ä¸ºGolang1.13å‘å¸ƒäº†ï¼Œçœ‹åˆ°äº†å…¶ä¸­ä¸€ä¸ªæ–°ç‰¹æ–°<a href="https://tip.golang.org/cmd/go/#hdr-Module_configuration_for_non_public_modules" target="_blank" rel="noopener"><code>GOPRIVATE</code></a> å¯ä»¥æ­é… <a href="https://tip.golang.org/cmd/go/#hdr-Module_downloading_and_verification" target="_blank" rel="noopener"><code>GOPROXY</code></a> å¯¹ç§æœ‰æ¨¡å—æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æ–‡ç« è½¬è½½è‡³ &lt;a href=&quot;http://www.r9it.com/20190611/go-mod-use-dev-package.html#1-å¯ç”¨-go-module&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å°ä¸€è¾ˆæ— äº§é˜¶çº§ç å†œ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ€è¿‘ç”±äºé¡¹ç›®è¦æ±‚ï¼Œéœ€è¦å¯¹ &lt;code&gt;IPFS&lt;/code&gt; æºç è¿›è¡Œä¿®æ”¹ï¼Œç”±äºè‡ªå·±åœ¨æ­¤ä¹‹å‰æ²¡æœ‰æ¥è§¦è¿‡ Go è¯­è¨€ï¼Œåœ¨ä½¿ç”¨ &lt;code&gt;go mod&lt;/code&gt; å¯¼å…¥æœ¬åœ°è‡ªå·±å¼€å‘çš„å·¥å…·åŒ…çš„æ—¶å€™æŠ˜è…¾äº†å¥½ä¹…æ‰æå®šã€‚ è®°å½•ä¸€ä¸‹ï¼Œä»¥å¤‡åæœŸæŸ¥é˜…ã€‚ Go è¯­è¨€çš„ Module æ–°ç‰¹æ€§æ˜¯åœ¨ go1.11 çš„å‘å¸ƒä¹‹åæ‰æ”¯æŒçš„ï¼Œè¿™æ˜¯ Go è¯­è¨€æ–°çš„ä¸€å¥—ä¾èµ–ç®¡ç†ç³»ç»Ÿã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Golangéšè®°" scheme="https://jingzhouzhao.github.io/categories/Golang%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Golang" scheme="https://jingzhouzhao.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Pythonå®ç°å›¾åƒæ–‡å­—è¯†åˆ«</title>
    <link href="https://jingzhouzhao.github.io/archives/99680cca.html"/>
    <id>https://jingzhouzhao.github.io/archives/99680cca.html</id>
    <published>2019-09-03T08:46:36.000Z</published>
    <updated>2019-10-16T09:05:40.010Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨çš„å®é™…æ˜¯tesseractè¿™ä¸ªOCRå¼•æ“ã€‚å¦‚æœè¯†åˆ«çš„æœ‰ä¸­æ–‡ï¼Œéœ€è¦æ·»åŠ ä¸­æ–‡çš„<a href="https://github.com/tesseract-ocr/tessdata/raw/4.00/chi_sim.traineddata" target="_blank" rel="noopener">chi_sim.traineddata</a>ã€‚</p><p>æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯windowsï¼Œä¸‹è½½æ˜¯<a href="http://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-setup-4.00.00dev.exe" target="_blank" rel="noopener">Windows Installer made with MinGW-w64</a>ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­æ³¨æ„æœ‰ä¸ªé€‰é¡¹ï¼Œå±•å¼€å¯ä»¥çœ‹åˆ°å„ç§è¯­è¨€çš„æ•°æ®ï¼Œå‹¾ä¸Šchi_sim.traineddataå³å¯ã€‚</p><a id="more"></a><p>æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯Python3.7ï¼Œé¦–å…ˆå®‰è£…å¿…å¤‡çš„ä¾èµ–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pytesseract</span><br><span class="line">pip install pillow</span><br></pre></td></tr></table></figure><p>æˆ‘ä½¿ç”¨çš„Pycharmï¼Œç›´æ¥Alt+Enterå¯¼å…¥ã€‚</p><p>å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import pytesseract</span><br><span class="line">from PIL import Image</span><br><span class="line"></span><br><span class="line">image &#x3D; Image.open(&quot;..&#x2F;pic&#x2F;c.png&quot;)</span><br><span class="line">code &#x3D; pytesseract.image_to_string(image,lang&#x3D;&quot;chi_sim&quot;,config&#x3D;&quot;-psm 6&quot;)</span><br><span class="line">print(code)</span><br></pre></td></tr></table></figure><p>ç›´æ¥è¿è¡Œå¯èƒ½ä¼šæŠ¥é”™ï¼Œä¼šæç¤º<code>tesseract</code>è¯†åˆ«ä¸äº†ï¼Œæˆ‘çœ‹åˆ°å…¶ä»–äººéƒ½æ˜¯ç›´æ¥ä¿®æ”¹pytesseractæºæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tesseract_cmd &#x3D; &#39;C:\Program Files (x86)\Tesseract-OCR\tesseract.exe&#39;</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œçš„åšæ³•æ˜¯å°†<code>C:\Program Files (x86)\Tesseract-OCR\</code>æ·»åŠ åˆ°ç¯å¢ƒå˜é‡PATHä¸­ã€‚</p><p>æœ‰å¯èƒ½ä¸ä¼šç”Ÿæ•ˆï¼Œéœ€è¦é‡å¯Pycharmã€‚</p><p>OCRè¯†åˆ«ä¸æ˜¯100%å‡†ç¡®ï¼Œæˆ‘è¿™é‡Œæµ‹è¯•çš„ç»“æœæ˜¯ï¼Œå¯èƒ½ä¼šå¤šæˆ–è€…å°‘ä¸€äº›å­—ç¬¦ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href="https://blog.csdn.net/github_33304260/article/details/79155154" target="_blank" rel="noopener">https://blog.csdn.net/github_33304260/article/details/79155154</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½¿ç”¨çš„å®é™…æ˜¯tesseractè¿™ä¸ªOCRå¼•æ“ã€‚å¦‚æœè¯†åˆ«çš„æœ‰ä¸­æ–‡ï¼Œéœ€è¦æ·»åŠ ä¸­æ–‡çš„&lt;a href=&quot;https://github.com/tesseract-ocr/tessdata/raw/4.00/chi_sim.traineddata&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;chi_sim.traineddata&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯windowsï¼Œä¸‹è½½æ˜¯&lt;a href=&quot;http://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-setup-4.00.00dev.exe&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Windows Installer made with MinGW-w64&lt;/a&gt;ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­æ³¨æ„æœ‰ä¸ªé€‰é¡¹ï¼Œå±•å¼€å¯ä»¥çœ‹åˆ°å„ç§è¯­è¨€çš„æ•°æ®ï¼Œå‹¾ä¸Šchi_sim.traineddataå³å¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Pythonéšè®°" scheme="https://jingzhouzhao.github.io/categories/Python%E9%9A%8F%E8%AE%B0/"/>
    
    
      <category term="Python" scheme="https://jingzhouzhao.github.io/tags/Python/"/>
    
      <category term="OCR" scheme="https://jingzhouzhao.github.io/tags/OCR/"/>
    
  </entry>
  
</feed>
