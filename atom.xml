<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å¤ªé˜³å½“ç©ºèµµçš„ä¸ªäººåšå®¢</title>
  
  
  <link href="https://jingzhouzhao.github.io/atom.xml" rel="self"/>
  
  <link href="https://jingzhouzhao.github.io/"/>
  <updated>2022-02-22T07:31:09.008Z</updated>
  <id>https://jingzhouzhao.github.io/</id>
  
  <author>
    <name>å¤ªé˜³å½“ç©ºèµµ</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>JavaåŒäº²å§”æ´¾æœºåˆ¶çš„å¦™ç”¨</title>
    <link href="https://jingzhouzhao.github.io/archives/27ffa58c.html"/>
    <id>https://jingzhouzhao.github.io/archives/27ffa58c.html</id>
    <published>2022-02-09T09:33:21.000Z</published>
    <updated>2022-02-22T07:31:09.008Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨é¡¹ç›®ä¸­çœ‹åˆ°ä¸€æ®µé€šè¿‡easyexcelå¯¼å‡ºåŠ¨æ€è¡¨å¤´çš„å®ç°ï¼Œå¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯easyexcelå®˜æ–¹çš„å®ç°ï¼Œå…¶ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†åŠ¨æ€è¡¨å¤´ä¸Šä¼ è‡³ThreadLocal</span></span><br><span class="line">saveToThreadLocal(clz, result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">saveToThreadLocal</span><span class="params">(Class&lt;T&gt; clz, List&lt;String&gt; result)</span> </span>&#123;</span><br><span class="line">        Map&lt;Class,List&lt;String&gt;&gt; paramMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        paramMap.put(clz, result);</span><br><span class="line">        ThreadLocalUtil.FIELD_CACHE_MAP.set(paramMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><p>å…¶ä¸­resultæ˜¯é€šè¿‡æ¥å£æ‹¿åˆ°çš„ç”¨æˆ·è¡¨å¤´é…ç½®ï¼Œæˆ‘çœ‹åˆ°æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿:<code>ThreadLocalUtil</code>ï¼Œä»¥ä¸ºæ˜¯easyexcelçš„å®ç°ï¼Œåˆ°githubæŸ¥æ‰¾äº†ä¸€ç•ªï¼Œç»“æœä»€ä¹ˆä¹Ÿæ²¡æœ‰å‘ç°ã€‚<br>ideaç‚¹è¿›å»æŸ¥çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°æ˜¯å†…éƒ¨çš„ä¸€ä¸ªå®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Map&lt;Class,List&lt;String&gt;&gt;&gt; FIELD_CACHE_MAP = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;SoftReference&lt;FieldCache&gt;&gt; CACHE = <span class="keyword">new</span> ThreadLocal();&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶è¿˜å‘ç°äº†ä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š<br><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/jqsaj8j3tv-1644455538154.png"></p><p>ä¸€å¼€å§‹æˆ‘çš„æƒ³æ³•æ˜¯ï¼Œè¿™å‡ ä¸ªæ–‡ä»¶åº”è¯¥æ˜¯easyexcelé¢„ç•™çš„æ‰©å±•ï¼Œåªéœ€è¦ç»§æ‰¿æŸäº›çˆ¶ç±»ï¼Œé‡å†™å‡ ä¸ªæ–¹æ³•å°±è¡Œäº†ã€‚ä½†æ˜¯è¿™æ ·ä¸€æ¥ï¼Œè‚¯å®šéœ€è¦æœ‰ä»€ä¹ˆåœ°æ–¹é…ç½®ï¼Œç±»ä¼¼SPIä¸€æ ·ã€‚<br>äºæ˜¯æˆ‘é€šè¿‡ä¸Šé¢çš„æ–‡ä»¶ååœ¨é¡¹ç›®ä¸­æŸ¥æ‰¾ï¼Œç»“æœä»€ä¹ˆä¹Ÿæ²¡æœ‰æ‰¾åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢å‡ ä¸ªæ–‡ä»¶è·Ÿeasyexcelå¹¶æ²¡æœ‰äº§ç”Ÿä»€ä¹ˆè”ç³»ã€‚é‚£ä¸ºä»€ä¹ˆé€šè¿‡è¿™å‡ ä¸ªæ–‡ä»¶å°±èƒ½å®ç°å¯¼å‡ºåŠ¨æ€è¡¨å¤´å‘¢ï¼Ÿ<br>æ²¡åŠæ³•ï¼Œåªèƒ½debugäº†ï¼Œè¿™æ—¶æˆ‘å‘ç°åœ¨easyexcelåŒ…ä¸­ä¹Ÿæœ‰ä¸€ä¸ª<code>ExcelHeadProperty</code>ï¼Œè·Ÿä¸Šé¢è¯´çš„é‚£ä¸ªæ–‡ä»¶å¹¶ä¸æ˜¯åŒä¸€ä¸ªã€‚åœ¨ideaä¸­å¯¼èˆªåˆ°çš„æ˜¯easyexcelä¸­çš„classï¼Œä½†æ˜¯å®é™…æ‰§è¡Œçš„å´ä¸æ˜¯ã€‚</p><p>ä»”ç»†ä¸€çœ‹ï¼Œå‘ç°è¿™ä¸¤ä¸ªæ–‡ä»¶é™¤äº†å†…å®¹ä¸ä¸€æ ·ï¼ŒåŒ…åæ˜¯å®Œå…¨ä¸€æ ·çš„:<code>com.alibaba.excel.metadata.property</code>ï¼Œè¿™æ—¶æˆ‘æƒ³åˆ°äº†Javaçš„åŒäº²å§”æ´¾æœºåˆ¶ã€‚è€Œé¡¹ç›®åˆå¹¶ä¸æ˜¯ç›´æ¥ä¾èµ–çš„easyexcelï¼Œæ˜¯é€šè¿‡é—´æ¥ä¾èµ–è¿›æ¥çš„ã€‚<br>æ‰€ä»¥è¢«æ”¹å†™è¿‡çš„ExcelHeadProperty å…ˆäºeasyexcelæœ¬èº«çš„æ–‡ä»¶è¢«åŠ è½½ï¼Œç­‰åˆ°åŠ è½½easyexcelä¸­çš„ç›¸åŒclassæ—¶ï¼Œå‘ç°å·²ç»è¢«åŠ è½½è¿‡äº†ã€‚ä¸åœ¨åŠ è½½äº†ã€‚</p><p>ç„¶åæˆ‘åˆåœ¨é¡¹ç›®ä¸­åŠ äº†ä¸€ä¸ªç›¸åŒçš„æ–‡ä»¶ï¼Œç®€å•ä¿®æ”¹äº†ä¸€ä¸‹ï¼Œå‘ç°é¡¹ç›®ä¸­çš„classåŠ è½½ä¼˜å…ˆçº§æ›´é«˜ï¼Œclassåˆä¸€æ¬¡è¢«æ”¹å†™äº†ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/ouijzqwan9-1644455655792.png"></p><p>ä¸å¾—ä¸è¯´ï¼Œå¦™å•Šï¼</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ€è¿‘åœ¨é¡¹ç›®ä¸­çœ‹åˆ°ä¸€æ®µé€šè¿‡easyexcelå¯¼å‡ºåŠ¨æ€è¡¨å¤´çš„å®ç°ï¼Œå¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯easyexcelå®˜æ–¹çš„å®ç°ï¼Œå…¶ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//å°†åŠ¨æ€è¡¨å¤´ä¸Šä¼ è‡³ThreadLocal&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;saveToThreadLocal(clz, result);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &amp;lt;T&amp;gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;saveToThreadLocal&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Class&amp;lt;T&amp;gt; clz, List&amp;lt;String&amp;gt; result)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Map&amp;lt;Class,List&amp;lt;String&amp;gt;&amp;gt; paramMap = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap&amp;lt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        paramMap.put(clz, result);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ThreadLocalUtil.FIELD_CACHE_MAP.set(paramMap);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
    <category term="åŒäº²å§”æ´¾" scheme="https://jingzhouzhao.github.io/tags/%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE/"/>
    
  </entry>
  
  <entry>
    <title>åŒäº‹é—®äº†æˆ‘ä¸€ä¸ªå…³äºRocketMQçš„é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/92571797.html"/>
    <id>https://jingzhouzhao.github.io/archives/92571797.html</id>
    <published>2022-01-14T05:42:36.000Z</published>
    <updated>2022-02-22T07:31:09.023Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åŒäº‹çªç„¶é—®æˆ‘ï¼šRocketMQçš„ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¤šæ¬¡æ¶ˆè´¹é‡è¯•ï¼Œæ¶ˆæ¯çš„msgIdä¼šä¸ä¼šå˜ï¼Ÿå“ªæ€•å·²ç»è¿›äº†DLQã€‚</p></blockquote><p>åˆšå¼€å§‹å‡ºäºç»éªŒï¼Œæˆ‘è¯´ä¸ä¼šå˜ã€‚å› ä¸ºæˆ‘ä¹‹å‰æ¯æ¬¡æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œç”¨åŒä¸€ä¸ªmsgIdéƒ½èƒ½æ‰¾åˆ°å¤šæ¬¡é‡è¯•æ¶ˆè´¹çš„æ—¥å¿—ã€‚åæ¥ä¸ºäº†æ›´åŠ ç¡®å®šï¼Œæˆ‘å·äº†ä¸€ä¸‹æºç ï¼Œæˆ‘çœ‹çš„æ˜¯4.6.1ï¼Œä¸€æ˜¯å› ä¸ºå…¬å¸ç”¨çš„è¿™ä¸ªç‰ˆæœ¬ï¼ŒäºŒæ˜¯æˆ‘ä¸Šæ¬¡å·çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬ã€‚ã€‚ã€‚</p><h2 id="æ¶ˆæ¯é‡è¯•"><a href="#æ¶ˆæ¯é‡è¯•" class="headerlink" title="æ¶ˆæ¯é‡è¯•"></a>æ¶ˆæ¯é‡è¯•</h2><p>æ—¢ç„¶è·Ÿé‡è¯•æœ‰å…³ï¼Œé‚£å°±ä»å®¢æˆ·ç«¯æ¶ˆè´¹å¤±è´¥çš„é€»è¾‘å¼€å§‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°è››ä¸é©¬è¿¹ï¼Œä¸‹é¢æ˜¯æ¶ˆè´¹å¤±è´¥å°†æ¶ˆæ¯å‘å›brokerçš„ä»£ç ï¼š</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService</span><br><span class="line"><span class="keyword">case</span> CLUSTERING:</span><br><span class="line">                List&lt;MessageExt&gt; msgBackFailed = <span class="keyword">new</span> ArrayList&lt;MessageExt&gt;(consumeRequest.getMsgs().size());</span><br><span class="line">                <span class="comment">//æ¶ˆè´¹å¤±è´¥ackIndex=-1</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</span><br><span class="line">                    MessageExt msg = consumeRequest.getMsgs().get(i);</span><br><span class="line">                    <span class="keyword">boolean</span> result = <span class="keyword">this</span>.sendMessageBack(msg, context);</span><br><span class="line">                    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">                        msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</span><br><span class="line">                        msgBackFailed.add(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆè´¹å¤±è´¥ä¼šè°ƒç”¨<code>sendMessageBack</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService#sendMessageBack</span><br><span class="line">org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl#sendMessageBack</span><br><span class="line">org.apache.rocketmq.client.impl.MQClientAPIImpl#consumerSendMessageBack</span><br><span class="line"> ConsumerSendMsgBackRequestHeader requestHeader = <span class="keyword">new</span> ConsumerSendMsgBackRequestHeader();</span><br><span class="line">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</span><br><span class="line"></span><br><span class="line">        requestHeader.setGroup(consumerGroup);</span><br><span class="line">        requestHeader.setOriginTopic(msg.getTopic());</span><br><span class="line">        requestHeader.setOffset(msg.getCommitLogOffset());</span><br><span class="line">        <span class="comment">//è¿™ä¸ªæ˜¯å»¶è¿Ÿçº§åˆ«å¯¹åº”brokerçš„é‚£16ä¸ªtaskï¼Œæ˜¯å¯ä»¥é€šè¿‡ConsumeConcurrentlyContext è®¾ç½®çš„ï¼Œé»˜è®¤æ˜¯æŒ‰Brokerçš„ç­–ç•¥</span></span><br><span class="line">        requestHeader.setDelayLevel(delayLevel);</span><br><span class="line">        requestHeader.setOriginMsgId(msg.getMsgId());</span><br><span class="line">        requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</span><br><span class="line"></span><br><span class="line">        RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class="keyword">this</span>.clientConfig.isVipChannelEnabled(), addr),</span><br><span class="line">            request, timeoutMillis);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç»™Brokerå‘äº†ä¸€ä¸ªRequestCode.CONSUMER_SEND_MSG_BACKï¼Œç„¶åé™„å¸¦äº†ä¸€äº›offsetï¼ŒoriginMsgIdç­‰ä¿¡æ¯ï¼Œå¼€å§‹æˆ‘ä»¥ä¸ºè·Ÿè¿™ä¸ªoriginMsgIdæœ‰å…³ï¼Œå› ä¸ºä»–è¿™é‡ŒæŠŠåŸå§‹çš„msgIdå‘å›å»äº†å‘€ï¼Œæ‰€ä»¥msgIdå°±ä¸ä¼šå˜ï¼Œç„¶è€Œäº‹å®ä¸æ˜¯è¿™æ ·çš„ã€‚ç»§ç»­çœ‹åˆ°brokerå¤„ç†éƒ¨åˆ†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncConsumerSendMsgBack</span></span><br><span class="line">        String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</span><br><span class="line">        MessageExt msgExt = <span class="keyword">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</span><br><span class="line"></span><br><span class="line">        MessageExtBrokerInner msgInner = <span class="keyword">new</span> MessageExtBrokerInner();</span><br><span class="line">        msgInner.setTopic(newTopic);</span><br><span class="line">        </span><br><span class="line">        String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</span><br><span class="line">        MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</span><br><span class="line">        CompletableFuture&lt;PutMessageResult&gt; putMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().asyncPutMessage(msgInner);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç”±äºä»£ç å¤ªé•¿ï¼Œçœç•¥äº†ä¸€äº›ã€‚å¯ä»¥çœ‹åˆ°ä¸Šé¢è¯´çš„requestä¸­çš„originMsgIdå¹¶æ²¡æœ‰ç”¨ï¼Œè€Œæ˜¯é€šè¿‡offsetç›´æ¥å®šä½åˆ°æ¶ˆæ¯ç›´æ¥æ‹¿çš„msgIdï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡é‚£ä¹ˆæ˜¯ä»Propertiesä¸­å–çš„PROPERTY_ORIGIN_MESSAGE_IDï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªè·ŸmsgIdä¹Ÿæ²¡æœ‰å…³ç³»å‘€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘çŒœæµ‹ï¼Œæ˜¯ä¸æ˜¯åœ¨æäº¤åˆ°commitlogçš„æ—¶å€™å°†msgIdé‡ç½®ä¸ºäº†originMsgIdï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.store.CommitLog#putMessage</span></span><br><span class="line">   <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">                    msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                topic = ScheduleMessageService.SCHEDULE_TOPIC;</span><br><span class="line">                queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Backup real topic, queueId</span></span><br><span class="line">                MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">                MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">                msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line"></span><br><span class="line">                msg.setTopic(topic);</span><br><span class="line">                msg.setQueueId(queueId);</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"> result = mappedFile.appendMessage(msg, <span class="keyword">this</span>.appendMessageCallback);</span><br></pre></td></tr></table></figure><p>ç”±äºé‡è¯•éœ€è¦å»¶è¿Ÿå¤„ç†ï¼Œæ‰€ä»¥æ¶ˆæ¯åˆè¢«æŠ•é€’åˆ°äº†SCHEDULE_TOPICï¼ˆSCHEDULE_TOPIC_XXXXï¼‰ï¼Œç»§ç»­çœ‹å†™å…¥commitlogéƒ¨åˆ†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.store.CommitLog.DefaultAppendMessageCallback#doAppend(long, java.nio.ByteBuffer, int, org.apache.rocketmq.store.MessageExtBrokerInner)</span></span><br><span class="line"> String msgId;</span><br><span class="line">            <span class="keyword">if</span> ((sysflag &amp; MessageSysFlag.STOREHOSTADDRESS_V6_FLAG) == <span class="number">0</span>) &#123;</span><br><span class="line">                msgId = MessageDecoder.createMessageId(<span class="keyword">this</span>.msgIdMemory, msgInner.getStoreHostBytes(storeHostHolder), wroteOffset);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                msgId = MessageDecoder.createMessageId(<span class="keyword">this</span>.msgIdV6Memory, msgInner.getStoreHostBytes(storeHostHolder), wroteOffset);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œåˆä¸€æ¬¡é”™äº†ï¼ŒmsgIdå¹¶æ²¡æœ‰è¢«é‡ç½®ä¸ºoriginMsgIdï¼Œè€Œæ˜¯é€šè¿‡hostå’Œå†™å…¥çš„offsetç®—å‡ºæ¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸€æ¬¡é‡è¯•ï¼Œé‡æ–°å†™å…¥commitlogï¼ŒmsgIdéƒ½ä¼šå˜ã€‚ã€‚ã€‚è¿™ä¸‹æˆ‘é¢“äº†ï¼Œéš¾é“æˆ‘è·ŸåŒäº‹è¯´é”™äº†ï¼Ÿå¯æ˜¯æˆ‘ä»¥å‰æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œæ˜æ˜æ¯æ¬¡éƒ½æ˜¯ä¸€æ ·çš„å•Šï¼Ÿ</p><h2 id="å†æ¬¡æ¶ˆè´¹"><a href="#å†æ¬¡æ¶ˆè´¹" class="headerlink" title="å†æ¬¡æ¶ˆè´¹"></a>å†æ¬¡æ¶ˆè´¹</h2><p>ä¸è¡Œï¼Œè¿˜å¾—ç»§ç»­å·ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘åœ¨æƒ³ï¼Œéš¾ä¸æˆæ˜¯åœ¨é‡æ–°æ¶ˆè´¹çš„æ—¶å€™åšäº†å•¥å¤„ç†ï¼Ÿæ¥çœ‹çœ‹æ¶ˆè´¹è€…çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.client.consumer.PullCallback#onSuccess</span></span><br><span class="line"><span class="comment">//org.apache.rocketmq.client.impl.consumer.PullAPIWrapper#processPullResult</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PullResult <span class="title">processPullResult</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> PullResult pullResult,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SubscriptionData subscriptionData)</span> </span>&#123;</span><br><span class="line">        PullResultExt pullResultExt = (PullResultExt) pullResult;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</span><br><span class="line">        <span class="keyword">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</span><br><span class="line">            ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</span><br><span class="line">            List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</span><br><span class="line"></span><br><span class="line">            List&lt;MessageExt&gt; msgListFilterAgain = msgList;</span><br><span class="line">            <span class="keyword">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</span><br><span class="line">                msgListFilterAgain = <span class="keyword">new</span> ArrayList&lt;MessageExt&gt;(msgList.size());</span><br><span class="line">                <span class="keyword">for</span> (MessageExt msg : msgList) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (msg.getTags() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</span><br><span class="line">                            msgListFilterAgain.add(msg);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hasHook()) &#123;</span><br><span class="line">                FilterMessageContext filterMessageContext = <span class="keyword">new</span> FilterMessageContext();</span><br><span class="line">                filterMessageContext.setUnitMode(unitMode);</span><br><span class="line">                filterMessageContext.setMsgList(msgListFilterAgain);</span><br><span class="line">                <span class="keyword">this</span>.executeHook(filterMessageContext);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MessageExt msg : msgListFilterAgain) &#123;</span><br><span class="line">                String traFlag = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">                <span class="keyword">if</span> (Boolean.parseBoolean(traFlag)) &#123;</span><br><span class="line">                    msg.setTransactionId(msg.getProperty(MessageConst.PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX));</span><br><span class="line">                &#125;</span><br><span class="line">                MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</span><br><span class="line">                    Long.toString(pullResult.getMinOffset()));</span><br><span class="line">                MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</span><br><span class="line">                    Long.toString(pullResult.getMaxOffset()));</span><br><span class="line">                msg.setBrokerName(mq.getBrokerName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pullResultExt.setMsgFoundList(msgListFilterAgain);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pullResultExt.setMessageBinary(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pullResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¼€å§‹çœ‹åˆ°<code>msg.setTransactionId</code>è¿™ä¸ªï¼Œè¿˜å¼€å¿ƒäº†ä¸€ä¸‹ï¼Œæƒ³ç€æ‰¾æ‰¾<code>setMsgId</code>ï¼Œç»“æœè¿˜æ˜¯æ²¡æœ‰ã€‚<br>éš¾ä¸æˆåœ¨æ¶ˆè´¹æœåŠ¡ä¸­å¤„ç†çš„ï¼Ÿå¼€å§‹ç»§ç»­çœ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService.ConsumeRequest#run</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;the message queue not be able to consume, because it&#x27;s dropped. group=&#123;&#125; &#123;&#125;&quot;</span>, ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, <span class="keyword">this</span>.messageQueue);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.messageListener;</span><br><span class="line">            ConsumeConcurrentlyContext context = <span class="keyword">new</span> ConsumeConcurrentlyContext(messageQueue);</span><br><span class="line">            ConsumeConcurrentlyStatus status = <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">            defaultMQPushConsumerImpl.resetRetryAndNamespace(msgs, defaultMQPushConsumer.getConsumerGroup());</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™ä¸ª<code>defaultMQPushConsumerImpl.resetRetryAndNamespace</code>ï¼Œæˆ‘æ¿€åŠ¨åäº†ï¼Œæ‰“å¼€ä¸€çœ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String groupTopic = MixAll.getRetryTopic(consumerGroup);</span><br><span class="line">       <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">           String retryTopic = msg.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</span><br><span class="line">           <span class="keyword">if</span> (retryTopic != <span class="keyword">null</span> &amp;&amp; groupTopic.equals(msg.getTopic())) &#123;</span><br><span class="line">               msg.setTopic(retryTopic);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (StringUtils.isNotEmpty(<span class="keyword">this</span>.defaultMQPushConsumer.getNamespace())) &#123;</span><br><span class="line">               msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), <span class="keyword">this</span>.defaultMQPushConsumer.getNamespace()));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>è¿™å•¥å‘€è¿™æ˜¯ï¼Œä¹Ÿä¸å¯¹ã€‚åæ¥ç›´åˆ°æˆ‘è¿›å…¥äº†<code>MessageExt</code>, ideaæ˜¾ç¤ºäº†è¿™ä¹ˆä¸€ä¸ªå›¾æ ‡ï¼š<br><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/2stcr97lkc-1642143607868.png"><br>æˆ‘æ„è¯†åˆ°äº‹æƒ…ä¸å¯¹åŠ²ï¼Œæˆ‘å¯èƒ½åšäº†å¾ˆå¤šæ— ç”¨åŠŸï¼Œå¿˜è®°äº† Javaé¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€çš„<code>ç»§æ‰¿</code>:<br><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/l4e3t74lja-1642143701745.png"><br>ç­”æ¡ˆå°±è—åœ¨<code>MessageClientExt</code>ä¸­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageClientExt</span> <span class="keyword">extends</span> <span class="title">MessageExt</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOffsetMsgId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getMsgId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOffsetMsgId</span><span class="params">(String offsetMsgId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setMsgId(offsetMsgId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsgId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String uniqID = MessageClientIDSetter.getUniqID(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (uniqID == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getOffsetMsgId();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> uniqID;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsgId</span><span class="params">(String msgId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//DO NOTHING</span></span><br><span class="line">        <span class="comment">//MessageClientIDSetter.setUniqID(this);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> WTFï¼Œæˆ‘ä¸€ç›´ç›¯ç€setMsgIdï¼Œä»¥ä¸ºæ˜¯å“ªä¸ªåœ°æ–¹æŠŠmsgIdé‡ç½®äº†ï¼Œæ²¡æƒ³åˆ°ï¼Œä»–å¨˜çš„æ˜¯getMsgIdæ–¹æ³•è¢«é‡å†™äº†ã€‚<br> ä»è¿™é‡Œå¯ä»¥å¾—çŸ¥ä¸¤ä¸ªä¸œè¥¿ï¼š<br> <code>OffsetMsgId</code>ï¼šå¯¹åº”commitLog offsetçš„ï¼Œæ¯æ¬¡éƒ½ä¼šå˜çš„ç‰©ç†msgId<br> <code>uniqID</code>ï¼šå¯¹åº”Propertyä¸­çš„UNIQ_KEYï¼Œçœ‹æ¥ä¸å˜çš„æ˜¯è¿™ä¸ªã€‚</p><p>é‚£UNIQ_KEYåˆ°åº•æ˜¯å•¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] ip;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ip = UtilAll.getIP();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ip = createFakeIP();</span><br><span class="line">        &#125;</span><br><span class="line">        LEN = ip.length + <span class="number">2</span> + <span class="number">4</span> + <span class="number">4</span> + <span class="number">2</span>;</span><br><span class="line">        ByteBuffer tempBuffer = ByteBuffer.allocate(ip.length + <span class="number">2</span> + <span class="number">4</span>);</span><br><span class="line">        tempBuffer.put(ip);</span><br><span class="line">        tempBuffer.putShort((<span class="keyword">short</span>) UtilAll.getPid());</span><br><span class="line">        tempBuffer.putInt(MessageClientIDSetter.class.getClassLoader().hashCode());</span><br><span class="line">        FIX_STRING = UtilAll.bytes2string(tempBuffer.array());</span><br><span class="line">        setStartTime(System.currentTimeMillis());</span><br><span class="line">        COUNTER = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createUniqID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(LEN * <span class="number">2</span>);</span><br><span class="line">        sb.append(FIX_STRING);</span><br><span class="line">        sb.append(UtilAll.bytes2string(createUniqIDBuffer()));</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] createUniqIDBuffer() &#123;</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">4</span> + <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">long</span> current = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (current &gt;= nextStartTime) &#123;</span><br><span class="line">            setStartTime(current);</span><br><span class="line">        &#125;</span><br><span class="line">        buffer.putInt((<span class="keyword">int</span>) (System.currentTimeMillis() - startTime));</span><br><span class="line">        buffer.putShort((<span class="keyword">short</span>) COUNTER.getAndIncrement());</span><br><span class="line">        <span class="keyword">return</span> buffer.array();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>UNIQ_KEYæ˜¯åœ¨ç¬¬ä¸€æ¬¡å‘é€åˆ°Brokeræ—¶ï¼Œé€šè¿‡ipã€pidã€hashcodeã€æ—¶é—´å·®ã€è‡ªå¢åºå·ç»„æˆçš„ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¶ˆæ¯æœ¬èº«çš„idæ˜¯ä¸æ¶ˆæ¯offsetç›¸å…³çš„ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æ˜¯ä¸åŒçš„ï¼Œè€Œæˆ‘ä»¬å¸¸åœ¨clientä½¿ç”¨çš„msgIdæ˜¯åœ¨clientç”Ÿäº§æ¶ˆæ¯æ—¶èµ‹äºˆçš„å…·æœ‰é€»è¾‘å”¯ä¸€æ€§çš„idï¼ˆä¸è®ºæŠ•é€’å¤šå°‘æ¬¡ï¼‰ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>é™·å…¥å›°å¢ƒçš„æ—¶å€™ï¼Œä¸å¦¨å»çªä¸ªliaoã€‚ğŸ˜Š</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åŒäº‹çªç„¶é—®æˆ‘ï¼šRocketMQçš„ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¤šæ¬¡æ¶ˆè´¹é‡è¯•ï¼Œæ¶ˆæ¯çš„msgIdä¼šä¸ä¼šå˜ï¼Ÿå“ªæ€•å·²ç»è¿›äº†DLQã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åˆšå¼€å§‹å‡ºäºç»éªŒï¼Œæˆ‘è¯´ä¸ä¼šå˜ã€‚å› ä¸ºæˆ‘ä¹‹å‰æ¯æ¬¡æ’æŸ¥é—®é¢˜çš„æ—¶å€™ï¼Œç”¨åŒä¸€ä¸ªmsgIdéƒ½èƒ½æ‰¾åˆ°å¤šæ¬¡é‡è¯•æ¶ˆè´¹çš„æ—¥å¿—ã€‚åæ¥ä¸ºäº†æ›´åŠ ç¡®å®šï¼Œæˆ‘å·äº†ä¸€ä¸‹æºç ï¼Œæˆ‘çœ‹çš„æ˜¯4.6.1ï¼Œä¸€æ˜¯å› ä¸ºå…¬å¸ç”¨çš„è¿™ä¸ªç‰ˆæœ¬ï¼ŒäºŒæ˜¯æˆ‘ä¸Šæ¬¡å·çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æ¶ˆæ¯é‡è¯•&quot;&gt;&lt;a href=&quot;#æ¶ˆæ¯é‡è¯•&quot; class=&quot;headerlink&quot; title=&quot;æ¶ˆæ¯é‡è¯•&quot;&gt;&lt;/a&gt;æ¶ˆæ¯é‡è¯•&lt;/h2&gt;&lt;p&gt;æ—¢ç„¶è·Ÿé‡è¯•æœ‰å…³ï¼Œé‚£å°±ä»å®¢æˆ·ç«¯æ¶ˆè´¹å¤±è´¥çš„é€»è¾‘å¼€å§‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°è››ä¸é©¬è¿¹ï¼Œä¸‹é¢æ˜¯æ¶ˆè´¹å¤±è´¥å°†æ¶ˆæ¯å‘å›brokerçš„ä»£ç ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="è¸©å‘è®°å½•" scheme="https://jingzhouzhao.github.io/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="RocketMQ" scheme="https://jingzhouzhao.github.io/tags/RocketMQ/"/>
    
    <category term="MessageId" scheme="https://jingzhouzhao.github.io/tags/MessageId/"/>
    
    <category term="UniqKey" scheme="https://jingzhouzhao.github.io/tags/UniqKey/"/>
    
  </entry>
  
  <entry>
    <title>PDFè½¬EPUBå·¥å…·åˆ†äº«</title>
    <link href="https://jingzhouzhao.github.io/archives/760ddd3b.html"/>
    <id>https://jingzhouzhao.github.io/archives/760ddd3b.html</id>
    <published>2022-01-06T08:41:58.000Z</published>
    <updated>2022-02-22T07:31:09.018Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>é¦–å…ˆè¯´ä¸‹ï¼Œæœ‰ç»æµæ¡ä»¶çš„è¿˜æ˜¯å»ºè®®è´­ä¹°çº¸è´¨ä¹¦é˜…è¯»å•Šï¼</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç°åœ¨ç½‘ä¸Šå¾ˆå¤šèµ„æ–™éƒ½æ˜¯æœ‰åœ¨çº¿ç‰ˆçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™åˆ°ä¸€äº›ç½‘ç»œä¸å¥½çš„åœ°æ–¹å°±å¾ˆå°´å°¬äº†ã€‚ä¸è¿‡åŒæ—¶å¤§ä½¬ä»¬ä¹Ÿä¼šæä¾›PDFç‰ˆæœ¬ï¼Œä½†æ˜¯ä¸ªäººè§‰å¾—PDFçš„é˜…è¯»ä½“éªŒå®åœ¨å¤ªå·®äº†ã€‚</p><p>æˆ‘ä¸€ç›´è§‰å¾—epubæ ¼å¼çš„é˜…è¯»ä½“éªŒä¸é”™ï¼Œé€‚é…å„ç§æ˜¾ç¤ºè®¾å¤‡ã€‚å…³äºepubæ˜¯ä»€ä¹ˆï¼Œå¯ä»¥çœ‹çœ‹<a href="https://zh.wikipedia.org/wiki/EPUB">wiki</a>ä¸Šçš„ä»‹ç»ï¼š</p><span id="more"></span><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/51zhebyw4u-1641458854167.png"></p><p>æ€»ä¹‹å€¼å¾—ä¸€è¯•ã€‚ä½†æ˜¯èµ„æ–™éƒ½æ˜¯pdfçš„ï¼Œæ‰¾ä¸åˆ°epubæ ¼å¼çš„å’‹åŠå‘¢ï¼Ÿ</p><p>å¯ä»¥â€œç™¾åº¦â€æœç´¢ä¸€ä¸‹â€œpdfè½¬epubâ€ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/9x7sodgd2i-1641459116511.png"></p><h2 id="æ¨è"><a href="#æ¨è" class="headerlink" title="æ¨è"></a>æ¨è</h2><p>ä¸€ä¸ªä¸ªå°è¯•ä¸‹æ¥ï¼Œå‘ç°ä»¥ä¸‹ä¸¤ä¸ªè¿˜ç®—èƒ½ç”¨ï¼š</p><p><a href="https://www.online-convert.com/">https://www.online-convert.com/</a></p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/wtnh9nq23e-image-20220106165731325.png"></p><p>é€‰æ‹©<code>Convert to ePub</code>å³å¯ã€‚</p><p><a href="https://convertio.co/zh/pdf-epub/">https://convertio.co/zh/pdf-epub/</a></p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/pq7y8l4r2g-image-20220106165841460.png"></p><p>ç›´æ¥é€‰æ‹©æ–‡ä»¶å³å¯ã€‚</p><h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><h3 id="PDF"><a href="#PDF" class="headerlink" title="PDF"></a>PDF</h3><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/i2pegrs8iu-1641459961215.png"></p><h3 id="ePub"><a href="#ePub" class="headerlink" title="ePub"></a>ePub</h3><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/io0rawnrqi-image-20220106170720041.png"></p><p>æˆ‘æ˜¯ç”¨Macè‡ªå¸¦çš„â€œå›¾ä¹¦â€Appæ‰“å¼€çš„ï¼Œå¯ä»¥æ ‡æ³¨é‡ç‚¹ï¼Œåšç¬”è®°ç­‰ã€‚å¦å¤–è¿˜å¯ä»¥<strong>åŒæ­¥è¿›åº¦ã€é‡ç‚¹ã€ç¬”è®°åˆ°iPhoneä¸Š</strong>ã€‚</p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>å¦‚æœæ˜¯æ‰«æç‰ˆçš„PDFï¼Œé‚£ä¹ˆè½¬æ¢æ•ˆæœæ˜¯å¾ˆå·®çš„ï¼ŒåŸºæœ¬ä¸Šè·Ÿpdfä¸€æ ·ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¦‚æœæœ‰æ—¶é—´å¯ä»¥ç ”ç©¶ä¸€ä¸‹ï¼Œè‡ªå·±å†™ä¸ªè½¬æ¢å·¥å…·ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;é¦–å…ˆè¯´ä¸‹ï¼Œæœ‰ç»æµæ¡ä»¶çš„è¿˜æ˜¯å»ºè®®è´­ä¹°çº¸è´¨ä¹¦é˜…è¯»å•Šï¼&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç°åœ¨ç½‘ä¸Šå¾ˆå¤šèµ„æ–™éƒ½æ˜¯æœ‰åœ¨çº¿ç‰ˆçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™åˆ°ä¸€äº›ç½‘ç»œä¸å¥½çš„åœ°æ–¹å°±å¾ˆå°´å°¬äº†ã€‚ä¸è¿‡åŒæ—¶å¤§ä½¬ä»¬ä¹Ÿä¼šæä¾›PDFç‰ˆæœ¬ï¼Œä½†æ˜¯ä¸ªäººè§‰å¾—PDFçš„é˜…è¯»ä½“éªŒå®åœ¨å¤ªå·®äº†ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä¸€ç›´è§‰å¾—epubæ ¼å¼çš„é˜…è¯»ä½“éªŒä¸é”™ï¼Œé€‚é…å„ç§æ˜¾ç¤ºè®¾å¤‡ã€‚å…³äºepubæ˜¯ä»€ä¹ˆï¼Œå¯ä»¥çœ‹çœ‹&lt;a href=&quot;https://zh.wikipedia.org/wiki/EPUB&quot;&gt;wiki&lt;/a&gt;ä¸Šçš„ä»‹ç»ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="å·¥å…·åˆ†äº«" scheme="https://jingzhouzhao.github.io/categories/%E5%B7%A5%E5%85%B7%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="PDF" scheme="https://jingzhouzhao.github.io/tags/PDF/"/>
    
    <category term="EPUB" scheme="https://jingzhouzhao.github.io/tags/EPUB/"/>
    
    <category term="ç”µå­ä¹¦" scheme="https://jingzhouzhao.github.io/tags/%E7%94%B5%E5%AD%90%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title>ä»€ä¹ˆæ˜¯IRIWå’ŒMCAï¼ˆmulti-copy atomicityï¼‰</title>
    <link href="https://jingzhouzhao.github.io/archives/9489a17b.html"/>
    <id>https://jingzhouzhao.github.io/archives/9489a17b.html</id>
    <published>2021-12-30T06:50:51.000Z</published>
    <updated>2022-02-22T07:31:09.019Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€è¿‘åˆåœ¨å·å…«è‚¡æ–‡ï¼Œç›´å‘¼å·ä¸åŠ¨äº†å•Šã€‚è¿™ä¸ªè¡Œä¸šå•¥æ—¶å€™æ‰èƒ½ä¸è¿™ä¹ˆå·ï¼Ÿï¼Ÿï¼Ÿ</p></blockquote><h2 id="Java-volatile"><a href="#Java-volatile" class="headerlink" title="Java volatile"></a>Java volatile</h2><p>è¯´èµ·å…«è‚¡æ–‡ï¼Œvolatileç»å¯¹æ˜¯ä¸ªè€å…«è‚¡ï¼Œéšä¾¿æ‹‰ä¸ªäººæ¥éƒ½èƒ½è¯´ä¸Šä¸¤å¥ï¼Œä»€ä¹ˆå†…å­˜å¯è§æ€§ã€å†…å­˜å±éšœã€æŒ‡ä»¤é‡æ’åºã€‚ã€‚ã€‚çœŸæä¸æ‡‚è°ƒåŒ…ä¾ æ•´è¿™äº›ç©æ„æœ‰å•¥ç”¨ã€‚</p><p>æ—¢ç„¶å·å°±å·åˆ°åº•ï¼Œçœ‹çœ‹è¿™ç©æ„åº•å±‚åˆ°åº•æ˜¯åœ¨å¹²å•¥ã€‚</p><span id="more"></span><h3 id="å­—èŠ‚ç å±‚"><a href="#å­—èŠ‚ç å±‚" class="headerlink" title="å­—èŠ‚ç å±‚"></a>å­—èŠ‚ç å±‚</h3><p>å…ˆå®šä¹‰ä¸€ä¸ªJavaç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªvolatile å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å†™volatitle å˜é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.i = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»volatitle å˜é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>javac Test.java</code> ,<code>javap -c -p -v Test.class</code>ï¼Œå¾—åˆ°å¯è¯»çš„å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">zhaojingzhou</span>.<span class="title">Test</span></span></span><br><span class="line"><span class="class">  <span class="title">minor</span> <span class="title">version</span>: 0</span></span><br><span class="line"><span class="class">  <span class="title">major</span> <span class="title">version</span>: 52</span></span><br><span class="line"><span class="class">  <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_SUPER</span></span></span><br><span class="line"><span class="class"><span class="title">Constant</span> <span class="title">pool</span>:</span></span><br><span class="line"><span class="class">   #1 </span>= Methodref          #<span class="number">4.</span>#<span class="number">17</span>         <span class="comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">   #<span class="number">2</span> = Fieldref           #<span class="number">3.</span>#<span class="number">18</span>         <span class="comment">// com/zhaojingzhou/Test.i:I</span></span><br><span class="line">   #<span class="number">3</span> = Class              #<span class="number">19</span>            <span class="comment">// com/zhaojingzhou/Test</span></span><br><span class="line">   #<span class="number">4</span> = Class              #<span class="number">20</span>            <span class="comment">// java/lang/Object</span></span><br><span class="line">   #<span class="number">5</span> = Utf8               i</span><br><span class="line">   #<span class="number">6</span> = Utf8               I</span><br><span class="line">   #<span class="number">7</span> = Utf8               &lt;init&gt;</span><br><span class="line">   #<span class="number">8</span> = Utf8               ()V</span><br><span class="line">   #<span class="number">9</span> = Utf8               Code</span><br><span class="line">  #<span class="number">10</span> = Utf8               LineNumberTable</span><br><span class="line">  #<span class="number">11</span> = Utf8               set</span><br><span class="line">  #<span class="number">12</span> = Utf8               (I)V</span><br><span class="line">  #<span class="number">13</span> = Utf8               get</span><br><span class="line">  #<span class="number">14</span> = Utf8               ()I</span><br><span class="line">  #<span class="number">15</span> = Utf8               SourceFile</span><br><span class="line">  #<span class="number">16</span> = Utf8               Test.java</span><br><span class="line">  #<span class="number">17</span> = NameAndType        #<span class="number">7</span>:#<span class="number">8</span>          <span class="comment">// &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">  #<span class="number">18</span> = NameAndType        #<span class="number">5</span>:#<span class="number">6</span>          <span class="comment">// i:I</span></span><br><span class="line">  #<span class="number">19</span> = Utf8               com/internet/zhaojingzhou/Test</span><br><span class="line">  #<span class="number">20</span> = Utf8               java/lang/Object</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i;</span><br><span class="line">    descriptor: I</span><br><span class="line">    flags: ACC_PRIVATE, ACC_VOLATILE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> com.zhaojingzhou.Test();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial #<span class="number">1</span>                  <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">9</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">    descriptor: (I)V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">2</span>, args_size=<span class="number">2</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: iload_1</span><br><span class="line">         <span class="number">2</span>: putfield      #<span class="number">2</span>                  <span class="comment">// Field i:I</span></span><br><span class="line">         <span class="number">5</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">14</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">15</span>: <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: getfield      #<span class="number">2</span>                  <span class="comment">// Field i:I</span></span><br><span class="line">         <span class="number">4</span>: ireturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">18</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">SourceFile: <span class="string">&quot;Test.java&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°volatileå…³é”®å­—ä¿®é¥°çš„å˜é‡å¤šäº†ä¸€ä¸ªflag :<code>ACC_VOLATILE</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i;</span><br><span class="line">   descriptor: I</span><br><span class="line">   flags: ACC_PRIVATE, ACC_VOLATILE</span><br></pre></td></tr></table></figure><p>å¦å¤–å¯ä»¥çœ‹åˆ°å¯¹äºå˜é‡çš„è¯»å†™æŒ‡ä»¤æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: putfield      #<span class="number">2</span>                  <span class="comment">// Field i:I</span></span><br><span class="line"><span class="number">1</span>: getfield      #<span class="number">2</span>                  <span class="comment">// Field i:I</span></span><br></pre></td></tr></table></figure><h3 id="CPPå±‚"><a href="#CPPå±‚" class="headerlink" title="CPPå±‚"></a>CPPå±‚</h3><p>æ ¹æ®æˆ‘ä¸‰è„šçŒ«çš„åŠŸå¤«ï¼Œåœ¨æºç ä¸­æ‰¾åˆ°äº†è¿™ä¸¤ä¸ªæŒ‡ä»¤ç›¸å…³çš„å†…å®¹ï¼Œä½äº<code>src/hotspot/share/interpreter/zero/bytecodeInterpreter.cpp</code></p><p>ï¼ˆè¿™é‡Œè¯´ä¸€ä¸‹ï¼Œæˆ‘çœ‹çš„æ˜¯jdk8çš„æºç ï¼‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CASE</span>(_getfield):</span><br><span class="line">      <span class="built_in">CASE</span>(_getstatic):</span><br><span class="line">        &#123;</span><br><span class="line">          u2 index;</span><br><span class="line">          ConstantPoolCacheEntry* cache;</span><br><span class="line">          index = Bytes::<span class="built_in">get_native_u2</span>(pc+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// QQQ Need to make this as inlined as possible. Probably need to</span></span><br><span class="line">          <span class="comment">// split all the bytecode cases out so c++ compiler has a chance</span></span><br><span class="line">          <span class="comment">// for constant prop to fold everything possible away.</span></span><br><span class="line"></span><br><span class="line">          cache = cp-&gt;<span class="built_in">entry_at</span>(index);</span><br><span class="line">          <span class="comment">// è¿™é‡Œçœç•¥äº†ä¸€äº›ä»£ç </span></span><br><span class="line">          <span class="keyword">if</span> (cache-&gt;<span class="built_in">is_volatile</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (support_IRIW_for_not_multiple_copy_atomic_cpu) &#123;</span><br><span class="line">              OrderAccess::<span class="built_in">fence</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in"><span class="keyword">switch</span></span> (tos_type) &#123;</span><br><span class="line">              <span class="keyword">case</span> btos:</span><br><span class="line">              <span class="keyword">case</span> ztos:</span><br><span class="line">                <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">byte_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> ctos:</span><br><span class="line">                <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">char_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> stos:</span><br><span class="line">                <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">short_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> itos:</span><br><span class="line">                <span class="built_in">SET_STACK_INT</span>(obj-&gt;<span class="built_in">int_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> ftos:</span><br><span class="line">                <span class="built_in">SET_STACK_FLOAT</span>(obj-&gt;<span class="built_in">float_field_acquire</span>(field_offset), <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> ltos:</span><br><span class="line">                <span class="built_in">SET_STACK_LONG</span>(obj-&gt;<span class="built_in">long_field_acquire</span>(field_offset), <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> dtos:</span><br><span class="line">                <span class="built_in">SET_STACK_DOUBLE</span>(obj-&gt;<span class="built_in">double_field_acquire</span>(field_offset), <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">MORE_STACK</span>(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> atos: &#123;</span><br><span class="line">                oop val = obj-&gt;<span class="built_in">obj_field_acquire</span>(field_offset);</span><br><span class="line">                <span class="built_in">VERIFY_OOP</span>(val);</span><br><span class="line">                <span class="built_in">SET_STACK_OBJECT</span>(val, <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">ShouldNotReachHere</span>();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰å‡ è¡Œè¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cache-&gt;<span class="built_in">is_volatile</span>()) &#123;</span><br><span class="line">           <span class="keyword">if</span> (support_IRIW_for_not_multiple_copy_atomic_cpu) &#123;</span><br><span class="line">             OrderAccess::<span class="built_in">fence</span>();</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ<code>is_volatile</code>åˆ¤æ–­æ˜¯å¦volatileå˜é‡ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/hotspot/share/runtime/fieldDescriptor.hpp</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_volatile</span><span class="params">()</span>              <span class="keyword">const</span>    </span>&#123; <span class="keyword">return</span> <span class="built_in">access_flags</span>().<span class="built_in">is_volatile</span>(); &#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œçš„access_flagså¯¹åº”çš„å°±æ˜¯ä¸Šé¢å­—èŠ‚ç ä¸­ACC_å¼€å¤´çš„å“ªäº›flagã€‚</span></span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œæ€»ç®—çœ‹åˆ°å…«è‚¡æ–‡é‡Œé¢è¯´çš„å†…å­˜å±éšœäº†<code>OrderAccess::fence()</code>ã€‚</p><p>å’¦ï¼Œå’‹è‚¥äº‹ï¼Œå’‹å¤–é¢è¿˜å¥—äº†ä¸ªifã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>å¹¶ä¸æ˜¯æ‰€æœ‰æƒ…å†µä¸‹éƒ½åŠ äº†å†…å­˜å±éšœ</code>ã€‚é‚£<code>support_IRIW_for_not_multiple_copy_atomic_cpu</code> è¿™ä¸ªç©æ„åˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿä»è¿™ä¸ªå˜é‡é‡Œä¼¼ä¹å¯ä»¥æ‹†é™¤ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯<code>multiple_copy_atomic</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>IRIW</code>ã€‚å…³äºè¿™ä¸¤ä¸ªä¸œè¥¿ï¼Œåœ¨ä¸­æ–‡èµ„æºé‡Œèƒ½æŸ¥æ‰¾åˆ°çš„ä¸œè¥¿éå¸¸å°‘ï¼Œç‰¹åˆ«æ˜¯IRIWã€‚</p><h2 id="MCAæ¨¡å‹ï¼ˆmulti-copy-atomicityï¼‰"><a href="#MCAæ¨¡å‹ï¼ˆmulti-copy-atomicityï¼‰" class="headerlink" title="MCAæ¨¡å‹ï¼ˆmulti-copy atomicityï¼‰"></a>MCAæ¨¡å‹ï¼ˆmulti-copy atomicityï¼‰</h2><p>ä»ä¸ºæ•°ä¸å¤šçš„<a href="https://zhuanlan.zhihu.com/p/150879932">ä¸­æ–‡èµ„æº</a>ä¸­æ‰¾åˆ°å¦‚ä¸‹è¯´æ³•ï¼š</p><p>é‚£æ€ä¹ˆæ ·æ‰ç§°ä¸ºmulti-copy atomicityå‘¢ï¼Ÿä¸æ­£å¼ä½†æ˜“äºç†è§£çš„è¯´æ³•æ˜¯</p><blockquote><p>When a write is visible to one thread other than its originating thread, it is visible to all other threads.</p></blockquote><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼š<code>ä¸€ä¸ªå­˜å‚¨å™¨å†™è¦ä¹ˆä¸è¢«å…¶ä»–ç¡¬ä»¶çº¿ç¨‹çœ‹åˆ°ï¼Œè¦æ˜¯æœ‰ä¸€ä¸ªçœ‹åˆ°äº†ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºå…¶ä»–ç¡¬ä»¶çº¿ç¨‹éƒ½çœ‹åˆ°äº†</code>ã€‚</p><p>è¿™ä¸ªå®šä¹‰å…¶å®å’ŒARMæ–‡æ¡£é‡Œçš„multi-copy atomicityä¸ä¸€è‡´ï¼ŒARMæ–‡æ¡£é‡ŒMCAçš„å®šä¹‰è¦æ›´ä¸¥æ ¼ï¼šå‘å‡ºå­˜å‚¨å™¨å†™çš„ç¡¬ä»¶çº¿ç¨‹è‡ªå·±ä¹Ÿçœ‹ä¸åˆ°è¿™ä¸ªå†™ï¼Œé™¤éå…¶ä»–ç¡¬ä»¶çº¿ç¨‹ä¹Ÿçœ‹åˆ°äº†ã€‚è¿™å…¶å®åŒºåˆ«å°±åœ¨äºæ˜¯ä¸æ˜¯å…è®¸è‡ªå·±çš„å†™forwardç»™è‡ªå·±çš„è¯»ã€‚å¦‚æœå…è®¸ï¼Œå°±æ˜¯é€šå¸¸çš„MCAå®šä¹‰ï¼Œå¦åˆ™å°±æ˜¯ARMæ–‡æ¡£é‡Œçš„å®šä¹‰ã€‚ARMæ–‡æ¡£æŠŠè¿™ç§çº¦æŸä¸ç”šä¸¥æ ¼çš„MCAç§°ä¸ºâ€œother-multicopy-atomicâ€ã€‚è¿™ä¹Ÿæ˜¯å›°æ‰°äº†æˆ‘å¾ˆä¹…çš„ä¸€ä¸ªé—®é¢˜ã€‚</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/lgfp8bug9v-1640850839744.png"></p><p>å¯¹äºä¸Šå›¾è¿™ä¸ªä¾‹å­ï¼ŒMCAæ¨¡å‹ä¸å¯èƒ½æœ€åThread1å’ŒThread3æœ€åè¯»åˆ°çš„yå’Œxéƒ½æ˜¯0çš„ï¼Œå› ä¸ºè¿™ä¸ªç»“æœè¡¨æ˜Thread1çœ‹åˆ°aè€Œæ²¡çœ‹åˆ°dï¼›ä½†Thread3çœ‹åˆ°dè€Œæ²¡çœ‹åˆ°aï¼Œè¿™æ˜¯ä¸ç¬¦åˆMCAçš„å®šä¹‰çš„ã€‚è€Œå¯¹äºNon-MCAï¼Œä¸Šå›¾çš„ç»“æœæ˜¯å¯èƒ½çš„ã€‚</p><p>å§æ§½ï¼Œä¸Šé¢è¯´çš„ä¸å°±æ˜¯å†…å­˜å¯è§æ€§çš„é—®é¢˜å—ï¼Ÿï¼Ÿï¼Ÿ</p><h2 id="IRIW"><a href="#IRIW" class="headerlink" title="IRIW"></a>IRIW</h2><p>é‚£å•¥åˆæ˜¯IRIWå‘¢ï¼Ÿâ€œç™¾åº¦â€å‡ºæ¥çš„ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/oltrtxrtaj-1640851680307.png"></p><p>TOP5ï¼Œå”¯ä¸€ä¸€ä¸ªçœ‹ç€é è°±ä¸€ç‚¹çš„ç»“æœï¼Œç‚¹è¿›å»ä¸€çœ‹ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/5799w94r3e-1640851815354.png"></p><p>è¿™å•¥å‘€ã€‚ã€‚ã€‚ã€‚</p><p>ä½†æ˜¯ä¹Ÿä¸æ˜¯ä¸€ç‚¹æ²¡ç”¨ï¼Œè‡³å°‘çŸ¥é“äº†è¿™ä¸ªç¼©å†™ä»£è¡¨çš„æ˜¯<code>Independent Reads, Independent Writes </code></p><p>ä½†è¿™ç©æ„åˆ°åº•æ˜¯ä¸ªå•¥å‘¢ï¼Ÿæœ€åæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ª<a href="http://www0.cs.ucl.ac.uk/staff/j.alglave/papers/ec209.pdf">è®ºæ–‡</a>ï¼Œé‡Œé¢æœ‰ä¸€æ®µå†…å®¹ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/ihbdolegte-1640853204253.png"></p><p>é‡Œé¢è¯´åˆ°äº†ä¸€ä¸ªIRIW exampleï¼š</p><p>æœ‰4ä¸ªprocï¼Œ0ã€1ã€2ã€3ã€‚proc0å°†x=1ï¼Œproc1å°†y=1ï¼Œproc2è¯»åˆ°x=1ï¼Œy=0ï¼Œproc3è¯»åˆ°y=1ï¼Œx=0ã€‚</p><p>æˆ‘å¯»æ€ï¼ŒIRIWéš¾é“å°±æ˜¯MCAçš„åä¹‰ï¼Ÿ</p><p>åé¢åˆä¸¾äº†ä¸€ä¸ªJMMçš„ä¾‹å­ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/bwfiu07fn8-1640855045159.png"></p><p>è¯´çš„å¤§æ¦‚å°±æ˜¯HotSpotä¹‹å†…çš„ç¼–è¯‘å™¨ä¼šä¼˜åŒ–ä»£ç ï¼Œå°†x=(r2==1)?y:1 ä¼˜åŒ–ä¸ºx=1ï¼Œå¹¶ä¼˜åŒ–äº†ä¸¤ä¸ªæŒ‡ä»¤çš„ä½ç½®ï¼Œx=1è·‘r2=yå‰é¢å»äº†ã€‚</p><p>IRIWåˆæœ‰ç‹¬ç«‹æŒ‡ä»¤é‡æ’çš„æ„æ€ï¼Ÿï¼Ÿ</p><p>è¯´å®è¯çœ‹å®Œæˆ‘è¿˜æ˜¯è¿·ç³Šçš„ï¼Œä½†æ˜¯å›åˆ°å‰é¢çš„é‚£ä¸ªæ¡ä»¶ï¼š<code>support_IRIW_for_not_multiple_copy_atomic_cpu</code>ï¼Œå¤§æ¦‚èƒ½æ˜ç™½æ„æ€äº†ï¼Œåº”è¯¥æ˜¯æŒ‡æ”¯æŒIRIWè€Œä¸æ˜¯MCAçš„CPUå°±ä½¿ç”¨fenceã€‚</p><h2 id="OrderAccess"><a href="#OrderAccess" class="headerlink" title="OrderAccess"></a>OrderAccess</h2><p><code>/src/hotspot/share/runtime/orderAccess.hpp</code>ä¸­å®šä¹‰äº†ä¸€äº›å†…å­˜å±éšœï¼Œå…·ä½“çš„å®ç°ï¼Œä¸åŒçš„æ¶æ„åˆä¸ä¸€æ ·ï¼Œlinux_x86å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/hotspot/os_cpu/linux_x86/orderAccess_linux_x86.hpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> inline <span class="keyword">void</span> <span class="title">compiler_barrier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;&quot;</span> : : : <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::loadload()   &#123; compiler_barrier(); &#125;</span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::storestore() &#123; compiler_barrier(); &#125;</span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::loadstore()  &#123; compiler_barrier(); &#125;</span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::storeload()  &#123; fence();            &#125;</span><br><span class="line"></span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::acquire()    &#123; compiler_barrier(); &#125;</span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::release()    &#123; compiler_barrier(); &#125;</span><br><span class="line"></span><br><span class="line">inline <span class="keyword">void</span> OrderAccess::fence() &#123;</span><br><span class="line">   <span class="comment">// always use locked addl since mfence is sometimes expensive</span></span><br><span class="line">#<span class="function">ifdef AMD64</span></span><br><span class="line"><span class="function">  __asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock; addl $0,0(%%rsp)&quot;</span> : : : <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">  <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock; addl $0,0(%%esp)&quot;</span> : : : <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line">#<span class="function">endif</span></span><br><span class="line"><span class="function">  <span class="title">compiler_barrier</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>lock; addl</code>æ˜¯å…³é”® ã€‚</p><p>lockå‰ç¼€æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¿¡å·ï¼Œæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>å¯¹æ€»çº¿å’Œç¼“å­˜ä¸Šé”ã€‚<br><code>å¼ºåˆ¶æ‰€æœ‰lockä¿¡å·ä¹‹å‰çš„æŒ‡ä»¤ï¼Œéƒ½åœ¨æ­¤ä¹‹å‰è¢«æ‰§è¡Œï¼Œå¹¶åŒæ­¥ç›¸å…³ç¼“å­˜</code>ã€‚<br>æ‰§è¡Œlockåçš„æŒ‡ä»¤ï¼ˆå¦‚cmpxchgï¼‰ã€‚<br>é‡Šæ”¾å¯¹æ€»çº¿å’Œç¼“å­˜ä¸Šçš„é”ã€‚<br><code>å¼ºåˆ¶æ‰€æœ‰lockä¿¡å·ä¹‹åçš„æŒ‡ä»¤ï¼Œéƒ½åœ¨æ­¤ä¹‹åè¢«æ‰§è¡Œï¼Œå¹¶åŒæ­¥ç›¸å…³ç¼“å­˜</code>ã€‚<br>å› æ­¤ï¼Œlockä¿¡å·è™½ç„¶ä¸æ˜¯å†…å­˜å±éšœï¼Œä½†å…·æœ‰<code>mfence</code>çš„è¯­ä¹‰ï¼ˆå½“ç„¶ï¼Œè¿˜æœ‰æ’ä»–æ€§çš„è¯­ä¹‰ï¼‰ã€‚</p><p>ä¸å†…å­˜å±éšœç›¸æ¯”ï¼Œlockä¿¡å·è¦é¢å¤–å¯¹æ€»çº¿å’Œç¼“å­˜ä¸Šé”ï¼Œæˆæœ¬æ›´é«˜</p><p>è€Œè¿™é‡Œlock åè·Ÿçš„æ˜¯addlæŒ‡ä»¤ï¼Œå¯¹ä¸€ä¸ªå¯„å­˜å™¨ä¸­çš„å€¼åŠ äº†0ã€‚ç„¶è€Œé€šè¿‡lockä¿¡å·çš„ä½œç”¨ï¼Œå®ç°äº†å†…å­˜å±éšœçš„æ•ˆæœã€‚</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://zhuanlan.zhihu.com/p/150879932">https://zhuanlan.zhihu.com/p/150879932</a></p><p><a href="http://www0.cs.ucl.ac.uk/staff/j.alglave/papers/ec209.pdf">http://www0.cs.ucl.ac.uk/staff/j.alglave/papers/ec209.pdf</a></p><p><a href="https://www.cnblogs.com/sunddenly/articles/14829255.html">https://www.cnblogs.com/sunddenly/articles/14829255.html</a></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å·å¾—è„‘å£³ç–¼ã€‚ã€‚ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åˆåœ¨å·å…«è‚¡æ–‡ï¼Œç›´å‘¼å·ä¸åŠ¨äº†å•Šã€‚è¿™ä¸ªè¡Œä¸šå•¥æ—¶å€™æ‰èƒ½ä¸è¿™ä¹ˆå·ï¼Ÿï¼Ÿï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Java-volatile&quot;&gt;&lt;a href=&quot;#Java-volatile&quot; class=&quot;headerlink&quot; title=&quot;Java volatile&quot;&gt;&lt;/a&gt;Java volatile&lt;/h2&gt;&lt;p&gt;è¯´èµ·å…«è‚¡æ–‡ï¼Œvolatileç»å¯¹æ˜¯ä¸ªè€å…«è‚¡ï¼Œéšä¾¿æ‹‰ä¸ªäººæ¥éƒ½èƒ½è¯´ä¸Šä¸¤å¥ï¼Œä»€ä¹ˆå†…å­˜å¯è§æ€§ã€å†…å­˜å±éšœã€æŒ‡ä»¤é‡æ’åºã€‚ã€‚ã€‚çœŸæä¸æ‡‚è°ƒåŒ…ä¾ æ•´è¿™äº›ç©æ„æœ‰å•¥ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;æ—¢ç„¶å·å°±å·åˆ°åº•ï¼Œçœ‹çœ‹è¿™ç©æ„åº•å±‚åˆ°åº•æ˜¯åœ¨å¹²å•¥ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="IRIW" scheme="https://jingzhouzhao.github.io/tags/IRIW/"/>
    
    <category term="CPU" scheme="https://jingzhouzhao.github.io/tags/CPU/"/>
    
    <category term="volatile" scheme="https://jingzhouzhao.github.io/tags/volatile/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Pythonè„šæœ¬è‡ªåŠ¨è®¢é¤</title>
    <link href="https://jingzhouzhao.github.io/archives/5f3e8b9e.html"/>
    <id>https://jingzhouzhao.github.io/archives/5f3e8b9e.html</id>
    <published>2021-12-24T02:47:31.000Z</published>
    <updated>2022-02-22T07:31:09.017Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>å…¬å¸å‘˜å·¥é¤é€‰ç”¨çš„ç¾é¤å¹³å°ï¼Œä½†æ˜¯ç»å¸¸ç”±äºå¤ªå¿™å¿˜è®°ç‚¹é¤ï¼Œå¯¼è‡´é¥¿ç€è‚šå­åŠ ç­ã€‚åæ­£èœå“çš„å¯é€‰é¡¹æ¯”è¾ƒå°‘ï¼Œæƒ³ç€è¦æ˜¯èƒ½è‡ªåŠ¨ç‚¹ä¸€ä¸ªå°±å¥½äº†ã€‚äºæ˜¯æœ‰äº†ä»¥ä¸‹è„šæœ¬ã€‚</p></blockquote><h2 id="æ¥å£åˆ†æ"><a href="#æ¥å£åˆ†æ" class="headerlink" title="æ¥å£åˆ†æ"></a>æ¥å£åˆ†æ</h2><h3 id="å‚æ•°åˆ†æ"><a href="#å‚æ•°åˆ†æ" class="headerlink" title="å‚æ•°åˆ†æ"></a>å‚æ•°åˆ†æ</h3><p>è‡ªåŠ¨ç‚¹é¤æ— éå°±æ˜¯æ¨¡æ‹Ÿäººçš„è¡Œä¸ºï¼Œè‡ªåŠ¨è¯·æ±‚ä¸€äº›å…³é”®æ¥å£ã€‚äºæ˜¯åˆ†æäº†ä¸€ä¸‹ç¾é¤ç½‘çš„webç«¯æ¥å£ï¼Œå‘ç°å…³é”®æ¥å£å¦‚ä¸‹ï¼š</p><ol><li>è·å–èœå•æ¥å£ï¼š<a href="https://meican.com/preorder/api/v2.1/restaurants/show?tabUniqueId=???&amp;targetTime=???&amp;restaurantUniqueId=???&amp;client_id=???&amp;client_secret=">https://meican.com/preorder/api/v2.1/restaurants/show?tabUniqueId=???&amp;targetTime=???&amp;restaurantUniqueId=???&amp;client_id=???&amp;client_secret=</a>???</li><li>ä¸‹å•æ¥å£ï¼š<a href="https://meican.com/preorder/api/v2.1/orders/add?client_id=???&amp;client_secret=">https://meican.com/preorder/api/v2.1/orders/add?client_id=???&amp;client_secret=</a>???</li></ol><p>æœ‰äº†æ¥å£åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥å¼€å§‹åˆ†æã€å°è¯•æ¥å£çš„å“ªäº›å‚æ•°æ˜¯é™æ€çš„ï¼Œå“ªäº›æ˜¯åŠ¨æ€çš„ã€‚</p><span id="more"></span><p>é¦–å…ˆé€šè¿‡å¤šä¸ªè¯·æ±‚ï¼Œå¯ä»¥å¾—çŸ¥ï¼Œä¸Šè¿°ä¸¤ä¸ªå…³é”®æ¥å£ä¸­çš„<strong>client_id</strong>ã€<strong>client_secret</strong>æ˜¯é™æ€çš„å›ºå®šä¸å˜çš„ï¼ŒçŒœæµ‹å¯èƒ½æ˜¯webç«¯çš„èº«ä»½ã€‚</p><p>ç„¶åç¬¬ä¸€ä¸ªæ¥å£ä¸­çš„<strong>restaurantUniqueId</strong>å¯ä»¥å‘ç°å¤šæ¬¡è¯·æ±‚å¹¶æ²¡å‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”é€šè¿‡å‘½ååŸºæœ¬å¯ä»¥å¾—å‡ºï¼Œåº”è¯¥æ˜¯ç±»ä¼¼ä¼ä¸šé£Ÿå ‚åœ¨ç¾é¤é‚£è¾¹çš„ä¸€ä¸ªå”¯ä¸€idã€‚</p><p>ç¬¬ä¸€ä¸ªæ¥å£ä¸­çš„<strong>targetTime</strong>ï¼Œé€šè¿‡æ•°æ®æ ·ä¾‹åˆ†æï¼Œä»¥åŠå¯¹æ¯”å…¶ä»–éå…³é”®æ¥å£æ•°æ®ï¼Œå¯ä»¥å¾—çŸ¥ï¼Œåº”è¯¥æ˜¯ä¼ä¸šåœ¨ç¾é¤ç½‘è®¾ç½®çš„ç‚¹é¤æˆªæ­¢æ—¶é—´ã€‚ä¾‹å¦‚æˆ‘ä»¬å…¬å¸é…ç½®çš„æ˜¯æ—©é¤6:00æˆªæ­¢ç‚¹é¤ï¼Œé‚£ä¹ˆè¿™ä¸ª<strong>targetTime</strong>å°±æ˜¯ yyyy-MM-dd +06:00ã€‚</p><p>æœ€åç¬¬ä¸€ä¸ªæ¥å£è¿˜æœ‰ä¸€ä¸ªå‚æ•°<strong>tabUniqueId</strong> ï¼Œæœ€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯å®Œå…¨é™æ€çš„ï¼Œåé¢é€šè¿‡è¸©å‘å¾—çŸ¥ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯ä»£è¡¨æ¯ä¸€é¤çš„å”¯ä¸€idï¼Œæ—©ã€ä¸­ã€æ™šå‡ä¸ä¸€æ ·ã€‚</p><h3 id="å“åº”åˆ†æ"><a href="#å“åº”åˆ†æ" class="headerlink" title="å“åº”åˆ†æ"></a>å“åº”åˆ†æ</h3><p>ç¬¬ä¸€ä¸ªæ¥å£æ‹¿åˆ°çš„å…³é”®å“åº”å¦‚ä¸‹(å¿½ç•¥äº†ä¸€äº›)ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;dishList&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;dishSectionId&quot;</span>: xxxx,</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: xxxx,</span><br><span class="line">            <span class="attr">&quot;isSection&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;æ™šé¤&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;originalPriceInCent&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;priceInCent&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;priceString&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;dishSectionId&quot;</span>: xxxx,</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: y1,</span><br><span class="line">            <span class="attr">&quot;isSection&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;å‘¨äº” æ°´é¥º&amp;èŠ±ç”Ÿç±³æ‹Œé»„ç“œ&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;originalPriceInCent&quot;</span>: <span class="number">1100</span>,</span><br><span class="line">            <span class="attr">&quot;priceInCent&quot;</span>: <span class="number">1100</span>,</span><br><span class="line">            <span class="attr">&quot;priceString&quot;</span>: <span class="string">&quot;11&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;dishSectionId&quot;</span>: xxxx,</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: y2,</span><br><span class="line">            <span class="attr">&quot;isSection&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;å‘¨äº” Aå¥—é¤ å°é¸¡ç‚–è˜‘è‡&amp;å¹²ç‚¸å°é»„é±¼&amp;è‚‰æ²«è±†è…&amp;åœŸè±†ç‰‡ç‚’è‚‰&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;originalPriceInCent&quot;</span>: <span class="number">1100</span>,</span><br><span class="line">            <span class="attr">&quot;priceInCent&quot;</span>: <span class="number">1100</span>,</span><br><span class="line">            <span class="attr">&quot;priceString&quot;</span>: <span class="string">&quot;11&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªéœ€è¦ç»“åˆç¬¬äºŒä¸ªæ¥å£å‚æ•°æ¥åˆ†æï¼Œå“ªäº›æ˜¯æœ‰ç”¨çš„ä¿¡æ¯ï¼Œç¬¬äºŒä¸ªæ¥å£çš„è¯·æ±‚å‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;corpAddressRemark&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="attr">&quot;corpAddressUniqueId&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="attr">&quot;order&quot;</span>:orderP,<span class="attr">&quot;remarks&quot;</span>:remarkP,<span class="attr">&quot;tabUniqueId&quot;</span>:uu[&#x27;tab&#x27;],<span class="attr">&quot;targetTime&quot;</span>:targetTime,<span class="attr">&quot;userAddressUniqueId&quot;</span>:<span class="string">&quot;xxxx&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<strong>targetTime</strong>åº”è¯¥ä¸ç¬¬ä¸€ä¸ªæ¥å£çš„ä¸€è‡´ã€‚<strong>remarks</strong>æ²¡æ‡‚åˆ°åº•æœ‰æ²¡æœ‰ç”¨ï¼Œ<strong>tabUniqueId</strong>è·Ÿä¸Šä¸ªæ¥å£ä¹Ÿæ˜¯ä¸€è‡´ã€‚æœ€å<strong>order</strong>æ˜¯è·Ÿç¬¬ä¸€ä¸ªæ¥å£å“åº”æœ‰å…³çš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="attr">&quot;count&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;dishId&quot;</span>:y1&#125;]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<strong>dishId</strong>å°±æ˜¯ç¬¬ä¸€ä¸ªæ¥å£<strong>dishList</strong>ä¸­çš„<strong>id</strong>ã€‚å¥½äº†å…³é”®ä¿¡æ¯æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹ç¼–å†™è„šæœ¬äº†ã€‚</p><h2 id="è„šæœ¬ç¼–å†™"><a href="#è„šæœ¬ç¼–å†™" class="headerlink" title="è„šæœ¬ç¼–å†™"></a>è„šæœ¬ç¼–å†™</h2><p>è„šæœ¬å°±ä¸åºŸè¯äº†ï¼Œç”±äºPythonä¸æ˜¯ä¸»åŠ›è¯­è¨€ï¼Œå¹³æ—¶å†™çš„å°‘ï¼Œè€Œä¸”ç”±äºæ˜¯æ‘¸é±¼æ—¶é—´ğŸŸæ¥å†™çš„ï¼Œæ‰€ä»¥å†™çš„æ¯”è¾ƒç²—ç³™å’Œä¸è§„èŒƒã€‚ğŸ¤¦â€â™‚ï¸</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tomorrow = (datetime.datetime.now()+datetime.timedelta(days=<span class="number">1</span>)).strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;tomorrow:&quot;</span>, tomorrow)</span><br><span class="line">headers=&#123;&#125;</span><br><span class="line">headers1=&#123;&#125;</span><br><span class="line">headers2=&#123;&#125;</span><br><span class="line">headers3=&#123;&#125;</span><br><span class="line"></span><br><span class="line">user1=&#123;<span class="string">&#x27;headers&#x27;</span>:headers,<span class="string">&#x27;phone&#x27;</span>:<span class="string">&#x27;xxxxx&#x27;</span>,<span class="string">&#x27;tab&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">user2=&#123;<span class="string">&#x27;headers&#x27;</span>:headers1,<span class="string">&#x27;phone&#x27;</span>:<span class="string">&#x27;xxxxx&#x27;</span>,<span class="string">&#x27;tab&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">user3=&#123;<span class="string">&#x27;headers&#x27;</span>:headers2,<span class="string">&#x27;phone&#x27;</span>:<span class="string">&#x27;xxxxx&#x27;</span>,<span class="string">&#x27;tab&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">user4=&#123;<span class="string">&#x27;headers&#x27;</span>:headers3,<span class="string">&#x27;phone&#x27;</span>:<span class="string">&#x27;xxxxx&#x27;</span>,<span class="string">&#x27;tab&#x27;</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">users=[user1,user2,user3,user4]</span><br><span class="line"></span><br><span class="line">add_url=<span class="string">&quot;https://meican.com/preorder/api/v2.1/orders/add?client_id=xxxx&amp;client_secret=xxxx&quot;</span></span><br><span class="line">count=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(users)):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        count=count+<span class="number">1</span></span><br><span class="line">        uu = users[i]</span><br><span class="line">        url = <span class="string">&quot;https://meican.com/preorder/api/v2.1/restaurants/show?tabUniqueId=&quot;</span>+uu[<span class="string">&#x27;tab&#x27;</span>]+<span class="string">&quot;&amp;targetTime=&quot;</span> + tomorrow + <span class="string">&quot;+06:00&amp;restaurantUniqueId=xxxx&amp;client_id=xxxx&amp;client_secret=xxxx&quot;</span></span><br><span class="line">        r = requests.get(url, headers=uu[<span class="string">&#x27;headers&#x27;</span>])</span><br><span class="line">        data = json.loads(r.content)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;dishList&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            bData = data[<span class="string">&#x27;dishList&#x27;</span>][<span class="number">1</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">            aAata = data[<span class="string">&#x27;dishList&#x27;</span>][<span class="number">2</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> count==<span class="number">1</span>:</span><br><span class="line">              <span class="comment"># å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;å‘é€šçŸ¥&quot;</span>)</span><br><span class="line">                botData=json.dumps(&#123;<span class="string">&quot;msgtype&quot;</span>:<span class="string">&quot;text&quot;</span>,<span class="string">&quot;text&quot;</span>:&#123;<span class="string">&quot;content&quot;</span>:<span class="string">&quot;æ˜æ—¥æ—©é¤ï¼š\r\n&quot;</span>+bData+<span class="string">&quot;\r\n&quot;</span>+aAata,<span class="string">&quot;mentioned_list&quot;</span>:[<span class="string">&quot;@all&quot;</span>]&#125;&#125;)</span><br><span class="line">                botR = requests.post(url=<span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx&#x27;</span>, data=botData, headers=&#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json;charset=utf-8&quot;</span>&#125;)</span><br><span class="line">                <span class="built_in">print</span>(botR.content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;menu: &quot;</span>, aAata, bData)</span><br><span class="line">            bDataId=<span class="built_in">str</span>(data[<span class="string">&#x27;dishList&#x27;</span>][<span class="number">1</span>][<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            targetTime = tomorrow + <span class="string">&#x27; 06:00&#x27;</span>;</span><br><span class="line">            orderP = <span class="string">&quot;[&#123;\&quot;count\&quot;:1,\&quot;dishId\&quot;:&quot;</span>+bDataId+<span class="string">&quot;&#125;]&quot;</span></span><br><span class="line">            remarkP = <span class="string">&quot;[&#123;\&quot;dishId\&quot;:\&quot;&quot;</span>+bDataId+<span class="string">&quot;\&quot;,\&quot;remark\&quot;:\&quot;\&quot;&#125;]&quot;</span></span><br><span class="line">            postData = &#123;<span class="string">&quot;corpAddressRemark&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;corpAddressUniqueId&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>,<span class="string">&quot;order&quot;</span>:orderP,<span class="string">&quot;remarks&quot;</span>:remarkP,<span class="string">&quot;tabUniqueId&quot;</span>:uu[<span class="string">&#x27;tab&#x27;</span>],<span class="string">&quot;targetTime&quot;</span>:targetTime,<span class="string">&quot;userAddressUniqueId&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>&#125;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;å½“å‰ç”¨æˆ·:&#x27;</span>,uu[<span class="string">&#x27;phone&#x27;</span>])</span><br><span class="line">            ar = requests.post(url=add_url, data=postData, headers=uu[<span class="string">&#x27;headers&#x27;</span>])</span><br><span class="line">            <span class="built_in">print</span>(ar.content)</span><br><span class="line">            data2 = json.loads(ar.content)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;status&#x27;</span> <span class="keyword">in</span> data2:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;SUCCESSFUL&#x27;</span>==data2[<span class="string">&#x27;status&#x27;</span>]:</span><br><span class="line">                    botData2 = json.dumps(&#123;<span class="string">&quot;msgtype&quot;</span>: <span class="string">&quot;text&quot;</span>, <span class="string">&quot;text&quot;</span>: &#123;<span class="string">&quot;content&quot;</span>: <span class="string">&quot;å·²ä¸ºå°Šè´µçš„ä¼šå‘˜ç‚¹é¤æˆåŠŸ&quot;</span>, <span class="string">&quot;mentioned_mobile_list&quot;</span>: [uu[<span class="string">&#x27;phone&#x27;</span>]]&#125;&#125;)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;æˆåŠŸé€šçŸ¥ï¼š&quot;</span>, botData2)</span><br><span class="line">                     <span class="comment"># å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥</span></span><br><span class="line">                    botR2 = requests.post(url=<span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx&#x27;</span>,data=botData2, headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json;charset=utf-8&quot;</span>&#125;)</span><br><span class="line">                    <span class="built_in">print</span>(botR2.content)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;ç‚¹é¤æˆåŠŸï¼&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;ç‚¹é¤å¤±è´¥ï¼&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;ç‚¹é¤å¤±è´¥ï¼&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;æ— å¯ç”¨ä¿¡æ¯:&#x27;</span>, data)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;err&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Good bye!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å®šæ—¶ä»»åŠ¡"><a href="#å®šæ—¶ä»»åŠ¡" class="headerlink" title="å®šæ—¶ä»»åŠ¡"></a>å®šæ—¶ä»»åŠ¡</h2><p>æœ€åç”±äºæœ¬äººç”¨çš„Macï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨äº†<code>launchctl</code>ã€‚</p><h3 id="å®šä¹‰ä»»åŠ¡"><a href="#å®šä¹‰ä»»åŠ¡" class="headerlink" title="å®šä¹‰ä»»åŠ¡"></a>å®šä¹‰ä»»åŠ¡</h3><p>é¦–å…ˆè¿›å…¥<code>~/Library/LaunchAgents</code>,åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶<code>com.meican.plist</code>:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">plist</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="meta-string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dict</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>com.meican.plist<span class="tag">&lt;/<span class="name">string</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Users/zhaojingzhou/workspace/sources/meican.sh<span class="tag">&lt;/<span class="name">string</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>StartCalendarInterval<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dict</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>Minute<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">integer</span>&gt;</span>00<span class="tag">&lt;/<span class="name">integer</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>Hour<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">integer</span>&gt;</span>16<span class="tag">&lt;/<span class="name">integer</span>&gt;</span>  </span><br><span class="line">     <span class="comment">&lt;!-- &lt;key&gt;Day&lt;/key&gt;</span></span><br><span class="line"><span class="comment">      &lt;integer&gt;*&lt;/integer&gt;  --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>Weekday<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">integer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">integer</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">integer</span>&gt;</span>3<span class="tag">&lt;/<span class="name">integer</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">integer</span>&gt;</span>4<span class="tag">&lt;/<span class="name">integer</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">integer</span>&gt;</span>7<span class="tag">&lt;/<span class="name">integer</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">array</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>StandardOutPath<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Users/zhaojingzhou/workspace/sources/stdout<span class="tag">&lt;/<span class="name">string</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>StandardErrorPath<span class="tag">&lt;/<span class="name">key</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Users/zhaojingzhou/workspace/sources/error<span class="tag">&lt;/<span class="name">string</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ProgramArguments"><a href="#ProgramArguments" class="headerlink" title="ProgramArguments"></a>ProgramArguments</h3><p>ä»»åŠ¡æ‰§è¡Œçš„è„šæœ¬ï¼Œæˆ‘è¿™é‡Œç”¨shell å°†ä¸Šé¢å†™çš„Pythonè„šæœ¬åŒ…äº†ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/python3.9 /Users/zhaojingzhou/workspace/sources/meican.py</span><br></pre></td></tr></table></figure><p>è„šæœ¬ä¸€å®šè¦ç»™æ‰§è¡Œæƒé™å•Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 775 xxx.sh</span><br></pre></td></tr></table></figure><h3 id="StartCalendarInterval"><a href="#StartCalendarInterval" class="headerlink" title="StartCalendarInterval"></a>StartCalendarInterval</h3><p>æˆ‘è¿™é‡Œå®šä¹‰çš„æ˜¯å‘¨1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ7ä¸‹åˆ16:00æ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯0ï¼Œ7éƒ½ä»£è¡¨å‘¨æ—¥ã€‚</p><h2 id="OutPath"><a href="#OutPath" class="headerlink" title="OutPath"></a>OutPath</h2><p>StandardOutPathï¼ŒStandardErrorPath ä»£è¡¨æ ‡å‡†è¾“å‡ºï¼Œå’Œé”™è¯¯è¾“å‡ºï¼Œç”¨æ¥æ’æŸ¥è„šæœ¬é”™è¯¯ã€‚</p><h3 id="åŠ è½½ä»»åŠ¡"><a href="#åŠ è½½ä»»åŠ¡" class="headerlink" title="åŠ è½½ä»»åŠ¡"></a>åŠ è½½ä»»åŠ¡</h3><p>æ‰€æœ‰çš„çš„éƒ½å‡†å¤‡å¥½äº†ä¹‹åæ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launchctl load -w com.meican.plist</span><br></pre></td></tr></table></figure><p>å¦‚æœä¿®æ”¹äº†ä»»åŠ¡å®šä¹‰éœ€è¦unloadä¹‹ååœ¨loadï¼Œunloadï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launchctl unload com.meican.plist</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launchctl start com.meican.plist</span><br></pre></td></tr></table></figure><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ç›®å‰è·‘äº†ä¸€æ®µæ—¶é—´ä¸‹æ¥ï¼Œæ„Ÿè§‰è¿˜è¡Œï¼Œå†ä¹Ÿä¸ç”¨é¥¿è‚šå­å•¦ã€‚ã€‚ã€‚</p><p>å¸Œæœ›ç¾é¤åˆ«è°ƒæ•´æ¥å£ã€‚ã€‚ã€‚</p><p><strong>ç å­—ä¸æ˜“ï¼Œä¸”çœ‹ä¸”çæƒœ</strong></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;å…¬å¸å‘˜å·¥é¤é€‰ç”¨çš„ç¾é¤å¹³å°ï¼Œä½†æ˜¯ç»å¸¸ç”±äºå¤ªå¿™å¿˜è®°ç‚¹é¤ï¼Œå¯¼è‡´é¥¿ç€è‚šå­åŠ ç­ã€‚åæ­£èœå“çš„å¯é€‰é¡¹æ¯”è¾ƒå°‘ï¼Œæƒ³ç€è¦æ˜¯èƒ½è‡ªåŠ¨ç‚¹ä¸€ä¸ªå°±å¥½äº†ã€‚äºæ˜¯æœ‰äº†ä»¥ä¸‹è„šæœ¬ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;æ¥å£åˆ†æ&quot;&gt;&lt;a href=&quot;#æ¥å£åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;æ¥å£åˆ†æ&quot;&gt;&lt;/a&gt;æ¥å£åˆ†æ&lt;/h2&gt;&lt;h3 id=&quot;å‚æ•°åˆ†æ&quot;&gt;&lt;a href=&quot;#å‚æ•°åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;å‚æ•°åˆ†æ&quot;&gt;&lt;/a&gt;å‚æ•°åˆ†æ&lt;/h3&gt;&lt;p&gt;è‡ªåŠ¨ç‚¹é¤æ— éå°±æ˜¯æ¨¡æ‹Ÿäººçš„è¡Œä¸ºï¼Œè‡ªåŠ¨è¯·æ±‚ä¸€äº›å…³é”®æ¥å£ã€‚äºæ˜¯åˆ†æäº†ä¸€ä¸‹ç¾é¤ç½‘çš„webç«¯æ¥å£ï¼Œå‘ç°å…³é”®æ¥å£å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è·å–èœå•æ¥å£ï¼š&lt;a href=&quot;https://meican.com/preorder/api/v2.1/restaurants/show?tabUniqueId=???&amp;amp;targetTime=???&amp;amp;restaurantUniqueId=???&amp;amp;client_id=???&amp;amp;client_secret=&quot;&gt;https://meican.com/preorder/api/v2.1/restaurants/show?tabUniqueId=???&amp;amp;targetTime=???&amp;amp;restaurantUniqueId=???&amp;amp;client_id=???&amp;amp;client_secret=&lt;/a&gt;???&lt;/li&gt;
&lt;li&gt;ä¸‹å•æ¥å£ï¼š&lt;a href=&quot;https://meican.com/preorder/api/v2.1/orders/add?client_id=???&amp;amp;client_secret=&quot;&gt;https://meican.com/preorder/api/v2.1/orders/add?client_id=???&amp;amp;client_secret=&lt;/a&gt;???&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æœ‰äº†æ¥å£åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥å¼€å§‹åˆ†æã€å°è¯•æ¥å£çš„å“ªäº›å‚æ•°æ˜¯é™æ€çš„ï¼Œå“ªäº›æ˜¯åŠ¨æ€çš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Pythonéšè®°" scheme="https://jingzhouzhao.github.io/categories/Python%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Python" scheme="https://jingzhouzhao.github.io/tags/Python/"/>
    
    <category term="çˆ¬è™«" scheme="https://jingzhouzhao.github.io/tags/%E7%88%AC%E8%99%AB/"/>
    
    <category term="å®šæ—¶ä»»åŠ¡" scheme="https://jingzhouzhao.github.io/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    
    <category term="launchctl" scheme="https://jingzhouzhao.github.io/tags/launchctl/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºPaxosé‚£äº›ç‚¹</title>
    <link href="https://jingzhouzhao.github.io/archives/e00e37d3.html"/>
    <id>https://jingzhouzhao.github.io/archives/e00e37d3.html</id>
    <published>2021-12-16T06:07:48.000Z</published>
    <updated>2022-02-22T07:31:09.020Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸–ç•Œä¸Šåªæœ‰ä¸€ç§å…±è¯†åè®®ï¼Œå°±æ˜¯ Paxosï¼Œå…¶ä»–æ‰€æœ‰å…±è¯†ç®—æ³•éƒ½æ˜¯ Paxos çš„é€€åŒ–ç‰ˆæœ¬ã€‚</p></blockquote><p>Paxosåˆ†ä¸ºBasic Paxosã€Multi Paxosã€å’Œå…¶å®ƒæ¼”è¿›ç‰ˆæœ¬ã€‚</p><h1 id="Basic-Paxos"><a href="#Basic-Paxos" class="headerlink" title="Basic Paxos"></a>Basic Paxos</h1><p><strong>å‰æï¼šBasic Paxos åªèƒ½å¯¹å•ä¸ªå€¼å½¢æˆå†³è®®ã€‚</strong></p><p>Paxos ç®—æ³•å°†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li><strong>ææ¡ˆèŠ‚ç‚¹</strong>ï¼šç§°ä¸º Proposerï¼Œæå‡ºå¯¹æŸä¸ªå€¼è¿›è¡Œè®¾ç½®æ“ä½œçš„èŠ‚ç‚¹ï¼Œè®¾ç½®å€¼è¿™ä¸ªè¡Œä¸ºå°±è¢«ç§°ä¹‹ä¸º<strong>ææ¡ˆ</strong>ï¼ˆProposalï¼‰ï¼Œå€¼ä¸€æ—¦è®¾ç½®æˆåŠŸï¼Œå°±æ˜¯ä¸ä¼šä¸¢å¤±ä¹Ÿä¸å¯å˜çš„ã€‚è¯·æ³¨æ„ï¼ŒPaxos æ˜¯å…¸å‹çš„åŸºäºæ“ä½œè½¬ç§»æ¨¡å‹è€ŒéçŠ¶æ€è½¬ç§»æ¨¡å‹æ¥è®¾è®¡çš„ç®—æ³•ï¼Œè¿™é‡Œçš„â€œè®¾ç½®å€¼â€ä¸è¦ç±»æ¯”æˆç¨‹åºä¸­å˜é‡èµ‹å€¼æ“ä½œï¼Œåº”è¯¥ç±»æ¯”æˆæ—¥å¿—è®°å½•æ“ä½œï¼Œåœ¨åé¢ä»‹ç»çš„ Raft ç®—æ³•ä¸­å°±ç›´æ¥æŠŠâ€œææ¡ˆâ€å«ä½œâ€œæ—¥å¿—â€äº†ã€‚</li><li><strong>å†³ç­–èŠ‚ç‚¹</strong>ï¼šç§°ä¸º Acceptorï¼Œæ˜¯åº”ç­”ææ¡ˆçš„èŠ‚ç‚¹ï¼Œå†³å®šè¯¥ææ¡ˆæ˜¯å¦å¯è¢«æŠ•ç¥¨ã€æ˜¯å¦å¯è¢«æ¥å—ã€‚ææ¡ˆä¸€æ—¦å¾—åˆ°è¿‡åŠæ•°å†³ç­–èŠ‚ç‚¹çš„æ¥å—ï¼Œå³ç§°è¯¥ææ¡ˆè¢«<strong>æ‰¹å‡†</strong>ï¼ˆAcceptï¼‰ï¼Œææ¡ˆè¢«æ‰¹å‡†å³æ„å‘³ç€è¯¥å€¼ä¸èƒ½å†è¢«æ›´æ”¹ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œä¸”æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ¥å—è¯¥å®ƒã€‚</li><li><strong>è®°å½•èŠ‚ç‚¹</strong>ï¼šè¢«ç§°ä¸º Learnerï¼Œä¸å‚ä¸ææ¡ˆï¼Œä¹Ÿä¸å‚ä¸å†³ç­–ï¼Œåªæ˜¯å•çº¯åœ°ä»ææ¡ˆã€å†³ç­–èŠ‚ç‚¹ä¸­å­¦ä¹ å·²ç»è¾¾æˆå…±è¯†çš„ææ¡ˆï¼Œè­¬å¦‚å°‘æ•°æ´¾èŠ‚ç‚¹ä»ç½‘ç»œåˆ†åŒºä¸­æ¢å¤æ—¶ï¼Œå°†ä¼šè¿›å…¥è¿™ç§çŠ¶æ€ã€‚</li></ul><span id="more"></span><p>Paxos ç®—æ³•åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼Œå…¶ä¸­ï¼Œ<strong>ç¬¬ä¸€é˜¶æ®µâ€œå‡†å¤‡â€ï¼ˆPrepareï¼‰</strong>å°±ç›¸å½“äºä¸Šé¢æŠ¢å é”çš„è¿‡ç¨‹ï¼ˆä¸æ˜¯åŸºäºäº’æ–¥é‡ï¼‰ã€‚å¦‚æœæŸä¸ªææ¡ˆèŠ‚ç‚¹å‡†å¤‡å‘èµ·ææ¡ˆï¼Œå¿…é¡»å…ˆå‘æ‰€æœ‰çš„å†³ç­–èŠ‚ç‚¹å¹¿æ’­ä¸€ä¸ªè®¸å¯ç”³è¯·ï¼ˆç§°ä¸º Prepare è¯·æ±‚ï¼‰ã€‚ææ¡ˆèŠ‚ç‚¹çš„ Prepare è¯·æ±‚ä¸­ä¼šé™„å¸¦ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æ•°å­— n ä½œä¸ºææ¡ˆ IDï¼Œå†³ç­–èŠ‚ç‚¹æ”¶åˆ°åï¼Œå°†ä¼šç»™äºˆ<strong>ææ¡ˆèŠ‚ç‚¹ä¸¤ä¸ªæ‰¿è¯ºä¸ä¸€ä¸ªåº”ç­”</strong>ã€‚</p><p>ä¸¤ä¸ªæ‰¿è¯ºæ˜¯æŒ‡ï¼š</p><ul><li>æ‰¿è¯ºä¸ä¼šå†æ¥å—ææ¡ˆ ID å°äºæˆ–ç­‰äº n çš„ Prepare è¯·æ±‚ã€‚</li><li>æ‰¿è¯ºä¸ä¼šå†æ¥å—ææ¡ˆ ID å°äº n çš„ Accept è¯·æ±‚ã€‚</li></ul><p>ä¸€ä¸ªåº”ç­”æ˜¯æŒ‡ï¼š</p><ul><li>ä¸è¿èƒŒä»¥å‰ä½œå‡ºçš„æ‰¿è¯ºçš„å‰æä¸‹ï¼Œå›å¤å·²ç»æ‰¹å‡†è¿‡çš„ææ¡ˆä¸­ ID æœ€å¤§çš„é‚£ä¸ªææ¡ˆæ‰€è®¾å®šçš„å€¼å’Œææ¡ˆ IDï¼Œå¦‚æœè¯¥å€¼ä»æ¥æ²¡æœ‰è¢«ä»»ä½•ææ¡ˆè®¾å®šè¿‡ï¼Œåˆ™è¿”å›ç©ºå€¼ã€‚å¦‚æœè¿åæ­¤å‰åšå‡ºçš„æ‰¿è¯ºï¼Œå³æ”¶åˆ°çš„ææ¡ˆ ID å¹¶ä¸æ˜¯å†³ç­–èŠ‚ç‚¹æ”¶åˆ°è¿‡çš„æœ€å¤§çš„ï¼Œé‚£å…è®¸ç›´æ¥å¯¹æ­¤ Prepare è¯·æ±‚ä¸äºˆç†ä¼šã€‚</li></ul><p>å½“ææ¡ˆèŠ‚ç‚¹æ”¶åˆ°äº†å¤šæ•°æ´¾å†³ç­–èŠ‚ç‚¹çš„åº”ç­”ï¼ˆç§°ä¸º Promise åº”ç­”ï¼‰åï¼Œå¯ä»¥å¼€å§‹<strong>ç¬¬äºŒé˜¶æ®µâ€œæ‰¹å‡†â€ï¼ˆAcceptï¼‰</strong>è¿‡ç¨‹ï¼Œè¿™æ—¶æœ‰å¦‚ä¸‹ä¸¤ç§å¯èƒ½çš„ç»“æœï¼š</p><ul><li>å¦‚æœææ¡ˆèŠ‚ç‚¹å‘ç°æ‰€æœ‰å“åº”çš„å†³ç­–èŠ‚ç‚¹æ­¤å‰éƒ½æ²¡æœ‰æ‰¹å‡†è¿‡è¯¥å€¼ï¼ˆå³ä¸ºç©ºï¼‰ï¼Œé‚£è¯´æ˜å®ƒæ˜¯ç¬¬ä¸€ä¸ªè®¾ç½®å€¼çš„èŠ‚ç‚¹ï¼Œå¯ä»¥éšæ„åœ°å†³å®šè¦è®¾å®šçš„å€¼ï¼Œå°†è‡ªå·±é€‰å®šçš„å€¼ä¸ææ¡ˆ IDï¼Œæ„æˆä¸€ä¸ªäºŒå…ƒç»„â€œ(id, value)â€ï¼Œå†æ¬¡å¹¿æ’­ç»™å…¨éƒ¨çš„å†³ç­–èŠ‚ç‚¹ï¼ˆç§°ä¸º Accept è¯·æ±‚ï¼‰ã€‚</li><li>å¦‚æœææ¡ˆèŠ‚ç‚¹å‘ç°å“åº”çš„å†³ç­–èŠ‚ç‚¹ä¸­ï¼Œå·²ç»æœ‰è‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹çš„åº”ç­”ä¸­åŒ…å«æœ‰å€¼äº†ï¼Œé‚£å®ƒå°±ä¸èƒ½å¤Ÿéšæ„å–å€¼äº†ï¼Œå¿…é¡»æ— æ¡ä»¶åœ°ä»åº”ç­”ä¸­æ‰¾å‡ºææ¡ˆ ID æœ€å¤§çš„é‚£ä¸ªå€¼å¹¶æ¥å—ï¼Œæ„æˆä¸€ä¸ªäºŒå…ƒç»„â€œ(id, maxAcceptValue)â€ï¼Œå†æ¬¡å¹¿æ’­ç»™å…¨éƒ¨çš„å†³ç­–èŠ‚ç‚¹ï¼ˆç§°ä¸º Accept è¯·æ±‚ï¼‰ã€‚</li></ul><p>å½“æ¯ä¸€ä¸ªå†³ç­–èŠ‚ç‚¹æ”¶åˆ° Accept è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šåœ¨ä¸è¿èƒŒä»¥å‰ä½œå‡ºçš„æ‰¿è¯ºçš„å‰æä¸‹ï¼Œæ¥æ”¶å¹¶æŒä¹…åŒ–å¯¹å½“å‰ææ¡ˆ ID å’Œææ¡ˆé™„å¸¦çš„å€¼ã€‚å¦‚æœè¿åæ­¤å‰åšå‡ºçš„æ‰¿è¯ºï¼Œå³æ”¶åˆ°çš„ææ¡ˆ ID å¹¶ä¸æ˜¯å†³ç­–èŠ‚ç‚¹æ”¶åˆ°è¿‡çš„æœ€å¤§çš„ï¼Œé‚£å…è®¸ç›´æ¥å¯¹æ­¤ Accept è¯·æ±‚ä¸äºˆç†ä¼šã€‚</p><p>å…³äº<strong>æ´»é”</strong>ï¼š</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/jc4j75h9ha-1639635295709.png">ä¸¤ä¸ªææ¡ˆèŠ‚ç‚¹äº’ä¸ç›¸è®©åœ°äº‰ç›¸æå‡ºè‡ªå·±çš„ææ¡ˆï¼ŒæŠ¢å åŒä¸€ä¸ªå€¼çš„ä¿®æ”¹æƒé™ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿåœ¨æŒç»­æ€§åœ°â€œåå¤æ¨ªè·³â€ï¼Œå¤–éƒ¨çœ‹èµ·æ¥å°±åƒè¢«é”ä½äº†ä¸€æ ·</p><h1 id="Multi-Paxos"><a href="#Multi-Paxos" class="headerlink" title="Multi Paxos"></a>Multi Paxos</h1><p>Multi Paxos å¯¹ Basic Paxos çš„æ ¸å¿ƒæ”¹è¿›æ˜¯<strong>å¢åŠ äº†â€œé€‰ä¸»â€çš„è¿‡ç¨‹</strong>ï¼Œææ¡ˆèŠ‚ç‚¹ä¼šé€šè¿‡å®šæ—¶è½®è¯¢ï¼ˆå¿ƒè·³ï¼‰ï¼Œç¡®å®šå½“å‰ç½‘ç»œä¸­çš„æ‰€æœ‰èŠ‚ç‚¹é‡Œæ˜¯å¦å­˜åœ¨æœ‰ä¸€ä¸ªä¸»ææ¡ˆèŠ‚ç‚¹ï¼Œä¸€æ—¦æ²¡æœ‰å‘ç°ä¸»èŠ‚ç‚¹å­˜åœ¨ï¼ŒèŠ‚ç‚¹å°±ä¼šåœ¨å¿ƒè·³è¶…æ—¶å<strong>ä½¿ç”¨ Basic Paxos ä¸­å®šä¹‰çš„å‡†å¤‡ã€æ‰¹å‡†çš„ä¸¤è½®ç½‘ç»œäº¤äº’è¿‡ç¨‹ï¼Œå‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¹¿æ’­è‡ªå·±å¸Œæœ›ç«é€‰ä¸»èŠ‚ç‚¹çš„è¯·æ±‚</strong>ï¼Œå¸Œæœ›æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹â€œç”±æˆ‘ä½œä¸ºä¸»èŠ‚ç‚¹â€è¿™ä»¶äº‹æƒ…åå•†è¾¾æˆä¸€è‡´å…±è¯†ï¼Œå¦‚æœå¾—åˆ°äº†å†³ç­–èŠ‚ç‚¹ä¸­å¤šæ•°æ´¾çš„æ‰¹å‡†ï¼Œä¾¿å®£å‘Šç«é€‰æˆåŠŸã€‚å½“é€‰ä¸»å®Œæˆä¹‹åï¼Œé™¤éä¸»èŠ‚ç‚¹å¤±è”ä¹‹åå‘èµ·é‡æ–°ç«é€‰ï¼Œå¦åˆ™ä»æ­¤å¾€åï¼Œå°±åªæœ‰ä¸»èŠ‚ç‚¹æœ¬èº«æ‰èƒ½å¤Ÿæå‡ºææ¡ˆã€‚æ­¤æ—¶ï¼Œæ— è®ºå“ªä¸ªææ¡ˆèŠ‚ç‚¹æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ“ä½œè¯·æ±‚ï¼Œéƒ½ä¼šå°†è¯·æ±‚è½¬å‘ç»™ä¸»èŠ‚ç‚¹æ¥å®Œæˆææ¡ˆï¼Œè€Œä¸»èŠ‚ç‚¹ææ¡ˆçš„æ—¶å€™ï¼Œä¹Ÿå°±æ— éœ€å†æ¬¡ç»è¿‡å‡†å¤‡è¿‡ç¨‹ï¼Œå› ä¸ºå¯ä»¥è§†ä½œæ˜¯<strong>ç»è¿‡é€‰ä¸¾æ—¶çš„é‚£ä¸€æ¬¡å‡†å¤‡ä¹‹åï¼Œåç»­çš„ææ¡ˆéƒ½æ˜¯å¯¹ç›¸åŒææ¡ˆ ID çš„ä¸€è¿ä¸²çš„æ‰¹å‡†è¿‡ç¨‹ã€‚ä¹Ÿå¯ä»¥é€šä¿—ç†è§£ä¸ºé€‰ä¸»è¿‡åï¼Œå°±ä¸ä¼šå†æœ‰å…¶ä»–èŠ‚ç‚¹ä¸å®ƒç«äº‰ï¼Œç›¸å½“äºæ˜¯å¤„äºæ— å¹¶å‘çš„ç¯å¢ƒå½“ä¸­è¿›è¡Œçš„æœ‰åºæ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶ç³»ç»Ÿä¸­è¦å¯¹æŸä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œåªéœ€è¦è¿›è¡Œä¸€æ¬¡æ‰¹å‡†çš„äº¤äº’å³å¯</strong></p><p>å¯èƒ½æœ‰äººæ³¨æ„åˆ°è¿™æ—¶å€™çš„äºŒå…ƒç»„(id, value)å·²ç»å˜æˆäº†ä¸‰å…ƒç»„(id, i, value)ï¼Œè¿™æ˜¯å› ä¸ºéœ€è¦ç»™<strong>ä¸»èŠ‚ç‚¹å¢åŠ ä¸€ä¸ªâ€œä»»æœŸç¼–å·â€ï¼Œè¿™ä¸ªç¼–å·å¿…é¡»æ˜¯ä¸¥æ ¼å•è°ƒé€’å¢çš„ï¼Œä»¥åº”ä»˜ä¸»èŠ‚ç‚¹é™·å…¥ç½‘ç»œåˆ†åŒºåé‡æ–°æ¢å¤ï¼Œä½†å¦å¤–ä¸€éƒ¨åˆ†èŠ‚ç‚¹ä»ç„¶æœ‰å¤šæ•°æ´¾ï¼Œä¸”å·²ç»å®Œæˆäº†é‡æ–°é€‰ä¸»çš„æƒ…å†µï¼Œæ­¤æ—¶å¿…é¡»ä»¥ä»»æœŸç¼–å·å¤§çš„ä¸»èŠ‚ç‚¹ä¸ºå‡†</strong>ã€‚å½“èŠ‚ç‚¹æœ‰äº†é€‰ä¸»æœºåˆ¶çš„æ”¯æŒï¼Œåœ¨æ•´ä½“æ¥çœ‹ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–èŠ‚ç‚¹è§’è‰²ï¼Œä¸å»åŒºåˆ†ææ¡ˆã€å†³ç­–å’Œè®°å½•èŠ‚ç‚¹äº†ï¼Œç»Ÿç»Ÿä»¥â€œèŠ‚ç‚¹â€æ¥ä»£æ›¿ï¼ŒèŠ‚ç‚¹åªæœ‰ä¸»ï¼ˆLeaderï¼‰å’Œä»ï¼ˆFollowerï¼‰çš„åŒºåˆ«</p><h2 id="æ¥æº"><a href="#æ¥æº" class="headerlink" title="æ¥æº"></a>æ¥æº</h2><p><a href="http://icyfenix.cn/distribution/consensus/paxos.html">http://icyfenix.cn/distribution/consensus/paxos.html</a></p><p><a href="http://icyfenix.cn/distribution/consensus/raft.html">http://icyfenix.cn/distribution/consensus/raft.html</a></p><p><a href="https://acehi.github.io/thesecretlivesofdata-cn/raft/">https://acehi.github.io/thesecretlivesofdata-cn/raft/</a></p>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;ä¸–ç•Œä¸Šåªæœ‰ä¸€ç§å…±è¯†åè®®ï¼Œå°±æ˜¯ Paxosï¼Œå…¶ä»–æ‰€æœ‰å…±è¯†ç®—æ³•éƒ½æ˜¯ Paxos çš„é€€åŒ–ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Paxosåˆ†ä¸ºBasic Paxosã€Multi Paxosã€å’Œå…¶å®ƒæ¼”è¿›ç‰ˆæœ¬ã€‚&lt;/p&gt;
&lt;h1 id=&quot;Basic-Paxos&quot;&gt;&lt;a href=&quot;#Basic-Paxos&quot; class=&quot;headerlink&quot; title=&quot;Basic Paxos&quot;&gt;&lt;/a&gt;Basic Paxos&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;å‰æï¼šBasic Paxos åªèƒ½å¯¹å•ä¸ªå€¼å½¢æˆå†³è®®ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Paxos ç®—æ³•å°†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç±»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ææ¡ˆèŠ‚ç‚¹&lt;/strong&gt;ï¼šç§°ä¸º Proposerï¼Œæå‡ºå¯¹æŸä¸ªå€¼è¿›è¡Œè®¾ç½®æ“ä½œçš„èŠ‚ç‚¹ï¼Œè®¾ç½®å€¼è¿™ä¸ªè¡Œä¸ºå°±è¢«ç§°ä¹‹ä¸º&lt;strong&gt;ææ¡ˆ&lt;/strong&gt;ï¼ˆProposalï¼‰ï¼Œå€¼ä¸€æ—¦è®¾ç½®æˆåŠŸï¼Œå°±æ˜¯ä¸ä¼šä¸¢å¤±ä¹Ÿä¸å¯å˜çš„ã€‚è¯·æ³¨æ„ï¼ŒPaxos æ˜¯å…¸å‹çš„åŸºäºæ“ä½œè½¬ç§»æ¨¡å‹è€ŒéçŠ¶æ€è½¬ç§»æ¨¡å‹æ¥è®¾è®¡çš„ç®—æ³•ï¼Œè¿™é‡Œçš„â€œè®¾ç½®å€¼â€ä¸è¦ç±»æ¯”æˆç¨‹åºä¸­å˜é‡èµ‹å€¼æ“ä½œï¼Œåº”è¯¥ç±»æ¯”æˆæ—¥å¿—è®°å½•æ“ä½œï¼Œåœ¨åé¢ä»‹ç»çš„ Raft ç®—æ³•ä¸­å°±ç›´æ¥æŠŠâ€œææ¡ˆâ€å«ä½œâ€œæ—¥å¿—â€äº†ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å†³ç­–èŠ‚ç‚¹&lt;/strong&gt;ï¼šç§°ä¸º Acceptorï¼Œæ˜¯åº”ç­”ææ¡ˆçš„èŠ‚ç‚¹ï¼Œå†³å®šè¯¥ææ¡ˆæ˜¯å¦å¯è¢«æŠ•ç¥¨ã€æ˜¯å¦å¯è¢«æ¥å—ã€‚ææ¡ˆä¸€æ—¦å¾—åˆ°è¿‡åŠæ•°å†³ç­–èŠ‚ç‚¹çš„æ¥å—ï¼Œå³ç§°è¯¥ææ¡ˆè¢«&lt;strong&gt;æ‰¹å‡†&lt;/strong&gt;ï¼ˆAcceptï¼‰ï¼Œææ¡ˆè¢«æ‰¹å‡†å³æ„å‘³ç€è¯¥å€¼ä¸èƒ½å†è¢«æ›´æ”¹ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œä¸”æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ¥å—è¯¥å®ƒã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è®°å½•èŠ‚ç‚¹&lt;/strong&gt;ï¼šè¢«ç§°ä¸º Learnerï¼Œä¸å‚ä¸ææ¡ˆï¼Œä¹Ÿä¸å‚ä¸å†³ç­–ï¼Œåªæ˜¯å•çº¯åœ°ä»ææ¡ˆã€å†³ç­–èŠ‚ç‚¹ä¸­å­¦ä¹ å·²ç»è¾¾æˆå…±è¯†çš„ææ¡ˆï¼Œè­¬å¦‚å°‘æ•°æ´¾èŠ‚ç‚¹ä»ç½‘ç»œåˆ†åŒºä¸­æ¢å¤æ—¶ï¼Œå°†ä¼šè¿›å…¥è¿™ç§çŠ¶æ€ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="Paxos" scheme="https://jingzhouzhao.github.io/tags/Paxos/"/>
    
    <category term="ä¸€è‡´æ€§" scheme="https://jingzhouzhao.github.io/tags/%E4%B8%80%E8%87%B4%E6%80%A7/"/>
    
  </entry>
  
  <entry>
    <title>åšå®¢ç”¨çš„å›¾åºŠæŒ‚äº†</title>
    <link href="https://jingzhouzhao.github.io/archives/2baffaa5.html"/>
    <id>https://jingzhouzhao.github.io/archives/2baffaa5.html</id>
    <published>2021-12-01T09:35:02.000Z</published>
    <updated>2022-02-22T07:31:09.022Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰ä¸æƒ³æŠŠåšå®¢é‡Œé¢çš„å›¾ç‰‡ä¹Ÿä¸€åŒä¸Šä¼ ï¼Œç”¨äº†utoolsé‡Œé¢ä¸€ä¸ªé»˜è®¤çš„å…è´¹å›¾åºŠï¼Œç»“æœä»Šå¤©å‘ç°å¥½åƒå›¾åºŠæŒ‚æ‰äº†ã€‚ä¹‹å‰å†™çš„åšå®¢é‡Œé¢çš„å›¾ç‰‡å…¨æŒ‚äº†ã€‚ã€‚ã€‚æœæ–­æ¢äº†giteeåšæ–°çš„å›¾åºŠã€‚</p><p><img src="https://gitee.com/zhaojingzhou/filebed/raw/master/l19rbp0xbd-1638351541087.png"></p><p>è¿™ä¸ä¼šå†æŒ‚äº†å§ã€‚ã€‚ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¹‹å‰ä¸æƒ³æŠŠåšå®¢é‡Œé¢çš„å›¾ç‰‡ä¹Ÿä¸€åŒä¸Šä¼ ï¼Œç”¨äº†utoolsé‡Œé¢ä¸€ä¸ªé»˜è®¤çš„å…è´¹å›¾åºŠï¼Œç»“æœä»Šå¤©å‘ç°å¥½åƒå›¾åºŠæŒ‚æ‰äº†ã€‚ä¹‹å‰å†™çš„åšå®¢é‡Œé¢çš„å›¾ç‰‡å…¨æŒ‚äº†ã€‚ã€‚ã€‚æœæ–­æ¢äº†giteeåšæ–°çš„å›¾åºŠã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/zhaojingzhou/file</summary>
      
    
    
    
    <category term="è¸©å‘è®°å½•" scheme="https://jingzhouzhao.github.io/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="å›¾åºŠ" scheme="https://jingzhouzhao.github.io/tags/%E5%9B%BE%E5%BA%8A/"/>
    
    <category term="åšå®¢" scheme="https://jingzhouzhao.github.io/tags/%E5%8D%9A%E5%AE%A2/"/>
    
  </entry>
  
  <entry>
    <title>Mybatis Mapper æºç åˆ†æ</title>
    <link href="https://jingzhouzhao.github.io/archives/fb5cf917.html"/>
    <id>https://jingzhouzhao.github.io/archives/fb5cf917.html</id>
    <published>2021-09-22T06:26:02.000Z</published>
    <updated>2022-02-22T07:31:09.009Z</updated>
    
    <content type="html"><![CDATA[<p>å¤©å¤©éƒ½åœ¨ç”¨çš„Mybatisï¼Œä¸ºå•¥è°ƒç”¨ä¸€ä¸ªMapperæ¥å£å°±èƒ½æ‰§è¡ŒSQLï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ</p><p>è¿™ä¸€åˆ‡éƒ½å¾—ä» <code>@MapperScan</code> è¿™ä¸ªæ³¨è§£å¼€å§‹è¯´èµ·ã€‚æ‰“å¼€è¿™ä¸ªæ³¨è§£å®šä¹‰å¯ä»¥çœ‹åˆ°ï¼š</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123;MapperScannerRegistrar.class&#125;)</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å…ƒæ³¨è§£ä¸­é‡ç‚¹å…³æ³¨<code>@Import(MapperScannerRegistrar.class)</code>ï¼Œè¿™æ˜¯Springçš„ä¸€ä¸ªæ³¨è§£ï¼Œå…è®¸å¯¼å…¥@Configurationç±»ã€ ImportSelectorå’ŒImportBeanDefinitionRegistrarå®ç°ã€‚å¾ˆæ˜æ˜¾<code>MapperScannerRegistrar.class</code> åº”è¯¥æ˜¯<code>ImportBeanDefinitionRegistrar</code>çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperScannerRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    AnnotationAttributes annoAttrs = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(MapperScan.class.getName()));</span><br><span class="line">    ClassPathMapperScanner scanner = <span class="keyword">new</span> ClassPathMapperScanner(registry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this check is needed in Spring 3.1</span></span><br><span class="line">    <span class="keyword">if</span> (resourceLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">      scanner.setResourceLoader(resourceLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Annotation&gt; annotationClass = annoAttrs.getClass(<span class="string">&quot;annotationClass&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Annotation.class.equals(annotationClass)) &#123;</span><br><span class="line">      scanner.setAnnotationClass(annotationClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; markerInterface = annoAttrs.getClass(<span class="string">&quot;markerInterface&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Class.class.equals(markerInterface)) &#123;</span><br><span class="line">      scanner.setMarkerInterface(markerInterface);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass = annoAttrs.getClass(<span class="string">&quot;nameGenerator&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!BeanNameGenerator.class.equals(generatorClass)) &#123;</span><br><span class="line">      scanner.setBeanNameGenerator(BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends MapperFactoryBean&gt; mapperFactoryBeanClass = annoAttrs.getClass(<span class="string">&quot;factoryBean&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) &#123;</span><br><span class="line">      scanner.setMapperFactoryBean(BeanUtils.instantiateClass(mapperFactoryBeanClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(annoAttrs.getString(<span class="string">&quot;sqlSessionTemplateRef&quot;</span>));</span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(annoAttrs.getString(<span class="string">&quot;sqlSessionFactoryRef&quot;</span>));</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; basePackages = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String pkg : annoAttrs.getStringArray(<span class="string">&quot;value&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(pkg)) &#123;</span><br><span class="line">        basePackages.add(pkg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String pkg : annoAttrs.getStringArray(<span class="string">&quot;basePackages&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(pkg)) &#123;</span><br><span class="line">        basePackages.add(pkg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; clazz : annoAttrs.getClassArray(<span class="string">&quot;basePackageClasses&quot;</span>)) &#123;</span><br><span class="line">      basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">    &#125;</span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">    scanner.doScan(StringUtils.toStringArray(basePackages));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢ä»£ç åœ¨åšä¸€ä»¶äº‹ï¼Œå°±æ˜¯åˆå§‹åŒ–<code>ClassPathMapperScanner</code>ï¼Œæœ€åè°ƒç”¨äº†<code>doScan</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassPathMapperScanner</span> <span class="keyword">extends</span> <span class="title">ClassPathBeanDefinitionScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">doScan</span><span class="params">(String... basePackages)</span> </span>&#123;</span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">super</span>.doScan(basePackages);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (beanDefinitions.isEmpty()) &#123;</span><br><span class="line">      logger.warn(<span class="string">&quot;No MyBatis mapper was found in &#x27;&quot;</span> + Arrays.toString(basePackages) + <span class="string">&quot;&#x27; package. Please check your configuration.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      processBeanDefinitions(beanDefinitions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨äº†çˆ¶ç±»çš„doScanï¼Œé‡Œé¢çš„ä¸»è¦é€»è¾‘æ˜¯æŸ¥æ‰¾æŒ‡å®šçš„basePackagesä¸‹çš„æ‰€æœ‰Componentsï¼Œå³å£°æ˜äº†<code>@Component</code>ä»¥åŠå°†<code>@Component</code>ä½œä¸ºå…ƒæ³¨è§£çš„æ³¨è§£ï¼Œä¾‹å¦‚<code>@Repository</code>ï¼Œ<br>æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ï¼š</p><ul><li>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#findCandidateComponents</li><li>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#isCandidateComponent(org.springframework.core.type.classreading.MetadataReader)</li><li>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#registerDefaultFilters</li><li>org.springframework.core.type.filter.AnnotationTypeFilter#hasAnnotation</li><li>org.springframework.core.annotation.AnnotationUtils#getAnnotation(java.lang.reflect.AnnotatedElement, java.lang.Class<A>)</A></li></ul><p>æ¥ä¸‹æ¥è°ƒç”¨äº†<code>processBeanDefinitions</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processBeanDefinitions</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> </span>&#123;</span><br><span class="line">    GenericBeanDefinition definition;</span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;</span><br><span class="line">      definition = (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Creating MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() </span><br><span class="line">          + <span class="string">&quot;&#x27; and &#x27;&quot;</span> + definition.getBeanClassName() + <span class="string">&quot;&#x27; mapperInterface&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// the mapper interface is the original class of the bean</span></span><br><span class="line">      <span class="comment">// but, the actual class of the bean is MapperFactoryBean</span></span><br><span class="line">      definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); <span class="comment">// issue #59</span></span><br><span class="line">      definition.setBeanClass(<span class="keyword">this</span>.mapperFactoryBean.getClass());</span><br><span class="line"></span><br><span class="line">      definition.getPropertyValues().add(<span class="string">&quot;addToConfig&quot;</span>, <span class="keyword">this</span>.addToConfig);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> explicitFactoryUsed = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.sqlSessionFactoryBeanName)) &#123;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">&quot;sqlSessionFactory&quot;</span>, <span class="keyword">new</span> RuntimeBeanReference(<span class="keyword">this</span>.sqlSessionFactoryBeanName));</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sqlSessionFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">&quot;sqlSessionFactory&quot;</span>, <span class="keyword">this</span>.sqlSessionFactory);</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.sqlSessionTemplateBeanName)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (explicitFactoryUsed) &#123;</span><br><span class="line">          logger.warn(<span class="string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">&quot;sqlSessionTemplate&quot;</span>, <span class="keyword">new</span> RuntimeBeanReference(<span class="keyword">this</span>.sqlSessionTemplateBeanName));</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sqlSessionTemplate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (explicitFactoryUsed) &#123;</span><br><span class="line">          logger.warn(<span class="string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.getPropertyValues().add(<span class="string">&quot;sqlSessionTemplate&quot;</span>, <span class="keyword">this</span>.sqlSessionTemplate);</span><br><span class="line">        explicitFactoryUsed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!explicitFactoryUsed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Enabling autowire by type for MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="string">&quot;&#x27;.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹çœ‹çœ‹è¿™ä¸¤è¡Œä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); </span><br><span class="line">definition.setBeanClass(<span class="keyword">this</span>.mapperFactoryBean.getClass());</span><br></pre></td></tr></table></figure><p>ä¼¼ä¹å·²ç»å¯ä»¥çœ‹å‡ºç‚¹è››ä¸é©¬è¿¹ï¼Œè¿™é‡Œå°†Mapperçš„BeanDefinitionçš„BeanClassæ›¿æ¢ä¸ºäº†<code>this.mapperFactoryBean.getClass()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MapperFactoryBean&lt;?&gt; mapperFactoryBean = <span class="keyword">new</span> MapperFactoryBean&lt;Object&gt;();</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”å°†åŸæœ¬çš„BeanClassæ·»åŠ ä¸ºäº†æ„é€ å‡½æ•°å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); </span><br></pre></td></tr></table></figure><p>ç†Ÿæ‚‰Springçš„åº”è¯¥éƒ½çŸ¥é“ï¼ŒSpringåŠ è½½å®ŒBeanDefinitionåä¼šé€šè¿‡BeanClassæ¥å»å®ä¾‹åŒ–Beanï¼Œè¿™é‡Œçš„BeanClassè¢«æ›¿æ¢ä¸ºäº†ä¸€ä¸ªFactoryBeanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperFactoryBean</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> addToConfig = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//intentionally empty </span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperFactoryBean</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkDaoConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.checkDaoConfig();</span><br><span class="line"></span><br><span class="line">    notNull(<span class="keyword">this</span>.mapperInterface, <span class="string">&quot;Property &#x27;mapperInterface&#x27; is required&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Configuration configuration = getSqlSession().getConfiguration();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.addToConfig &amp;&amp; !configuration.hasMapper(<span class="keyword">this</span>.mapperInterface)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        configuration.addMapper(<span class="keyword">this</span>.mapperInterface);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Error while adding the mapper &#x27;&quot;</span> + <span class="keyword">this</span>.mapperInterface + <span class="string">&quot;&#x27; to configuration.&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getSqlSession().getMapper(<span class="keyword">this</span>.mapperInterface);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getObjectType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------- mutators --------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Sets the mapper interface of the MyBatis mapper</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> mapperInterface class of the interface</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMapperInterface</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Return the mapper interface of the MyBatis mapper</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> class of the interface</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getMapperInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * If addToConfig is false the mapper will not be added to MyBatis. This means</span></span><br><span class="line"><span class="comment">   * it must have been included in mybatis-config.xml.</span></span><br><span class="line"><span class="comment">   * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">   * If it is true, the mapper will be added to MyBatis in the case it is not already</span></span><br><span class="line"><span class="comment">   * registered.</span></span><br><span class="line"><span class="comment">   * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">   * By default addToCofig is true.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> addToConfig</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddToConfig</span><span class="params">(<span class="keyword">boolean</span> addToConfig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.addToConfig = addToConfig;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Return the flag for addition into MyBatis config.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> true if the mapper will be added to MyBatis in the case it is not already</span></span><br><span class="line"><span class="comment">   * registered.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAddToConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addToConfig;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¹‹å‰é‚£ä¸ªè¢«æ³¨å†Œçš„æ„é€ å‡½æ•°å‚æ•°åº”è¯¥å°±æ˜¯åœ¨è¿™è¢«ä½¿ç”¨çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">MapperFactoryBean</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring å…³äºè¿™ä¸ªBeanæ„é€ å‡½æ•°çš„å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#autowireConstructor</span><br><span class="line"><span class="comment">// Need to determine the constructor...</span></span><br><span class="line">Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line"><span class="keyword">if</span> (ctors != <span class="keyword">null</span> ||</span><br><span class="line">mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line"><span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>æ€»ä¹‹ï¼ŒSpringé€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª MapperFactoryBean å¯¹è±¡ã€‚æ¥ä¸‹æ¥Springå»åˆå§‹åŒ–è¿™ä¸ªBeanï¼ŒSpringå¯¹FactoryBeanæœ‰ç‰¹æ®Šå¤„ç†ï¼Œå®é™…ä¼šè°ƒç”¨getObjectæ–¹æ³•è¿”å›å…·ä½“çš„Beanã€‚<br>æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.support.FactoryBeanRegistrySupport#doGetObjectFromFactoryBean</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹åˆå›åˆ°äº†MapperFactoryBeanä¸­ï¼Œæ¥çœ‹çœ‹getObjectï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> getSqlSession().getMapper(<span class="keyword">this</span>.mapperInterface);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†çˆ¶ç±»getSqlSession()æ–¹æ³•è·å¾—SqlSessionï¼Œç„¶åè°ƒç”¨getMapperï¼Œä¼ å…¥äº†å½“å‰å®é™…çš„Mapperã€‚é€šè¿‡ï¼š</p><ul><li>org.apache.ibatis.session.SqlSessionFactoryBuilder#build(org.apache.ibatis.session.Configuration)</li><li>org.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource</li></ul><p>å¯ä»¥çŸ¥é“SqlSessionå®é™…çš„ç±»å‹åº”è¯¥æ˜¯<code>DefaultSqlSession</code>ï¼Œçœ‹çœ‹getMapperï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> configuration.&lt;T&gt;getMapper(type, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆè°ƒç”¨äº†<code>configuration</code>çš„getMapperï¼Œconfigurationåˆå§‹åŒ–å¯ä»¥çœ‹çœ‹<code>org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory</code>ï¼Œ<br>æˆ‘ä»¬å†™çš„SQLå°±æ˜¯åœ¨è¿™ä¸ªé‡Œé¢è¢«è§£æçš„ã€‚åˆ°è¿™é‡Œå·²ç»åŸºæœ¬å¾ˆæ¸…æ™°äº†ã€‚æ¥ç€çœ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//configurationä¸­çš„getMapper</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MapperRegistryä¸­çš„getMapper</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Type &quot;</span> + type + <span class="string">&quot; is not known to the MapperRegistry.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å…³é”®å°±æ˜¯ <code>MapperProxyFactory</code>äº†ï¼Œè¿™ä¸ªæ˜¯åœ¨ <code>org.apache.ibatis.binding.MapperRegistry#addMapper</code>  æ—¶ä¼šä¸ºæ¯ä¸ªMapperç»‘å®šä¸€ä¸ªã€‚<br>çœ‹newInstanceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆMapperæ³¨å†Œåˆ°BeanFactoryä¸­çš„æ˜¯ä¸€ä¸ªä»£ç†ç±»<code>MapperProxy</code>ï¼Œæˆ‘ä»¬çŸ¥é“è¢«ä»£ç†çš„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè¢«è½¬å‘åˆ°ä»£ç†ç±»çš„<code>invoke</code>æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">       <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDefaultMethod(method)) &#123;</span><br><span class="line">       <span class="keyword">return</span> invokeDefaultMethod(proxy, method, args);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">     <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">   <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œä¹Ÿä¸æ˜¯Mapperæ¥å£çš„defaultï¼ˆé»˜è®¤ï¼‰æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨çš„æ˜¯<code>mapperMethod.execute(sqlSession, args)</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">switch</span> (command.getType()) &#123;</span><br><span class="line">      <span class="keyword">case</span> INSERT: &#123;</span><br><span class="line">      Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SELECT:</span><br><span class="line">        <span class="keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMany()) &#123;</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Unknown execution method for: &quot;</span> + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">&quot;Mapper method &#x27;&quot;</span> + command.getName() </span><br><span class="line">          + <span class="string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="string">&quot;).&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™å°±å·®ä¸å¤šäº†å§ï¼Ÿåé¢å·²ç»æ²¡å•¥å¥½è¯´äº†ï¼ŒåŸºæœ¬å°±æ˜¯é€šè¿‡statement nameæ‰¾åˆ°MappedStatementç„¶åå»æ‰§è¡Œsqläº†ã€‚</p><p>å¦å¤–ä¸€ä¸ªå°çŸ¥è¯†ï¼ŒMybatisæ˜¯æ€ä¹ˆåœ¨æ’å…¥ä¹‹åè¿”å›è‡ªå¢ä¸»é”®çš„ï¼Ÿç­”æ¡ˆå°±åœ¨ï¼š</p><ul><li>org.apache.ibatis.executor.statement.PreparedStatementHandler#update</li><li>org.apache.ibatis.executor.keygen.KeyGenerator#processAfter</li></ul><h3 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h3><p>Springä»£ç å®åœ¨å¤ªéš¾çœ‹äº†ï¼Œä¸€ç¯å¥—ä¸€ç¯ï¼Œå„ç§é€’å½’ï¼Œå¿…é¡»debugæ‰èƒ½çœ‹æ¸…ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¤©å¤©éƒ½åœ¨ç”¨çš„Mybatisï¼Œä¸ºå•¥è°ƒç”¨ä¸€ä¸ªMapperæ¥å£å°±èƒ½æ‰§è¡ŒSQLï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ&lt;/p&gt;
&lt;p&gt;è¿™ä¸€åˆ‡éƒ½å¾—ä» &lt;code&gt;@MapperScan&lt;/code&gt; è¿™ä¸ªæ³¨è§£å¼€å§‹è¯´èµ·ã€‚æ‰“å¼€è¿™ä¸ªæ³¨è§£å®šä¹‰å¯ä»¥çœ‹åˆ°ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>è¢«Chromeä¸€ä¸ªbugå‘äº†</title>
    <link href="https://jingzhouzhao.github.io/archives/6e43fa1b.html"/>
    <id>https://jingzhouzhao.github.io/archives/6e43fa1b.html</id>
    <published>2021-09-03T08:58:50.000Z</published>
    <updated>2022-02-22T07:31:09.024Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://files.catbox.moe/xbwdlv.png"></p><p>ç›¸ä¿¡Chromeæµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„Previewä½ ä¸é™Œç”Ÿï¼Œä½†æ˜¯å°±è¿™ç©æ„æœ‰ä¸€ä¸ªbugã€‚</p><p>äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œå‰ç«¯è·Ÿæˆ‘è¯´ä½ æ¥å£æœ‰bugï¼Œè¿”å›çš„æ•°æ®ä¸æ­£ç¡®ã€‚å¬åˆ°bugï¼Œæˆ‘åæ‰‹å°±æ˜¯ä¸€ä¸ªä½ ä¼šä¸ä¼šç”¨ã€‚</p><span id="more"></span><p>ä»–å‘æ¥äº†ä¸€ä¸ªæˆªå›¾ï¼š</p><p><img src="https://files.catbox.moe/b7x3tw.png"></p><p>æˆ‘ç»™ä»–è¿”å›çš„jsonä¸­æœ‰ä¸€ä¸ª<code>max</code>å­—æ®µï¼Œå€¼æ˜¯<code>100000000000000</code> ,æ­£ç¡®çš„åº”è¯¥æ˜¯<code>99999999999999.99999999999999999999</code>,ä½ å…ˆåˆ«ç®¡ä¸ºä»€ä¹ˆæ˜¯è¿™ä¹ˆä¸ªå€¼ã€‚</p><p>å¥½äº†ï¼Œä»–æ‹¿å‡ºè¯æ®äº†ï¼Œæˆ‘å¼€å§‹æ€€ç–‘çœŸçš„æ˜¯å“ªé‡Œå†™çš„æœ‰é—®é¢˜äº†ï¼Œä¸€é¡¿æŸ¥æ‰¾ï¼Œå‘ç°TMDå“ªé‡Œéƒ½æ²¡æœ‰é—®é¢˜å•Šï¼Œæ€ä¹ˆå¯èƒ½ï¼Œæ€ä¹ˆä¼šå‘¢ï¼Ÿ</p><p>ä¸­åˆçš„é¥­éƒ½ä¸é¦™äº†ã€‚</p><p>æˆ‘å¼€å§‹æ€€ç–‘æ˜¯ç½‘å…³çš„é—®é¢˜ï¼Œç½‘å…³å¤§ä½¬è¯´æ²¡é—®é¢˜ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>äºæ˜¯æ‹¿ç€è¯·æ±‚åœ°å€ï¼Œcurläº†ä¸€ä¸‹ï¼Œ<code>max:99999999999999.99999999999999999999</code>ã€‚å§æ§½ã€‚ã€‚ã€‚åˆå¯¹äº†ï¼Ÿ</p><p>äºæ˜¯æˆ‘å¼€å§‹æ€€ç–‘æœ€ä¸å¯èƒ½å‡ºé—®é¢˜çš„æµè§ˆå™¨ï¼Œç›´åˆ°æˆ‘ç‚¹å¼€äº†<code>Response</code> :</p><p><img src="https://files.catbox.moe/kygqzl.png"></p><p>ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>åæ‰‹å°±æ˜¯ç»™æäº†ä¸€ä¸ªbugï¼š</p><p><img src="https://files.catbox.moe/l53ij6.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://files.catbox.moe/xbwdlv.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç›¸ä¿¡Chromeæµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„Previewä½ ä¸é™Œç”Ÿï¼Œä½†æ˜¯å°±è¿™ç©æ„æœ‰ä¸€ä¸ªbugã€‚&lt;/p&gt;
&lt;p&gt;äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œå‰ç«¯è·Ÿæˆ‘è¯´ä½ æ¥å£æœ‰bugï¼Œè¿”å›çš„æ•°æ®ä¸æ­£ç¡®ã€‚å¬åˆ°bugï¼Œæˆ‘åæ‰‹å°±æ˜¯ä¸€ä¸ªä½ ä¼šä¸ä¼šç”¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="è¸©å‘è®°å½•" scheme="https://jingzhouzhao.github.io/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
    <category term="Chrome" scheme="https://jingzhouzhao.github.io/tags/Chrome/"/>
    
  </entry>
  
  <entry>
    <title>Lambdaåº”ç”¨ä¸æµ…æ</title>
    <link href="https://jingzhouzhao.github.io/archives/d53a1750.html"/>
    <id>https://jingzhouzhao.github.io/archives/d53a1750.html</id>
    <published>2021-08-02T12:47:02.000Z</published>
    <updated>2022-02-22T07:31:09.008Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h1><p>åœ¨Java8ä¹‹å‰åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„å†™æ³•ï¼ˆä¹‹ä¸€ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class LambdaTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        new Thread(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line"></span><br><span class="line">            public void run() &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(&quot;hello inner class!&quot;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><p>é€šè¿‡æŸ¥çœ‹ç¼–è¯‘åçš„ç”Ÿæˆçš„Classæ–‡ä»¶ï¼Œå¯ä»¥å¾—çŸ¥new Runnableè¿™å—ä¼šç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼š</p><p><img src="https://files.catbox.moe/e1vlbc.png"></p><p>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">final class LambdaTest$1 implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    LambdaTest$1() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void run() &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;hello inner class!&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨Java8å¼€å§‹ä¸€åˆ‡éƒ½å¼€å§‹å˜å¾—ä¸åŒï¼Œå¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class LambdaTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        new Thread(()-&gt;System.out.println(&quot;hello inner class!&quot;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>()-&gt;System.out.println(&quot;hello inner class!&quot;)</code>å°±æ˜¯ä»Šå¤©çš„ä¸»è§’<em><strong>lambdaè¡¨è¾¾å¼</strong></em>!</p><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Lambdaè¡¨è¾¾å¼ï¼Œæ˜¯ä¸€ç§åŒ¿åå‡½æ•°ï¼Œä¸€å¼€å§‹åªæœ‰å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­æœ‰æ­¤åŠŸèƒ½ï¼Œä½†æ˜¯ç°åœ¨å·²ç»æœ‰è¶Šæ¥è¶Šå¤šçš„å‘½ä»¤å¼ç¼–ç¨‹è¯­è¨€ä¸­ä¹Ÿæ”¯æŒäº†Lambdaè¡¨è¾¾å¼ã€‚</p><blockquote><p>Lambdaè¡¨è¾¾å¼ä¸æ˜¯ä¸€ä¸ªæ–°é²œäº‹ï¼Œæœ€æ—©æ”¯æŒLambdaè¡¨è¾¾å¼çš„æ˜¯1958å‘å¸ƒçš„LISPè¯­è¨€ã€‚åœ¨Javaä¸­ä¹Ÿå­˜åœ¨äº†å¿«7-8å¹´æ—¶é—´ï¼ˆ2014å¹´å‘å¸ƒçš„Java8å¼€å§‹æ”¯æŒï¼‰ï¼Œç›®å‰Javaå·²ç»éƒ½å‘å¸ƒ16ã€‚</p></blockquote><p>Lambdaè¡¨è¾¾å¼ç®€åŒ–åŒ¿åå†…éƒ¨ç±»çš„ä¹¦å†™ï¼Œä½†Lambdaè¡¨è¾¾å¼å¹¶ä¸èƒ½å–ä»£æ‰€æœ‰çš„åŒ¿åå†…éƒ¨ç±»ï¼Œåªèƒ½ç”¨æ¥å–ä»£<strong>å‡½æ•°æ¥å£ï¼ˆFunctional Interfaceï¼‰</strong>çš„ç®€å†™ã€‚</p><p>è¯´åˆ°å‡½æ•°æ¥å£ï¼Œé‚£ä¹ˆæ¥çœ‹ä¸‹ä»€ä¹ˆæ˜¯å‡½æ•°æ¥å£ï¼Œçœ‹çœ‹æœ€å¼€å§‹çš„ä¾‹å­é‡Œå‡ºç°çš„<em><strong>Runnable</strong></em>  ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line"></span><br><span class="line">public interface Runnable &#123;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    public abstract void run();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹å¦å¤–ä¸€ä¸ª<strong>Comparable</strong> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public interface Comparable&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    public int compareTo(T o);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°äº†ä»€ä¹ˆï¼Ÿåªæœ‰ä¸€ä¸ª[æŠ½è±¡]æ–¹æ³•çš„æ¥å£å³æ˜¯å‡½æ•°æ¥å£ã€‚</p><p><code>@FunctionalInterface</code> å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼ŒåŠ ä¸Šæ­¤æ³¨è§£å¯ä»¥è®©ç¼–è¯‘å™¨å¸®ä½ checkå½“å‰å®šä¹‰çš„æ˜¯ä¸æ˜¯æ­£ç¡®çš„å‡½æ•°æ¥å£ï¼š</p><p><img src="/Users/zhaojingzhou/Library/Application%20Support/typora-user-images/image-20211201171908933.png"></p><p>Java8 å¼•å…¥Lambdaè¡¨è¾¾å¼çš„åŒæ—¶ä¹Ÿå®šä¹‰äº†å¾ˆå¤šæ–°çš„å‡½æ•°æ¥å£ï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†åœºæ™¯ï¼š</p><p><img src="https://files.catbox.moe/qptsmq.png"></p><p>ä¹Ÿå°±æ˜¯è¯´Java8ä¸­çš„Lambdaè¡¨è¾¾å¼ä¸å¯ä»¥éšæ„ä¹±å†™ï¼Œå¿…é¡»æœ‰ä¸å…¶å¯¹åº”çš„å‡½æ•°æ¥å£å®šä¹‰ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(a, b) -&gt; a + b;</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨JDKä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„å‡½æ•°æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line"></span><br><span class="line">public interface TwoParamsOneResultFunction &#123;</span><br><span class="line"></span><br><span class="line">    Integer get(Integer p1, Integer p2);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h1><p>ä¸‹é¢æ¥é€šè¿‡ä¸€ä¸ªå®ä¾‹çœ‹çœ‹Lambdaè¡¨è¾¾å¼çš„åº”ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">private static boolean sync2Es(List&lt;Long&gt; result, EsIndexEnum esIndexEnum, boolean isAsync) &#123;</span><br><span class="line"></span><br><span class="line">    log.info(&quot;åŒæ­¥&#123;&#125;è‡³ESï¼ŒidList:&#123;&#125;,isAsync:&#123;&#125;&quot;, JSON.toJSONString(esIndexEnum), JSON.toJSONString(result), isAsync);</span><br><span class="line"></span><br><span class="line">    if (esIndexEnum == null) &#123;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CollectionUtils.isEmpty(result)) &#123;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //esæœ€å¤šæ”¯æŒä¸€æ¬¡åŒæ­¥3000æ¡ï¼Œæ‰€ä»¥éœ€è¦æ‹†åˆ†</span><br><span class="line"></span><br><span class="line">    List&lt;List&lt;Long&gt;&gt; partition = Lists.partition(StreamUtils.safeList(result), AssetsConstant.MAX_BATCH_SYNC_SIZE);</span><br><span class="line"></span><br><span class="line">    //esæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ï¼ŒæŒ‰éœ€é€‰æ‹©</span><br><span class="line"></span><br><span class="line">    EsSyncProcessorInstance instance = EsSyncProcessorFactory.getInstance(esIndexEnum.getIndexClass());</span><br><span class="line"></span><br><span class="line">    BiFunction&lt;EsSyncProcessorInstance, List&lt;Long&gt;, EsResult&lt;BulkMessage&gt;&gt; esFunction = getEsSyncFunction(isAsync);</span><br><span class="line"></span><br><span class="line">    boolean esResult = StreamUtils.allMatch(StreamUtils.listToList(partition, ids -&gt; &#123;</span><br><span class="line"></span><br><span class="line">        EsResult&lt;BulkMessage&gt; bulkMessageEsResult = esFunction.apply(instance, ids);</span><br><span class="line"></span><br><span class="line">        //eså¯èƒ½å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯ä¸è¡Œé‚£ä¼°è®¡å°±æ˜¯å¤§é—®é¢˜äº†ã€‚</span><br><span class="line"></span><br><span class="line">        if (!bulkMessageEsResult.isSuccess()) &#123;</span><br><span class="line"></span><br><span class="line">            log.error(&quot;åŒæ­¥ESå¤±è´¥:&#123;&#125;,é‡è¯•ä¸€æ¬¡&quot;, JSON.toJSONString(bulkMessageEsResult));</span><br><span class="line"></span><br><span class="line">            bulkMessageEsResult = esFunction.apply(instance, StreamUtils.listToList(StreamUtils.safeGetField(bulkMessageEsResult.getValue(), BulkMessage::getFailIds), Long::valueOf));</span><br><span class="line"></span><br><span class="line">            if (!bulkMessageEsResult.isSuccess()) &#123;</span><br><span class="line"></span><br><span class="line">                log.error(&quot;åŒæ­¥ESé‡è¯•å†æ¬¡å¤±è´¥:&#123;&#125;&quot;, JSON.toJSONString(bulkMessageEsResult));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return bulkMessageEsResult.isSuccess();</span><br><span class="line"></span><br><span class="line">    &#125;), Boolean::booleanValue);</span><br><span class="line"></span><br><span class="line">    if (!esResult) &#123;</span><br><span class="line"></span><br><span class="line">        log.error(&quot;åŒæ­¥åˆ°ESå­˜åœ¨å¤±è´¥:&#123;&#125;&quot;, JSON.toJSONString(result));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return esResult;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸€æ®µä»£ç ä¸»è¦æ˜¯åœ¨åšåŒæ­¥æ•°æ®ç»™ESçš„é€»è¾‘ï¼Œç”±äºESæä¾›äº†å¤šç§åŒæ­¥æ–¹å¼ï¼Œä¸æƒ³å°†ç»†èŠ‚æš´éœ²ç»™ä¸Šå±‚ï¼Œæ‰€ä»¥åšäº†ä¸€äº›å°è£…ã€‚</p><p>å…ˆçœ‹çœ‹è¿™ä¸€æ®µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BiFunction&lt;EsSyncProcessorInstance, List&lt;Long&gt;, EsResult&lt;BulkMessage&gt;&gt; esFunction = getEsSyncFunction(isAsync);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static BiFunction&lt;EsSyncProcessorInstance, List&lt;Long&gt;, EsResult&lt;BulkMessage&gt;&gt; getEsSyncFunction(boolean isAsync) &#123;</span><br><span class="line"></span><br><span class="line">    return isAsync ? EsSyncProcessorInstance::syncByPrimaryKey : EsSyncProcessorInstance::syncByPrimaryKeyImmediate;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å¯ä»¥çœ‹åˆ°ç±»ä¼¼<code>EsSyncProcessorInstance::syncByPrimaryKey</code>è¿™ç§å†™æ³•ï¼Œè¿™ä¸ªå«æ–¹æ³•å¼•ç”¨ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§ç‰¹æ®Šçš„lambdaè¡¨è¾¾å¼ï¼ˆè¯­æ³•ç³–ï¼‰ï¼Œç›¸å½“äºç»™ä¸€æ®µå‡½æ•°å–äº†ä¸€ä¸ªåå­—ï¼Œç„¶åç›´æ¥å¼•ç”¨ï¼Œçœ‹çœ‹syncByPrimaryKeyï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public EsResult&lt;BulkMessage&gt; syncByPrimaryKey(List&lt;Long&gt; indexPrimaryKeyList) &#123;</span><br><span class="line"></span><br><span class="line">    String method = &quot;EsSyncProcessorInstance#syncByPrimaryKey&quot;;</span><br><span class="line"></span><br><span class="line">    if (indexPrimaryKeyList != null &amp;&amp; indexPrimaryKeyList.size() &gt; 3000) &#123;</span><br><span class="line"></span><br><span class="line">        log.warn(&quot;&#123;&#125; allowable size exceeded, size=&#123;&#125;, max=&#123;&#125;&quot;, new Object[]&#123;method, indexPrimaryKeyList.size(), 3000&#125;);</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        EsSyncLoopQuery query = this.newInstanceQuery();</span><br><span class="line"></span><br><span class="line">        query.setIdList(indexPrimaryKeyList);</span><br><span class="line"></span><br><span class="line">        return this.synchronizeToEs(query, this.defaultConfig());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦ä¸€ä¸ªList<Long> å‚æ•°ï¼Œä¸€ä¸ªEsResult<BulkMessage>è¿”å›å€¼ï¼Œé‚£ä¸ºä»€ä¹ˆé€‚é…çš„å‡½æ•°æ¥å£æ˜¯BiFunctionï¼Ÿçœ‹çœ‹BiFunctionï¼š</BulkMessage></Long></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line"></span><br><span class="line">public interface BiFunction&lt;T, U, R&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//è¿™é‡Œéœ€è¦ä¸¤ä¸ªå‚æ•°</span><br><span class="line"></span><br><span class="line">    R apply(T t, U u);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºsyncByPrimaryKeyæ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ª<strong>å®ä¾‹å¯¹è±¡</strong>æ‰èƒ½è°ƒç”¨ï¼Œæ‰€ä»¥<code>EsSyncProcessorInstance::syncByPrimaryKey</code> ç›¸å½“äº(<code>EsSyncProcessorInstance instance,List&lt;Long&gt; ids)-&gt;&#123;...&#125;</code></p><p>å†ä¸€æ¬¡éªŒè¯ï¼Œlambdaè¡¨è¾¾å¼ä¸èƒ½éšæ„ä¹±å†™ï¼Œå¿…é¡»æœ‰å¯¹åº”çš„å‡½æ•°æ¥å£å¯¹åº”ã€‚</p><p>æ¥ä¸‹æ¥å†æ¥çœ‹çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StreamUtils.listToList(partition, ids -&gt; &#123;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å¯¹Java8 Stream+Lambdaçš„ä¸€å±‚å°è£…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;T, R&gt; List&lt;R&gt; listToList(List&lt;T&gt; list, Function&lt;T, R&gt; function) &#123;</span><br><span class="line"></span><br><span class="line">        return safeList(list).stream().map(function).filter(Objects::nonNull).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°stream().mapéœ€è¦ä¸€ä¸ªfunctionç”¨æ¥è½¬æ¢æ•°æ®ï¼Œè€Œå…¶ä»–çš„åŸºæœ¬éƒ½æ˜¯å›ºå®šå†™æ³•ï¼Œè¿™ä½“ç°äº†Lambdaçš„å¦å¤–ä¸€ä¸ªå¥½å¤„ï¼šæŠ½è±¡è¡Œä¸ºã€‚</p><p><img src="https://files.catbox.moe/akijpg.png"></p><p>è¿˜æœ‰å¾ˆå¤šç”¨æ³•ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚</p><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>è¿™ä¹ˆğŸ‚ğŸºçš„Lambdaè¡¨è¾¾å¼Javaåº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿé¦–å…ˆå¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œä¸æ˜¯åŒ¿åå†…éƒ¨ç±»ï¼Œè¿˜æ˜¯æœ€å¼€å§‹çš„ä¾‹å­ï¼Œæˆ‘ä»¬æ”¹æˆlambdaè¡¨è¾¾å¼åç¼–è¯‘çœ‹çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class LambdaTest &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        new Thread(()-&gt;System.out.println(&quot;hello lambda&quot;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://files.catbox.moe/ular40.png"></p><p>å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰åŒ¿åå†…éƒ¨ç±»ç”Ÿæˆï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹LambdaTest.classå­—èŠ‚ç (<em>javap -c -p -v LambdaTest.class</em>)ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">Classfile /Users/zhaojingzhou/workspace/larry/lambda/src/LambdaTest.class</span><br><span class="line"></span><br><span class="line">  Last modified 2021-8-2; size 1047 bytes</span><br><span class="line"></span><br><span class="line">  MD5 checksum 191cb67c3e5a457eb20b4c8a47f5a5d2</span><br><span class="line"></span><br><span class="line">  Compiled from &quot;LambdaTest.java&quot;</span><br><span class="line"></span><br><span class="line">public class LambdaTest</span><br><span class="line"></span><br><span class="line">  minor version: 0</span><br><span class="line"></span><br><span class="line">  major version: 52</span><br><span class="line"></span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line"></span><br><span class="line">Constant pool:</span><br><span class="line"></span><br><span class="line">   #1 = Methodref          #9.#19         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line">   #2 = Class              #20            // java/lang/Thread</span><br><span class="line"></span><br><span class="line">   #3 = InvokeDynamic      #0:#25         // #0:run:()Ljava/lang/Runnable;</span><br><span class="line"></span><br><span class="line">   #4 = Methodref          #2.#26         // java/lang/Thread.&quot;&lt;init&gt;&quot;:(Ljava/lang/Runnable;)V</span><br><span class="line"></span><br><span class="line">   #5 = Fieldref           #27.#28        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">   #6 = String             #29            // hello inner class!</span><br><span class="line"></span><br><span class="line">   #7 = Methodref          #30.#31        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">   #8 = Class              #32            // LambdaTest</span><br><span class="line"></span><br><span class="line">   #9 = Class              #33            // java/lang/Object</span><br><span class="line"></span><br><span class="line">  #10 = Utf8               &lt;init&gt;</span><br><span class="line"></span><br><span class="line">  #11 = Utf8               ()V</span><br><span class="line"></span><br><span class="line">  #12 = Utf8               Code</span><br><span class="line"></span><br><span class="line">  #13 = Utf8               LineNumberTable</span><br><span class="line"></span><br><span class="line">  #14 = Utf8               main</span><br><span class="line"></span><br><span class="line">  #15 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  #16 = Utf8               lambda$main$0</span><br><span class="line"></span><br><span class="line">  #17 = Utf8               SourceFile</span><br><span class="line"></span><br><span class="line">  #18 = Utf8               LambdaTest.java</span><br><span class="line"></span><br><span class="line">  #19 = NameAndType        #10:#11        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line">  #20 = Utf8               java/lang/Thread</span><br><span class="line"></span><br><span class="line">  #21 = Utf8               BootstrapMethods</span><br><span class="line"></span><br><span class="line">  #22 = MethodHandle       #6:#34         // invokestatic java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line"></span><br><span class="line">  #23 = MethodType         #11            //  ()V</span><br><span class="line"></span><br><span class="line">  #24 = MethodHandle       #6:#35         // invokestatic LambdaTest.lambda$main$0:()V</span><br><span class="line"></span><br><span class="line">  #25 = NameAndType        #36:#37        // run:()Ljava/lang/Runnable;</span><br><span class="line"></span><br><span class="line">  #26 = NameAndType        #10:#38        // &quot;&lt;init&gt;&quot;:(Ljava/lang/Runnable;)V</span><br><span class="line"></span><br><span class="line">  #27 = Class              #39            // java/lang/System</span><br><span class="line"></span><br><span class="line">  #28 = NameAndType        #40:#41        // out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">  #29 = Utf8               hello inner class!</span><br><span class="line"></span><br><span class="line">  #30 = Class              #42            // java/io/PrintStream</span><br><span class="line"></span><br><span class="line">  #31 = NameAndType        #43:#44        // println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  #32 = Utf8               LambdaTest</span><br><span class="line"></span><br><span class="line">  #33 = Utf8               java/lang/Object</span><br><span class="line"></span><br><span class="line">  #34 = Methodref          #45.#46        // java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line"></span><br><span class="line">  #35 = Methodref          #8.#47         // LambdaTest.lambda$main$0:()V</span><br><span class="line"></span><br><span class="line">  #36 = Utf8               run</span><br><span class="line"></span><br><span class="line">  #37 = Utf8               ()Ljava/lang/Runnable;</span><br><span class="line"></span><br><span class="line">  #38 = Utf8               (Ljava/lang/Runnable;)V</span><br><span class="line"></span><br><span class="line">  #39 = Utf8               java/lang/System</span><br><span class="line"></span><br><span class="line">  #40 = Utf8               out</span><br><span class="line"></span><br><span class="line">  #41 = Utf8               Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">  #42 = Utf8               java/io/PrintStream</span><br><span class="line"></span><br><span class="line">  #43 = Utf8               println</span><br><span class="line"></span><br><span class="line">  #44 = Utf8               (Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  #45 = Class              #48            // java/lang/invoke/LambdaMetafactory</span><br><span class="line"></span><br><span class="line">  #46 = NameAndType        #49:#53        // metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line"></span><br><span class="line">  #47 = NameAndType        #16:#11        // lambda$main$0:()V</span><br><span class="line"></span><br><span class="line">  #48 = Utf8               java/lang/invoke/LambdaMetafactory</span><br><span class="line"></span><br><span class="line">  #49 = Utf8               metafactory</span><br><span class="line"></span><br><span class="line">  #50 = Class              #55            // java/lang/invoke/MethodHandles$Lookup</span><br><span class="line"></span><br><span class="line">  #51 = Utf8               Lookup</span><br><span class="line"></span><br><span class="line">  #52 = Utf8               InnerClasses</span><br><span class="line"></span><br><span class="line">  #53 = Utf8               (Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line"></span><br><span class="line">  #54 = Class              #56            // java/lang/invoke/MethodHandles</span><br><span class="line"></span><br><span class="line">  #55 = Utf8               java/lang/invoke/MethodHandles$Lookup</span><br><span class="line"></span><br><span class="line">  #56 = Utf8               java/lang/invoke/MethodHandles</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  public LambdaTest();</span><br><span class="line"></span><br><span class="line">    descriptor: ()V</span><br><span class="line"></span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line"></span><br><span class="line">    Code:</span><br><span class="line"></span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line"></span><br><span class="line">         0: aload_0</span><br><span class="line"></span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line"></span><br><span class="line">         4: return</span><br><span class="line"></span><br><span class="line">      LineNumberTable:</span><br><span class="line"></span><br><span class="line">        line 9: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line"></span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">    Code:</span><br><span class="line"></span><br><span class="line">      stack=3, locals=1, args_size=1</span><br><span class="line"></span><br><span class="line">         0: new           #2                  // class java/lang/Thread</span><br><span class="line"></span><br><span class="line">         3: dup</span><br><span class="line"></span><br><span class="line">         4: invokedynamic #3,  0              // InvokeDynamic #0:run:()Ljava/lang/Runnable;</span><br><span class="line"></span><br><span class="line">         9: invokespecial #4                  // Method java/lang/Thread.&quot;&lt;init&gt;&quot;:(Ljava/lang/Runnable;)V</span><br><span class="line"></span><br><span class="line">        12: pop</span><br><span class="line"></span><br><span class="line">        13: return</span><br><span class="line"></span><br><span class="line">      LineNumberTable:</span><br><span class="line"></span><br><span class="line">        line 14: 0</span><br><span class="line"></span><br><span class="line">        line 19: 13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  private static void lambda$main$0();</span><br><span class="line"></span><br><span class="line">    descriptor: ()V</span><br><span class="line"></span><br><span class="line">    flags: ACC_PRIVATE, ACC_STATIC, ACC_SYNTHETIC</span><br><span class="line"></span><br><span class="line">    Code:</span><br><span class="line"></span><br><span class="line">      stack=2, locals=0, args_size=0</span><br><span class="line"></span><br><span class="line">         0: getstatic     #5                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">         3: ldc           #6                  // String hello inner class!</span><br><span class="line"></span><br><span class="line">         5: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">         8: return</span><br><span class="line"></span><br><span class="line">      LineNumberTable:</span><br><span class="line"></span><br><span class="line">        line 14: 0</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SourceFile: &quot;LambdaTest.java&quot;</span><br><span class="line"></span><br><span class="line">InnerClasses:</span><br><span class="line"></span><br><span class="line">     public static final #51= #50 of #54; //Lookup=class java/lang/invoke/MethodHandles$Lookup of class java/lang/invoke/MethodHandles</span><br><span class="line"></span><br><span class="line">BootstrapMethods:</span><br><span class="line"></span><br><span class="line">  0: #22 invokestatic java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line"></span><br><span class="line">    Method arguments:</span><br><span class="line"></span><br><span class="line">      #23 ()V</span><br><span class="line"></span><br><span class="line">      #24 invokestatic LambdaTest.lambda$main$0:()V</span><br><span class="line"></span><br><span class="line">      #23 ()V</span><br></pre></td></tr></table></figure><p>å¾ˆå¤šä¿¡æ¯æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹é‡ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4: invokedynamic #3,  0              // InvokeDynamic #0:run:()Ljava/lang/Runnable;</span><br></pre></td></tr></table></figure><p>ç¬¬85è¡Œå¯ä»¥çœ‹åˆ°åŸlambdaè¡¨è¾¾å¼è¢«ç¼–è¯‘æˆäº†<code>invokedynamic</code> å­—èŠ‚ç ï¼Œè¿™ä¸ªæ˜¯Javaä¸­å¤šä¸ªè°ƒç”¨å­—èŠ‚ç ä¹‹ä¸€ï¼Œå…¶å®ƒçš„åˆ†åˆ«æ˜¯<code>invokestatic</code>ã€<code>invokevirtual</code>ã€<code>invokespecial</code>ã€<code>invokeinterface</code>ã€‚ä¹Ÿæ˜¯Java1.0ä»¥åç¬¬ä¸€ä¸ªè¢«æ–°å¢çš„è°ƒç”¨å­—èŠ‚ç ã€‚</p><p>æ¥ä¸‹æ¥çœ‹#3ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#3 = InvokeDynamic      #0:#25         // #0:run:()Ljava/lang/Runnable;</span><br></pre></td></tr></table></figure><p>#0:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">BootstrapMethods:</span><br><span class="line"></span><br><span class="line">  0: #22 invokestatic java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line"></span><br><span class="line">    Method arguments:</span><br><span class="line"></span><br><span class="line">      #23 ()V</span><br><span class="line"></span><br><span class="line">      #24 invokestatic LambdaTest.lambda$main$0:()V</span><br><span class="line"></span><br><span class="line">      #23 ()V</span><br></pre></td></tr></table></figure><p><a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.7.21">JVMè§„èŒƒ</a>è§„å®šï¼Œå¦‚æœç±»çš„å¸¸é‡æ± ä¸­å­˜åœ¨CONSTANT_InvokeDynamic_infoçš„è¯ï¼Œé‚£ä¹ˆattributesè¡¨ä¸­å°±å¿…å®š<strong>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª</strong>BootstrapMethodså±æ€§ã€‚BootstrapMethodså±æ€§æ˜¯ä¸ªå˜é•¿çš„è¡¨ã€‚</p><p>å…¶ä¸­æ ¹æ®ç›¸å…³ä¿¡æ¯ä¼šåˆ›å»ºä¸€ä¸ªDynamicCallSiteåŠ¨æ€è°ƒç”¨ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨çš„æ–¹æ³•ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">invokestatic LambdaTest.lambda$main$0:()V</span><br><span class="line">  private static void lambda$main$0();</span><br><span class="line"></span><br><span class="line">    descriptor: ()V</span><br><span class="line"></span><br><span class="line">    flags: ACC_PRIVATE, ACC_STATIC, ACC_SYNTHETIC</span><br><span class="line"></span><br><span class="line">    Code:</span><br><span class="line"></span><br><span class="line">      stack=2, locals=0, args_size=0</span><br><span class="line"></span><br><span class="line">         0: getstatic     #5                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line"></span><br><span class="line">         3: ldc           #6                  // String hello inner class!</span><br><span class="line"></span><br><span class="line">         5: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">         8: return</span><br><span class="line"></span><br><span class="line">      LineNumberTable:</span><br><span class="line"></span><br><span class="line">        line 14: 0</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´Javaè™½ç„¶ä¸ä¼šå¯¹Lambdaè¡¨è¾¾å¼ç”ŸæˆåŒ¿åç±»ï¼Œä½†æ˜¯ä¼šç”ŸæˆåŒ¿åé™æ€æ–¹æ³•ã€‚</p><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><p><a href="https://segmentfault.com/a/1190000020607546">https://segmentfault.com/a/1190000020607546</a></p><p><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html</a></p><p><a href="https://stackoverflow.com/questions/30733557/what-is-a-bootstrap-method">https://stackoverflow.com/questions/30733557/what-is-a-bootstrap-method</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å¼•å…¥&quot;&gt;&lt;a href=&quot;#å¼•å…¥&quot; class=&quot;headerlink&quot; title=&quot;å¼•å…¥&quot;&gt;&lt;/a&gt;å¼•å…¥&lt;/h1&gt;&lt;p&gt;åœ¨Java8ä¹‹å‰åˆ›å»ºä¸€ä¸ªçº¿ç¨‹çš„å†™æ³•ï¼ˆä¹‹ä¸€ï¼‰ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public class LambdaTest &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    public static void main(String[] args) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        new Thread(new Runnable() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            @Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            public void run() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                System.out.println(&amp;quot;hello inner class!&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Nettyä¸­FastThreadLocalæºç è§£æ</title>
    <link href="https://jingzhouzhao.github.io/archives/4b47846d.html"/>
    <id>https://jingzhouzhao.github.io/archives/4b47846d.html</id>
    <published>2021-05-08T02:25:25.000Z</published>
    <updated>2022-02-22T07:31:09.009Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>ThreadLocal</code>ä¸€ä¸ªç‰¹æ®Šå˜ä½“ï¼Œå½“ä»<code>FastThreadLocalThread</code>è®¿é—®æ—¶ï¼Œå¯è·å¾—æ›´é«˜çš„è®¿é—®æ€§èƒ½ã€‚<br>åœ¨å†…éƒ¨ï¼Œ <code>FastThreadLocal</code>åœ¨æ•°ç»„ä¸­ä½¿ç”¨å¸¸é‡ç´¢å¼•æ¥æŸ¥æ‰¾å˜é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å“ˆå¸Œç å’Œå“ˆå¸Œè¡¨ã€‚ å°½ç®¡çœ‹ä¼¼éå¸¸å¾®å¦™ï¼Œä½†ä¸ä½¿ç”¨å“ˆå¸Œè¡¨ç›¸æ¯”ï¼Œå®ƒåœ¨æ€§èƒ½ä¸Šå´æœ‰ä¸€ç‚¹ä¼˜åŠ¿ï¼Œå¹¶ä¸”åœ¨ç»å¸¸è®¿é—®æ—¶å¾ˆæœ‰ç”¨ã€‚<br>è¦åˆ©ç”¨æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ‚¨çš„çº¿ç¨‹å¿…é¡»æ˜¯<code>FastThreadLocalThread</code>æˆ–å…¶å­ç±»å‹ã€‚ ç”±äºè¿™ä¸ªåŸå› ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>DefaultThreadFactory</code>åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹å‡ä¸º<code>FastThreadLocalThread</code> ã€‚<br>è¯·æ³¨æ„ï¼Œåªæœ‰åœ¨æ‰©å±•<code>FastThreadLocalThread</code>çº¿ç¨‹ä¸Šæ‰å¯ä»¥ä½¿ç”¨å¿«é€Ÿè·¯å¾„ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µæ¥å­˜å‚¨å¿…è¦çš„çŠ¶æ€ã€‚ ä»»ä½•å…¶ä»–ç±»å‹çš„çº¿ç¨‹çš„è®¿é—®éƒ½å›é€€åˆ°å¸¸è§„<code>ThreadLocal</code> ã€‚</p><p>ä¸Šé¢è¿™æ®µæè¿°æ¥è‡ª<code>FastThreadLocal</code>æºç ä¸­çš„æ–‡æ¡£ï¼Œä»ä¸­å¯ä»¥çŸ¥é“<code>FastThreadLocal</code>å¿…é¡»å’Œ<code>FastThreadLocalThread</code>æˆ–å…¶å­ç±»å‹ä¸€èµ·ä½¿ç”¨æ‰å¯ä»¥è¾¾åˆ°Fastçš„æ•ˆæœã€‚</p><span id="more"></span><h2 id="FastThreadLocalThread"><a href="#FastThreadLocalThread" class="headerlink" title="FastThreadLocalThread"></a>FastThreadLocalThread</h2><p>æ—¢ç„¶å¿…é¡»è¦å’Œ<code>FastThreadLocalThread</code>    ä¸€èµ·ä½¿ç”¨ï¼Œé‚£å°±æ¥çœ‹çœ‹<code>FastThreadLocalThread</code>åˆ°åº•æœ‰ä»€ä¹ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A special &#123;<span class="doctag">@link</span> Thread&#125; that provides fast access to &#123;<span class="doctag">@link</span> FastThreadLocal&#125; variables.</span></span><br><span class="line"><span class="comment"> * ä¸€ç§ç‰¹æ®Šçš„&#123;<span class="doctag">@link</span> Thread&#125;ï¼Œå¯ä»¥å¿«é€Ÿè®¿é—®&#123;<span class="doctag">@link</span> FastThreadLocal&#125;å˜é‡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastThreadLocalThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// This will be set to true if we have a chance to wrap the Runnable.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> cleanupFastThreadLocals;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InternalThreadLocalMap threadLocalMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastThreadLocalThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cleanupFastThreadLocals = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastThreadLocalThread</span><span class="params">(Runnable target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(FastThreadLocalRunnable.wrap(target));</span><br><span class="line">        cleanupFastThreadLocals = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">â€¦â€¦    </span><br></pre></td></tr></table></figure><p>çœç•¥äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°<code>FastThreadLocalThread</code>ç»§æ‰¿è‡ª<code>Thread</code>ï¼Œé¢å¤–å¤šäº†ä¸€ä¸ª<code>InternalThreadLocalMap threadLocalMap</code>ï¼Œä»docä¸­å¯ä»¥çœ‹å‡ºè¿™ä¸ªå˜é‡å°±æ˜¯å…³é”®ã€‚</p><h2 id="InternalThreadLocalMap"><a href="#InternalThreadLocalMap" class="headerlink" title="InternalThreadLocalMap"></a>InternalThreadLocalMap</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The internal data structure that stores the thread-local variables for Netty and all &#123;<span class="doctag">@link</span> FastThreadLocal&#125;s.</span></span><br><span class="line"><span class="comment"> * Note that this class is for internal use only and is subject to change at any time.  Use &#123;<span class="doctag">@link</span> FastThreadLocal&#125;</span></span><br><span class="line"><span class="comment"> * unless you know what you are doing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalThreadLocalMap</span> <span class="keyword">extends</span> <span class="title">UnpaddedInternalThreadLocalMap</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = <span class="keyword">new</span> ThreadLocal&lt;InternalThreadLocalMap&gt;();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger nextIndex = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Used by &#123;<span class="doctag">@link</span> FastThreadLocal&#125; */</span></span><br><span class="line">    Object[] indexedVariables;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Object UNSET = <span class="keyword">new</span> Object();</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Thread thread = Thread.currentThread();</span><br><span class="line">        <span class="keyword">if</span> (thread <span class="keyword">instanceof</span> FastThreadLocalThread) &#123;</span><br><span class="line">            <span class="keyword">return</span> fastGet((FastThreadLocalThread) thread);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> slowGet();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">fastGet</span><span class="params">(FastThreadLocalThread thread)</span> </span>&#123;</span><br><span class="line">        InternalThreadLocalMap threadLocalMap = thread.threadLocalMap();</span><br><span class="line">        <span class="keyword">if</span> (threadLocalMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            thread.setThreadLocalMap(threadLocalMap = <span class="keyword">new</span> InternalThreadLocalMap());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> threadLocalMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">slowGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = UnpaddedInternalThreadLocalMap.slowThreadLocalMap;</span><br><span class="line">        InternalThreadLocalMap ret = slowThreadLocalMap.get();</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ret = <span class="keyword">new</span> InternalThreadLocalMap();</span><br><span class="line">            slowThreadLocalMap.set(ret);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextVariableIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = nextIndex.getAndIncrement();</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            nextIndex.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;too many thread-local indexed variables&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;    </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if and only if a new thread-local variable has been created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setIndexedVariable</span><span class="params">(<span class="keyword">int</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        Object[] lookup = indexedVariables;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; lookup.length) &#123;</span><br><span class="line">            Object oldValue = lookup[index];</span><br><span class="line">            lookup[index] = value;</span><br><span class="line">            <span class="keyword">return</span> oldValue == UNSET;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            expandIndexedVariableTableAndSet(index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure><p><code>InternalThreadLocalMap</code>ç»§æ‰¿è‡ª<code>UnpaddedInternalThreadLocalMap</code>ï¼Œä¸ºäº†å¥½çœ‹ä¸€ç‚¹æˆ‘æŠŠçˆ¶ç±»ä¸­çš„ç›¸å…³ä»£ç æ”¾åˆ°äº†ä¸€èµ·ï¼Œdubboå€Ÿé‰´nettyä»£ç ä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ã€‚</p><h2 id="FastThreadLocal"><a href="#FastThreadLocal" class="headerlink" title="FastThreadLocal"></a>FastThreadLocal</h2><p>æœ€åçœ‹çœ‹<code>FastThreadLocal</code>æ˜¯æ€ä¹ˆæŠŠè¿™å‡ ä¸ªæ ¸å¿ƒç±»ç»™ä¸²èµ·æ¥çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastThreadLocal</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> variablesToRemoveIndex = InternalThreadLocalMap.nextVariableIndex();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FastThreadLocal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        index = InternalThreadLocalMap.nextVariableIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current value for the current thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.get();</span><br><span class="line">        Object v = threadLocalMap.indexedVariable(index);</span><br><span class="line">        <span class="keyword">if</span> (v != InternalThreadLocalMap.UNSET) &#123;</span><br><span class="line">            <span class="keyword">return</span> (V) v;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> initialize(threadLocalMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> V <span class="title">initialize</span><span class="params">(InternalThreadLocalMap threadLocalMap)</span> </span>&#123;</span><br><span class="line">        V v = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            v = initialValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            PlatformDependent.throwException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        threadLocalMap.setIndexedVariable(index, v);</span><br><span class="line">        addToVariablesToRemove(threadLocalMap, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the initial value for this thread-local variable.</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ä¼šæŠŠè¦†ç›–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> V <span class="title">initialValue</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://files.catbox.moe/nxk8yt.png"></p><h2 id="å…«å¦"><a href="#å…«å¦" class="headerlink" title="å…«å¦"></a>å…«å¦</h2><p><a href="https://github.com/apache/dubbo/pull/1745">https://github.com/apache/dubbo/pull/1745</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;&lt;code&gt;ThreadLocal&lt;/code&gt;ä¸€ä¸ªç‰¹æ®Šå˜ä½“ï¼Œå½“ä»&lt;code&gt;FastThreadLocalThread&lt;/code&gt;è®¿é—®æ—¶ï¼Œå¯è·å¾—æ›´é«˜çš„è®¿é—®æ€§èƒ½ã€‚&lt;br&gt;åœ¨å†…éƒ¨ï¼Œ &lt;code&gt;FastThreadLocal&lt;/code&gt;åœ¨æ•°ç»„ä¸­ä½¿ç”¨å¸¸é‡ç´¢å¼•æ¥æŸ¥æ‰¾å˜é‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å“ˆå¸Œç å’Œå“ˆå¸Œè¡¨ã€‚ å°½ç®¡çœ‹ä¼¼éå¸¸å¾®å¦™ï¼Œä½†ä¸ä½¿ç”¨å“ˆå¸Œè¡¨ç›¸æ¯”ï¼Œå®ƒåœ¨æ€§èƒ½ä¸Šå´æœ‰ä¸€ç‚¹ä¼˜åŠ¿ï¼Œå¹¶ä¸”åœ¨ç»å¸¸è®¿é—®æ—¶å¾ˆæœ‰ç”¨ã€‚&lt;br&gt;è¦åˆ©ç”¨æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ‚¨çš„çº¿ç¨‹å¿…é¡»æ˜¯&lt;code&gt;FastThreadLocalThread&lt;/code&gt;æˆ–å…¶å­ç±»å‹ã€‚ ç”±äºè¿™ä¸ªåŸå› ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ &lt;code&gt;DefaultThreadFactory&lt;/code&gt;åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹å‡ä¸º&lt;code&gt;FastThreadLocalThread&lt;/code&gt; ã€‚&lt;br&gt;è¯·æ³¨æ„ï¼Œåªæœ‰åœ¨æ‰©å±•&lt;code&gt;FastThreadLocalThread&lt;/code&gt;çº¿ç¨‹ä¸Šæ‰å¯ä»¥ä½¿ç”¨å¿«é€Ÿè·¯å¾„ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µæ¥å­˜å‚¨å¿…è¦çš„çŠ¶æ€ã€‚ ä»»ä½•å…¶ä»–ç±»å‹çš„çº¿ç¨‹çš„è®¿é—®éƒ½å›é€€åˆ°å¸¸è§„&lt;code&gt;ThreadLocal&lt;/code&gt; ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šé¢è¿™æ®µæè¿°æ¥è‡ª&lt;code&gt;FastThreadLocal&lt;/code&gt;æºç ä¸­çš„æ–‡æ¡£ï¼Œä»ä¸­å¯ä»¥çŸ¥é“&lt;code&gt;FastThreadLocal&lt;/code&gt;å¿…é¡»å’Œ&lt;code&gt;FastThreadLocalThread&lt;/code&gt;æˆ–å…¶å­ç±»å‹ä¸€èµ·ä½¿ç”¨æ‰å¯ä»¥è¾¾åˆ°Fastçš„æ•ˆæœã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Mybatisæ‰¹é‡æ›´æ–°çš„ä¸€ä¸ªå°é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/e8013d2a.html"/>
    <id>https://jingzhouzhao.github.io/archives/e8013d2a.html</id>
    <published>2021-03-25T09:20:15.000Z</published>
    <updated>2022-02-22T07:31:09.012Z</updated>
    
    <content type="html"><![CDATA[<p>æ‰¹é‡æ›´æ–°çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚update case whenï¼Œforeach updateç­‰ï¼Œä»Šå¤©åœ¨ä½¿ç”¨å…¶ä¸­ä¸€ç§foreach updateæ—¶ä¸€ç›´æŠ¥SQLè¯­æ³•é”™è¯¯ï¼Œçœ‹äº†åŠå¤©æ²¡çœ‹å‡ºå“ªé‡Œæœ‰é—®é¢˜:</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id=&quot;updateBatch&quot; parameterType=&quot;list&quot;&gt;</span><br><span class="line">    &lt;foreach collection=&quot;list&quot; item=&quot;item&quot; separator=&quot;;&quot; index=&quot;index&quot;&gt;</span><br><span class="line">      update test</span><br><span class="line">      &lt;set&gt;</span><br><span class="line">        status = #&#123;item.status,jdbcType=BIGINT&#125;,</span><br><span class="line">        amount = #&#123;item.amount,jdbcType=BIGINT&#125;,</span><br><span class="line">        version = version+1,</span><br><span class="line">        gmt_modified = now(),</span><br><span class="line">      &lt;/set&gt;</span><br><span class="line">      &lt;where&gt;</span><br><span class="line">        id = #&#123;item.id&#125;</span><br><span class="line">      &lt;/where&gt;</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">  &lt;/update&gt;</span><br></pre></td></tr></table></figure><p>éå¸¸ç®€å•çš„update SQLï¼Œé€šè¿‡Mybatis foreach ç”Ÿæˆå¤šä¸ªupdate SQLåŒæ—¶æ‰§è¡Œï¼Œä½†æ˜¯è¿è¡Œæ—¶ä¸€ç›´æŠ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;update test</span><br><span class="line">       SET amount = -116534270,</span><br><span class="line">        version&#x27; at line 10</span><br><span class="line">; bad SQL grammar []; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;update test</span><br><span class="line">       SET amount = -116534270,</span><br><span class="line">        version&#x27; at line 10</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™ä¸ªé”™è¯¯ä¸‹æ„è¯†çš„è®¤ä¸ºè‚¯å®šæ˜¯sqlå“ªé‡Œå†™çš„ä¸å¯¹æœ‰è¯­æ³•é”™è¯¯ï¼Œå¯æ˜¯æ£€æŸ¥äº†åŠå¤©æ²¡å‘ç°é—®é¢˜ï¼Œè€Œä¸”å°†æŠ¥é”™çš„sql é€šè¿‡navicatè¿è¡Œä¹Ÿå¯ä»¥é€šè¿‡ã€‚</p><p>åæ¥æŸ¥åˆ°å¦‚æœæ‰¹é‡æ‰§è¡Œè¯­å¥éœ€è¦å°†database connection urlä¸­åŠ ä¸Šå¦‚ä¸‹å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allowMultiQueries=true</span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„urlä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://x.x.x.x:3306/xxxx?allowMultiQueries=true&amp;amp;autoReconnect=true&amp;amp;useUnicode=true&amp;amp;characterset=utf8mb4</span><br></pre></td></tr></table></figure><p>ä¸å¾—ä¸è¯´MySQLæŠ¥é”™ä¿¡æ¯å®åœ¨æ˜¯å¤ªæ¨¡ç³Šäº†ã€‚ğŸ˜“</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ‰¹é‡æ›´æ–°çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚update case whenï¼Œforeach updateç­‰ï¼Œä»Šå¤©åœ¨ä½¿ç”¨å…¶ä¸­ä¸€ç§foreach updateæ—¶ä¸€ç›´æŠ¥SQLè¯­æ³•é”™è¯¯ï¼Œçœ‹äº†åŠå¤©æ²¡çœ‹å‡ºå“ªé‡Œæœ‰é—®é¢˜:&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
    <category term="MySQL" scheme="https://jingzhouzhao.github.io/tags/MySQL/"/>
    
    <category term="Mybatis" scheme="https://jingzhouzhao.github.io/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>è®°ä¸€æ¬¡çº¿ä¸Šæ­»é”æ’æŸ¥</title>
    <link href="https://jingzhouzhao.github.io/archives/9e47523f.html"/>
    <id>https://jingzhouzhao.github.io/archives/9e47523f.html</id>
    <published>2021-03-23T03:46:15.000Z</published>
    <updated>2022-02-22T07:31:09.015Z</updated>
    
    <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´å¶å°”ä¼šæ”¶åˆ°çº¿ä¸ŠMySQLæ­»é”å‘Šè­¦é€šçŸ¥ï¼Œç”±äºæœ‰è¡¥å¿æœºåˆ¶ï¼Œæœ€ç»ˆä¸šåŠ¡ä¼šå¤„ç†æˆåŠŸï¼Œæ‰€ä»¥æ²¡å¤ªå…³å¿ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction</span><br></pre></td></tr></table></figure><p>æœ€è¿‘åˆæ”¶åˆ°äº†ç›¸åŒçš„å‘Šè­¦ï¼Œå¯èƒ½ä¸æ˜¯å¶ç„¶äº‹ä»¶ï¼Œäºæ˜¯å¼€å§‹æ’æŸ¥ã€‚<br>é¦–å…ˆç¿»çœ‹äº†æ—¥å¿—ï¼Œç»“åˆä»£ç ï¼Œæ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜ã€‚äº‹å‘æ—¶åº”è¯¥ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§æ‰¹é‡å¹¶å‘äº‹ä»¶ã€‚</p><span id="more"></span><p>äºæ˜¯å‘DBAè¦æ¥äº†deadlock logï¼Œæ—¥å¿—å†…å®¹å¦‚ä¸‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2021-03-22 16:02:01 0x7f1cfc289700</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 153411874, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 8 lock struct(s), heap size 1136, 23 row lock(s), undo log entries 22</span><br><span class="line">MySQL thread id 8203444, OS thread handle 139762013996800, query id 766107488 updating</span><br><span class="line">update test</span><br><span class="line">SET status = 4,</span><br><span class="line">version = version+1,</span><br><span class="line">gmt_modified = &#x27;2021-03-22 16:02:01&#x27; </span><br><span class="line">where  id = 1</span><br><span class="line">and version=14</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table `test` trx id 153411874 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 40 PHYSICAL RECORD: n_fields 45; compact format; info bits 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 153411876, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">8 lock struct(s), heap size 1136, 7 row lock(s), undo log entries 6</span><br><span class="line">MySQL thread id 8204162, OS thread handle 139762466330368, query id 766107489  updating</span><br><span class="line">update test</span><br><span class="line">         SET approval_status = 5,</span><br><span class="line">                biz_date = &#x27;2021-02-23 00:00:00&#x27;,</span><br><span class="line">                modified_id = 123,</span><br><span class="line">                modified_name = &#x27;xxx&#x27;,</span><br><span class="line">                contact_company_id = 456,</span><br><span class="line">                contact_company_n</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table `test` trx id 153411876 lock_mode X locks rec but not gap</span><br><span class="line">Record lock, heap no 40 PHYSICAL RECORD: n_fields 45; compact format; info bits 0</span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table `test` trx id 153411876 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 28 PHYSICAL RECORD: n_fields 45; compact format; info bits 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ—¥å¿—åªä¿ç•™äº†å…³é”®éƒ¨åˆ†ï¼Œè¡¨åç­‰ä¹Ÿè¿›è¡Œäº†è„±æ•ã€‚<br>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªäº‹åŠ¡éƒ½åœ¨ç­‰å¾…PRIMARYä¹Ÿå°±æ˜¯ä¸»é”®ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id 639 page no 2931 n bits 128 index PRIMARY of table `test`</span><br></pre></td></tr></table></figure><p>ç„¶åå†ç»“åˆæ—¥å¿—ä¸­çš„SQLå’Œä»£ç ï¼Œå‘ç°é—®é¢˜çš„åŸå› å¦‚ä¸‹:</p><p>ä¸€å…±æ¶‰åŠ3ä¸ªç³»ç»Ÿï¼Œåˆ†åˆ«æ˜¯Sã€Cã€Fï¼Œåœ¨Sç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªä¸šåŠ¡æ“ä½œå®Œæˆåä¼šç»™Cï¼ŒFå‘æ¶ˆæ¯ï¼ŒCæ”¶åˆ°Sçš„æ¶ˆæ¯å¤„ç†å®Œæˆåä¹Ÿä¼šç»™Få‘ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¦‚å›¾æ‰€ç¤º:</p><p><img src="https://i.loli.net/2021/03/23/cqBePdigLzNIUhF.png" alt="9b1b7abc8bdf0a3113e751fce4700924.png"></p><p>åœ¨Fä¸­å‡ ä¹åŒæ—¶å¼€å¯äº†ä¸¤ä¸ªäº‹åŠ¡ï¼Œå¹¶ä¸”ä¸¤ä¸ªæ¶ˆæ¯åœ¨Fä¸­æ¶‰åŠçš„è®°å½•æ˜¯ç›¸åŒçš„ï¼Œidåˆ†åˆ«æ˜¯1ï¼Œ2ï¼Œè¡¨ä¸ºtestã€‚<br>äºæ˜¯å‡ºç°äº†äº‹åŠ¡ä¸€:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL1:</span><br><span class="line">update test set status = 4 ...... where id=1</span><br><span class="line"></span><br><span class="line">SQL2:</span><br><span class="line">update test set status = 4 ...... where id=2</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡äºŒ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL1:</span><br><span class="line">update test SET approval_status = 5 ...... where id =2</span><br><span class="line"></span><br><span class="line">SQL2:</span><br><span class="line">update test SET approval_status = 5 ...... where id =1 </span><br></pre></td></tr></table></figure><p>äº‹åŠ¡ä¸€å…ˆæŒæœ‰id=1çš„é”ï¼Œäº‹åŠ¡äºŒæŒæœ‰id=2çš„é”ï¼Œäº‹åŠ¡ä¸€å°è¯•è·å–id=2çš„é”ï¼Œäº‹åŠ¡äºŒå°è¯•è·å–id=1çš„é”ï¼Œæ‰€ä»¥æ­»é”äº†ã€‚æœ€åMySQLå›æ»šäº†äº‹åŠ¡äºŒã€‚</p><p>å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯ç”±äºäº§å“å’Œç³»ç»Ÿè®¾è®¡ä¸åˆç†å¯¼è‡´çš„ï¼Œç›®å‰æ­£åœ¨é‡æ„ä¸­ã€‚</p><p>å¦‚æœä¸‹æ¬¡å†å‘ç”Ÿæ­»é”ç›´æ¥çœ‹deadlock logå§ï¼Œæ²¡å¿…è¦æµªè´¹æ—¶é—´ç¿»ä»£ç çœ‹ä¸šåŠ¡æ—¥å¿—äº†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‰æ®µæ—¶é—´å¶å°”ä¼šæ”¶åˆ°çº¿ä¸ŠMySQLæ­»é”å‘Šè­¦é€šçŸ¥ï¼Œç”±äºæœ‰è¡¥å¿æœºåˆ¶ï¼Œæœ€ç»ˆä¸šåŠ¡ä¼šå¤„ç†æˆåŠŸï¼Œæ‰€ä»¥æ²¡å¤ªå…³å¿ƒã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Deadlock found when trying to get lock; try restarting transaction&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æœ€è¿‘åˆæ”¶åˆ°äº†ç›¸åŒçš„å‘Šè­¦ï¼Œå¯èƒ½ä¸æ˜¯å¶ç„¶äº‹ä»¶ï¼Œäºæ˜¯å¼€å§‹æ’æŸ¥ã€‚&lt;br&gt;é¦–å…ˆç¿»çœ‹äº†æ—¥å¿—ï¼Œç»“åˆä»£ç ï¼Œæ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜ã€‚äº‹å‘æ—¶åº”è¯¥ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤§æ‰¹é‡å¹¶å‘äº‹ä»¶ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
    <category term="MySQL" scheme="https://jingzhouzhao.github.io/tags/MySQL/"/>
    
    <category term="Deadlock" scheme="https://jingzhouzhao.github.io/tags/Deadlock/"/>
    
  </entry>
  
  <entry>
    <title>å…³é—­ä»£ç å—ç§»åŠ¨</title>
    <link href="https://jingzhouzhao.github.io/archives/7f244d3f.html"/>
    <id>https://jingzhouzhao.github.io/archives/7f244d3f.html</id>
    <published>2020-08-25T07:22:10.000Z</published>
    <updated>2022-02-22T07:31:09.022Z</updated>
    
    <content type="html"><![CDATA[<p>Mac å¼€å¯äº†ä¸‰æŒ‡æ‹–æ‹½ï¼Œå‘ç°åœ¨IDEAçš„æŸäº›Projectä¸­ï¼Œé€‰ä¸­ä»£ç å—æ—¶ï¼Œè€æ˜¯æ‹–åŠ¨ä»£ç ã€‚è§£å†³åŠæ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Editor â€“&gt; General -&gt; Enable Dragâ€™nâ€™Drop functionality in Editor </span><br></pre></td></tr></table></figure><p>å…³é—­å³å¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Mac å¼€å¯äº†ä¸‰æŒ‡æ‹–æ‹½ï¼Œå‘ç°åœ¨IDEAçš„æŸäº›Projectä¸­ï¼Œé€‰ä¸­ä»£ç å—æ—¶ï¼Œè€æ˜¯æ‹–åŠ¨ä»£ç ã€‚è§£å†³åŠæ³•ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class</summary>
      
    
    
    
    <category term="è¸©å‘è®°å½•" scheme="https://jingzhouzhao.github.io/categories/%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨mybatisæ ‡ç­¾æ›¿æ¢ç¡¬ç¼–ç </title>
    <link href="https://jingzhouzhao.github.io/archives/ad1a887a.html"/>
    <id>https://jingzhouzhao.github.io/archives/ad1a887a.html</id>
    <published>2020-08-10T16:00:00.000Z</published>
    <updated>2022-02-22T07:31:09.012Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h2><p>åˆ©ç”¨mybatisæ ‡ç­¾æ›¿æ¢ç¡¬ç¼–ç </p><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨é¡¹ç›®ä¸­å¶å°”çœ‹åˆ°è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;querySqlString&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">       1=1</span><br><span class="line">       <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;fundsOrderIdList != null and fundsOrderIdList.size()&gt;0&quot;</span>&gt;</span></span><br><span class="line">           and funds_order_id IN</span><br><span class="line">           <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;fundsOrderIdList&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">index</span>=<span class="string">&quot;index&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">               #&#123;id&#125;</span><br><span class="line">           <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­æœ‰ä¸ª<code>1=1</code>å¾ˆæ‰çœ¼ï¼Œè¿™ä¸ªä¸æ˜¯bugï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Œåªæ˜¯ç¨‹åºå‘˜ä¸–ä»£ä¼ æ‰¿ä¸‹æ¥çš„ä¸€ä¸ªä¹ æƒ¯ã€‚</p><span id="more"></span><h2 id="æ•…äº‹"><a href="#æ•…äº‹" class="headerlink" title="æ•…äº‹"></a>æ•…äº‹</h2><p>åœ¨å¾ˆä¹…ä»¥å‰ï¼Œå……æ»¡æ™ºæ…§çš„ç¨‹åºå‘˜ä¸ºäº†è§£å†³åŠ¨æ€æ¡ä»¶æ‹¼æ¥çš„é—®é¢˜ï¼Œå‘æ˜äº†<code>1=1</code>è¿™ä¸ªå†™æ³•ï¼Œå¯¹åº”çš„è¿˜æœ‰<code>1=0</code>çš„å†™æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå†™æ³•åœ¨ä»¥å‰æ˜¯æ€ä¹ˆè§£å†³é—®é¢˜çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&quot;select * from car_table where 1=1&quot;</span></span><br><span class="line"><span class="keyword">for</span>(Condtion condition:conditions)&#123;</span><br><span class="line">    <span class="comment">/**å‡å¦‚æ²¡æœ‰1=1ï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶ç›´æ¥æ‹¼æ¥ä¸Šandè¯­æ³•å°±é”™è¯¯äº†</span></span><br><span class="line"><span class="comment">    *è¿˜å¾—åšå‡ºé¢å¤–åˆ¤æ–­æ‰è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    sql = sql + <span class="string">&quot; and &quot;</span> + condition.field + <span class="string">&quot; = &quot;</span> + condition.value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¡®å®å¾ˆå·§å¦™ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰æ€§èƒ½é—®é¢˜ï¼Œä¸ä¿¡æˆ‘ç»™ä½ ä¸¾ä¸ªğŸŒ°:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pay_channel_with_bank <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> channel_code <span class="operator">=</span> <span class="string">&#x27;50008&#x27;</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ¡å¾ˆç®€å•çš„SQLï¼Œå…¶ä¸­å°±æœ‰<code>1=1</code>çš„å†™æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹MySQLæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼˜åŒ–åå®é™…æ‰§è¡Œçš„SQL:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pay_channel_with_bank <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> channel_code <span class="operator">=</span> <span class="string">&#x27;50008&#x27;</span>;</span><br><span class="line"><span class="keyword">SHOW</span> WARNINGS;</span><br><span class="line">å®é™…æ‰§è¡Œçš„<span class="keyword">SQL</span>:</span><br><span class="line"><span class="comment">/* select#1 */</span> <span class="keyword">select</span> æ­¤å¤„çœç•¥å¾ˆå¤š<span class="keyword">column</span> <span class="keyword">from</span> `online_paychannel`.`pay_channel_with_bank` <span class="keyword">where</span> (`online_paychannel`.`pay_channel_with_bank`.`channel_code` <span class="operator">=</span> <span class="number">50008</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>1=1</code>å·²ç»è¢«ä¼˜åŒ–æ‰äº†ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>è™½ç„¶è¿™ç§å†™æ³•æ²¡å•¥å¤§é—®é¢˜ï¼Œä½†æ˜¯ä»£ç æ˜¯ç»™äººçœ‹çš„ã€‚å¦‚æœä¸äº†è§£è¿™ç§å†™æ³•ï¼Œä¹ä¸€çœ¼çœ‹è¿‡å»è‚¯å®šæœ‰ç‚¹æ‡µã€‚</p><p>è€Œä¸”æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„Mybatisæä¾›çš„<code>&lt;where&gt;</code>æ ‡ç­¾æœ¬èº«å°±ä¼šå¸®æˆ‘ä»¬åšä¼˜åŒ–:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyPrefix</span><span class="params">(StringBuilder sql, String trimmedUppercaseSql)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!prefixApplied) &#123;</span><br><span class="line">        prefixApplied = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (prefixesToOverride != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (String toRemove : prefixesToOverride) &#123;</span><br><span class="line">            <span class="comment">//æ­¤å¤„ä¼šç§»é™¤ä¸€äº›å‰ç¼€  </span></span><br><span class="line">            <span class="keyword">if</span> (trimmedUppercaseSql.startsWith(toRemove)) &#123;</span><br><span class="line">              sql.delete(<span class="number">0</span>, toRemove.trim().length());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (prefix != <span class="keyword">null</span>) &#123;</span><br><span class="line">          sql.insert(<span class="number">0</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">          sql.insert(<span class="number">0</span>, prefix);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>WhereSqlNode</code>ä¸­å®šä¹‰çš„<code>prefixesToOverride</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; prefixList = Arrays.asList(<span class="string">&quot;AND &quot;</span>,<span class="string">&quot;OR &quot;</span>,<span class="string">&quot;AND\n&quot;</span>, <span class="string">&quot;OR\n&quot;</span>, <span class="string">&quot;AND\r&quot;</span>, <span class="string">&quot;OR\r&quot;</span>, <span class="string">&quot;AND\t&quot;</span>, <span class="string">&quot;OR\t&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä½¿ç”¨äº†<code>&lt;where&gt;</code>æ ‡ç­¾åå¯ä»¥æ”¾å¿ƒå¤§èƒ†çš„å»æ‰<code>1=1</code>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å»ºè®®&quot;&gt;&lt;a href=&quot;#å»ºè®®&quot; class=&quot;headerlink&quot; title=&quot;å»ºè®®&quot;&gt;&lt;/a&gt;å»ºè®®&lt;/h2&gt;&lt;p&gt;åˆ©ç”¨mybatisæ ‡ç­¾æ›¿æ¢ç¡¬ç¼–ç &lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;åœ¨é¡¹ç›®ä¸­å¶å°”çœ‹åˆ°è¿™æ ·çš„ä»£ç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;sql&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;querySqlString&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;where&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       1=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;test&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;fundsOrderIdList != null and fundsOrderIdList.size()&amp;gt;0&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           and funds_order_id IN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;foreach&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;collection&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;fundsOrderIdList&amp;quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;item&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;id&amp;quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;index&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;index&amp;quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;open&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;(&amp;quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;close&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;)&amp;quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;separator&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               #&amp;#123;id&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;foreach&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;if&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è¿™æ®µä»£ç ä¸­æœ‰ä¸ª&lt;code&gt;1=1&lt;/code&gt;å¾ˆæ‰çœ¼ï¼Œè¿™ä¸ªä¸æ˜¯bugï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Œåªæ˜¯ç¨‹åºå‘˜ä¸–ä»£ä¼ æ‰¿ä¸‹æ¥çš„ä¸€ä¸ªä¹ æƒ¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>å‘½ä»¤æ”¶è—</title>
    <link href="https://jingzhouzhao.github.io/archives/afa41a9c.html"/>
    <id>https://jingzhouzhao.github.io/archives/afa41a9c.html</id>
    <published>2020-07-22T02:45:53.000Z</published>
    <updated>2022-02-22T07:31:09.020Z</updated>
    
    <content type="html"><![CDATA[<h2 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h2><h4 id="å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™"><a href="#å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™" class="headerlink" title="å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)"></a>å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)</h4><ul><li>é‡å¯ <code>command+R</code> è¿›å…¥æ¢å¤ç•Œé¢</li><li>å®ç”¨å·¥å…· - ç»ˆç«¯ è¾“å…¥ï¼š<code>csrutil disable</code></li><li>é‡å¯ï¼š<code>reboot</code></li><li>æ‰“å¼€ç»ˆç«¯ï¼ŒæŒ‚è½½æ ¹ç›®å½•ï¼š<code>sudo mount -uw /</code><span id="more"></span><h4 id="æŸ¥çœ‹ç«¯å£"><a href="#æŸ¥çœ‹ç«¯å£" class="headerlink" title="æŸ¥çœ‹ç«¯å£"></a>æŸ¥çœ‹ç«¯å£</h4></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -i:9999</span><br></pre></td></tr></table></figure><h2 id="brew"><a href="#brew" class="headerlink" title="brew"></a>brew</h2><h4 id="æ›´æ–°app"><a href="#æ›´æ–°app" class="headerlink" title="æ›´æ–°app"></a>æ›´æ–°app</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cu -a -f</span><br></pre></td></tr></table></figure><h2 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h2><h4 id="ä¿å­˜å †å¿«ç…§"><a href="#ä¿å­˜å †å¿«ç…§" class="headerlink" title="ä¿å­˜å †å¿«ç…§"></a>ä¿å­˜å †å¿«ç…§</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=heapdump.hprof pid</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;mac&quot;&gt;&lt;a href=&quot;#mac&quot; class=&quot;headerlink&quot; title=&quot;mac&quot;&gt;&lt;/a&gt;mac&lt;/h2&gt;&lt;h4 id=&quot;å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™&quot;&gt;&lt;a href=&quot;#å…³é—­SPI-è·å–æ ¹ç›®å½•å†™æƒé™&quot; class=&quot;headerlink&quot; title=&quot;å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)&quot;&gt;&lt;/a&gt;å…³é—­SPI(è·å–æ ¹ç›®å½•å†™æƒé™)&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;é‡å¯ &lt;code&gt;command+R&lt;/code&gt; è¿›å…¥æ¢å¤ç•Œé¢&lt;/li&gt;
&lt;li&gt;å®ç”¨å·¥å…· - ç»ˆç«¯ è¾“å…¥ï¼š&lt;code&gt;csrutil disable&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é‡å¯ï¼š&lt;code&gt;reboot&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æ‰“å¼€ç»ˆç«¯ï¼ŒæŒ‚è½½æ ¹ç›®å½•ï¼š&lt;code&gt;sudo mount -uw /&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;</summary>
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>å¸¸è§é›†ç¾¤æ–¹å¼</title>
    <link href="https://jingzhouzhao.github.io/archives/6a6e8ff1.html"/>
    <id>https://jingzhouzhao.github.io/archives/6a6e8ff1.html</id>
    <published>2020-06-16T05:45:53.000Z</published>
    <updated>2022-02-22T07:31:09.021Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸»ä»ï¼ˆmaster-slaveï¼‰"><a href="#ä¸»ä»ï¼ˆmaster-slaveï¼‰" class="headerlink" title="ä¸»ä»ï¼ˆmaster-slaveï¼‰"></a>ä¸»ä»ï¼ˆmaster-slaveï¼‰</h3><p>å†™masterï¼ŒåŒæ­¥åˆ°slave ã€‚slaveå¯ç”¨äºè¯»ã€‚å¸¸è§mysqlï¼Œredisã€‚</p><h3 id="å“¨å…µ"><a href="#å“¨å…µ" class="headerlink" title="å“¨å…µ"></a>å“¨å…µ</h3><p>åœ¨ä¸»ä»çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†masterå®•æœºæ—¶ï¼Œslaveè‡ªåŠ¨åˆ‡æ¢ä¸ºmasterã€‚</p><h3 id="cluster"><a href="#cluster" class="headerlink" title="cluster"></a>cluster</h3><p>é›†ç¾¤å†…æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯åˆ†ç‰‡ã€‚é€šè¿‡åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®æ²Ÿé€šã€‚</p><p>ä¾‹å¦‚redisï¼Œé€šè¿‡Gossip åè®®ï¼Œåœ¨é›†ç¾¤å†…åŒæ­¥ï¼Œå„ä¸ªåˆ†ç‰‡çš„å“ˆå¸Œæ§½ä¿¡æ¯ã€‚</p><p>ä¾¿äºé‡å®šå‘è¯·æ±‚ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸»ä»ï¼ˆmaster-slaveï¼‰&quot;&gt;&lt;a href=&quot;#ä¸»ä»ï¼ˆmaster-slaveï¼‰&quot; class=&quot;headerlink&quot; title=&quot;ä¸»ä»ï¼ˆmaster-slaveï¼‰&quot;&gt;&lt;/a&gt;ä¸»ä»ï¼ˆmaster-slaveï¼‰&lt;/h3&gt;&lt;p&gt;å†™masterï¼ŒåŒæ­¥åˆ°sla</summary>
      
    
    
    
    <category term="è¯»ä¹¦ç¬”è®°" scheme="https://jingzhouzhao.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>RocketMQ RMQ_SYS_TRANS_HALF_TOPIC çˆ†æ‰çš„é—®é¢˜</title>
    <link href="https://jingzhouzhao.github.io/archives/cfa05355.html"/>
    <id>https://jingzhouzhao.github.io/archives/cfa05355.html</id>
    <published>2020-06-05T05:22:44.000Z</published>
    <updated>2022-02-22T07:31:09.009Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç°è±¡"><a href="#ç°è±¡" class="headerlink" title="ç°è±¡"></a>ç°è±¡</h2><p>SaaSé¡¹ç›®ä¸œéƒ­ååº”ï¼Œé¡¹ç›®ä¸­å‘çš„äº‹åŠ¡æ¶ˆæ¯ä¸€ç›´åœ¨<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ä¸­ï¼Œå¹¶ä¸”ä¸æ–­å¢é•¿ã€‚éšå³æˆ‘ä»¬æŸ¥çœ‹RocketMQæ—¥å¿—å‘ç°å¦‚ä¸‹æƒ…å†µï¼š<img src="https://files.catbox.moe/gdp5ap.png"></p><p>è¿™ä¸ªæœ¬æ¥æ˜¯RocketMQæ­£å¸¸çš„é€»è¾‘ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯åæ²¡æœ‰æäº¤çŠ¶æ€çš„è¯ï¼Œå½“è¾¾åˆ°è¶…æ—¶æ—¶é—´åï¼ŒRocketMQä¼šå›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ã€‚è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯å›æŸ¥çš„æ¬¡æ•°è¶…é™ï¼Œæ¶ˆæ¯è¢«ç§»åˆ°äº†<code>TRANS_CHECK_MAXTIME_TOPIC</code>ä¸­ã€‚</p><p>ä¸æ­£å¸¸çš„æ˜¯<code>REAL_TOPIC</code>å˜æˆäº†<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ï¼Œæ­£å¸¸åº”è¯¥æ˜¯åŸå§‹çš„ä¸šåŠ¡æ¶ˆæ¯TOPICæ‰å¯¹ã€‚äºæ˜¯æˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜å¼€å§‹æ’æŸ¥èµ·æ¥ã€‚</p><span id="more"></span><h2 id="è¿½è¸ª"><a href="#è¿½è¸ª" class="headerlink" title="è¿½è¸ª"></a>è¿½è¸ª</h2><h4 id="ä¸€ã€æ’æŸ¥"><a href="#ä¸€ã€æ’æŸ¥" class="headerlink" title="ä¸€ã€æ’æŸ¥"></a>ä¸€ã€æ’æŸ¥</h4><p>ä¸€å¼€å§‹æˆ‘ä»¬ä»¥ä¸ºæ˜¯Producerçš„é—®é¢˜ï¼Œå› ä¸ºå¾—åˆ°çš„åé¦ˆæ˜¯è¿™ä¸ªæ¶ˆæ¯æ²¡æœ‰è¢«â€œæ¶ˆè´¹â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å§‹æ’æŸ¥Produceræ‰€åœ¨çš„é¡¹ç›®ã€‚å‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚åæ¥æˆ‘ä»¬è§‚å¯Ÿåˆ°ä¸Šè¿°æ—¥å¿—ä¸­æœ‰ä¸€ä¸ªDELAY=3ï¼Œç»“åˆåœ¨ç½‘ä¸ŠæŸ¥è¯¢çš„<a href="http://mail-archives.apache.org/mod_mbox/rocketmq-dev/201910.mbox/%3C157129868332.7323.16435164322004213562.gitbox@gitbox.apache.org%3E">èµ„æ–™</a>ï¼Œè®¤ä¸ºå¯èƒ½æ˜¯è§¦å‘äº†RocketMQçš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯äº‹åŠ¡æ¶ˆæ¯è¿›è¡Œäº†å»¶è¿Ÿå‘é€ã€‚æˆ‘ä»¬ä»¥ä¸ºå¿«æ¥è¿‘çœŸç›¸äº†ï¼Œæˆ‘ä»¬å¼€å§‹æŸ¥æ‰¾Produceræ˜¯å¦åœ¨å‘é€äº‹åŠ¡æ¶ˆæ¯æ—¶è®¾ç½®äº†DELAYå‚æ•°ã€‚å¾ˆå¿«æˆ‘ä»¬å°±å¤±æœ›äº†ï¼ŒProduceræ²¡æœ‰ä»»ä½•åœ°æ–¹è®¾ç½®äº†DELAYå‚æ•°ã€‚</p><h4 id="äºŒã€ç¿»é˜…æºç "><a href="#äºŒã€ç¿»é˜…æºç " class="headerlink" title="äºŒã€ç¿»é˜…æºç "></a>äºŒã€ç¿»é˜…æºç </h4><p>æˆ‘ä»¬å›å¤´å»çœ‹ä¸Šé¢é‚£ä¸ªæ—¥å¿—ï¼Œå‘ç°<code>RECONSUME_TIME=1</code>å¹¶ä¸”<code>RETRY_TOPIC</code>ä¹Ÿä¸ä¸ºç©ºï¼Œè¿™è¯´æ˜è¿™ä¸ªæ¶ˆæ¯è‚¯å®šæ˜¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°äº†ï¼Œä½†æ˜¯ç”±äºæŸç§åŸå› æ¶ˆè´¹å¤±è´¥äº†ï¼Œè§¦å‘äº†é‡è¯•ã€‚äºæ˜¯æˆ‘ä»¬å¼€å§‹çœ‹RocketMQé‡è¯•ç›¸å…³æºç ã€‚æˆ‘ä»¬é¦–å…ˆæ‰¾åˆ°äº†DELAY=3è¿™ä¸ªå‚æ•°çš„æ¥æºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨æˆ‘ä»¬çš„æ¶ˆè´¹è€…ä¸­è®¾ç½®äº†ConsumeConcurrentlyContext å»¶æ—¶çº§åˆ«</span></span><br><span class="line">context.setDelayLevelWhenNextConsume(getDelayLevelWhenNextConsume(reconsumeTimes));</span><br><span class="line"><span class="comment">//å¯ä»¥çœ‹åˆ°è¿™ä¸ªdelayLevelæœ€ç»ˆæ˜¯ä¼šè¢«å‘é€åˆ°broker</span></span><br><span class="line"><span class="comment">//org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService#sendMessageBack</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageBack</span><span class="params">(<span class="keyword">final</span> MessageExt msg, <span class="keyword">final</span> ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> delayLevel = context.getDelayLevelWhenNextConsume();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wrap topic with namespace before sending back message.</span></span><br><span class="line">  msg.setTopic(<span class="keyword">this</span>.defaultMQPushConsumer.withNamespace(msg.getTopic()));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.defaultMQPushConsumerImpl.sendMessageBack(msg, delayLevel, context.getMessageQueue().getBrokerName());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;sendMessageBack exception, group: &quot;</span> + <span class="keyword">this</span>.consumerGroup + <span class="string">&quot; msg: &quot;</span> + msg.toString(), e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰¾åˆ°å¯¹åº”brokerç‰ˆæœ¬(4.6.0)çš„æºç ä¸€æ­¥æ­¥æ‰¾åˆ°äº†è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.store.CommitLog#putMessage</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line"><span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE</span><br><span class="line">    || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</span><br><span class="line">  <span class="comment">// Delay Delivery</span></span><br><span class="line">  <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">      msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    topic = ScheduleMessageService.SCHEDULE_TOPIC;</span><br><span class="line">    queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Backup real topic, queueId</span></span><br><span class="line">    MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">    MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">    msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line"></span><br><span class="line">    msg.setTopic(topic);</span><br><span class="line">    msg.setQueueId(queueId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ç…§ä¹‹å‰æ—¥å¿—é‡Œçš„å‚æ•°ï¼Œ<code>sysFlag=8,delay=3</code>ï¼Œæˆ‘ä»¬è®¤ä¸ºå¾ˆå¯èƒ½èµ°äº†è¿™æ®µé€»è¾‘ï¼Œç„¶åè§¦å‘äº†äº‹åŠ¡æ¶ˆæ¯è¿›è¡Œäº†å»¶è¿Ÿå‘é€çš„é—®é¢˜ã€‚ç»§ç»­çœ‹äº†å»¶æ—¶æ¶ˆæ¯å‘é€çš„é€»è¾‘ï¼Œæ²¡æœ‰æ‰¾åˆ°é—®é¢˜ï¼Œè€Œä¸”è¿™ä¹Ÿè§£é‡Šä¸äº†ä¸ºä»€ä¹ˆ<code>REAL_TOPIC</code>å˜æˆäº†``RMQ_SYS_TRANS_HALF_TOPIC`</p><h4 id="ä¸‰ã€çœŸç›¸"><a href="#ä¸‰ã€çœŸç›¸" class="headerlink" title="ä¸‰ã€çœŸç›¸"></a>ä¸‰ã€çœŸç›¸</h4><p>ä¸Šé¢è¿˜æåˆ°äº†ä¸€ä¸ª<code>RETRY_TOPIC</code>ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰çš„æ’æŸ¥è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç°æœ‰ä»€ä¹ˆåœ°æ–¹è®¾ç½®ï¼Œäºæ˜¯æˆ‘ä»¬æœç´¢äº†ä¸€æŠŠï¼Œå‘ç°åœ¨è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl#sendMessageBack</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageBack</span><span class="params">(MessageExt msg, <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> String brokerName)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String brokerAddr = (<span class="keyword">null</span> != brokerName) ? <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</span><br><span class="line">            : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</span><br><span class="line">        <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</span><br><span class="line">            <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class="number">5000</span>, getMaxReconsumeTimes());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;sendMessageBack Exception, &quot;</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</span><br><span class="line"></span><br><span class="line">        Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</span><br><span class="line"></span><br><span class="line">        String originMsgId = MessageAccessor.getOriginMessageId(msg);</span><br><span class="line">        MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</span><br><span class="line"></span><br><span class="line">        newMsg.setFlag(msg.getFlag());</span><br><span class="line">        MessageAccessor.setProperties(newMsg, msg.getProperties());</span><br><span class="line">       <span class="comment">//è¿™é‡Œè®¾ç½®äº†RETRY_TOPIC</span></span><br><span class="line">        MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</span><br><span class="line">        MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class="number">1</span>));</span><br><span class="line">        MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</span><br><span class="line">       </span><br><span class="line">        newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), <span class="keyword">this</span>.defaultMQPushConsumer.getNamespace()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾æ˜¯ä¸ªå¼‚å¸¸æµç¨‹ï¼Œé‚£ä¹ˆåˆ°åº•æ˜¯ä»€ä¹ˆå¯¼è‡´äº†è¿™ä¸ªå¼‚å¸¸æµç¨‹å‘¢ï¼Ÿæ—¢ç„¶çŸ¥é“æ˜¯åœ¨æ¶ˆè´¹çš„æ—¶å€™å‡ºäº†å¼‚å¸¸ï¼Œäºæ˜¯æˆ‘ä»¬æ‰¾åˆ°å¯¹åº”çš„æ¶ˆè´¹è€…æ—¥å¿—ï¼Œå‘ç°å¦‚ä¸‹é”™è¯¯ï¼š</p><p><img src="https://files.catbox.moe/42fapz.png"></p><p>è¿™é‡ŒBrokerè¿”å›çš„é”™è¯¯æ˜¯<code>MESSAGE_ILIEGAL</code>ï¼Œåœ¨å›è¿‡å¤´å»çœ‹é‡è¯•ç›¸å…³ä»£ç ï¼Œæœ‰äº†ä¹‹å‰çš„ç»éªŒè¿™æ¬¡å¾ˆå¿«å°±å®šä½åˆ°äº†å¯èƒ½æŠ¥è¿™ä¸ªé”™è¯¯çš„åœ°æ–¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¬¬ä¸€å¤„ï¼šorg.apache.rocketmq.store.DefaultMessageStore#putMessage </span></span><br><span class="line"><span class="keyword">if</span> (msg.getTopic().length() &gt; Byte.MAX_VALUE) &#123;</span><br><span class="line"> log.warn(<span class="string">&quot;putMessage message topic length too long &quot;</span> + msg.getTopic().length());</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, <span class="keyword">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//ç¬¬äºŒå¤„ï¼šorg.apache.rocketmq.store.CommitLog.DefaultAppendMessageCallback#doAppend(long, java.nio.ByteBuffer, int, org.apache.rocketmq.store.MessageExtBrokerInner)</span></span><br><span class="line"><span class="keyword">if</span> (propertiesLength &gt; Short.MAX_VALUE) &#123;</span><br><span class="line">  log.warn(<span class="string">&quot;putMessage message properties length too long. length=&#123;&#125;&quot;</span>, propertiesData.length);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</span><br><span class="line">                    beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</span><br></pre></td></tr></table></figure><p>æœæ–­æ‰¾è¿ç»´è¦äº†<code>store.log</code>ï¼Œå‘ç°å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARN SendMessageThread_1 - putMessage message topic length too long 149</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åº”è¯¥å°±æ˜¯ç¬¬ä¸€å¤„çš„é—®é¢˜äº†ã€‚è‡³æ­¤é—®é¢˜çš„åŸå› åŸºæœ¬æ‰¾åˆ°äº†ï¼Œä½†è¿˜æœ‰ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li><p>ä¸ºä»€ä¹ˆTOPICä¼šè¶…é•¿ï¼Ÿ</p><p>é‡è¯•çš„æ¶ˆæ¯TOPICè§„åˆ™ä¸º%RETRY%+consumerGroupï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup())</span><br></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬çš„consumerGroupçš„è§„åˆ™ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> group + <span class="string">&quot;_&quot;</span> + getTopic() + <span class="string">&quot;_&quot;</span> + getTags();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰é—®é¢˜çš„consumerçš„tagsä¸ºï¼š<code>SAAS_PURCHASE_PURCHASE_ORDER_UPDATE||SAAS_PURCHASE_PURCHASE_ORDER_OPEN_RECEVIED||SAAS_PURCHASE_PURCHASE_ORDER_COMPLETED_RECEVIED</code></p><p>æ‰€ä»¥æœ€ç»ˆæ‹¼å‡ºæ¥çš„TOPICè¶…å‡ºäº†é•¿åº¦ã€‚</p></li><li><p>ä¸ºä»€ä¹ˆèµ°äº†Catché‡Œé¢çš„æµç¨‹å°±ä¼šå¯¼è‡´HALFé˜Ÿåˆ—çˆ†æ‰ï¼Ÿ</p><p>è¿™æ˜¯ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„RocketMQ-clientç‰ˆæœ¬ä¸º<code>4.5.0</code>ï¼Œè¿™ä¸ªç‰ˆæœ¬Catché‡Œçš„ä»£ç æœ‰ä¸ªbugï¼Œæ²¡æœ‰æ¸…é™¤æ‰åŸå§‹æ¶ˆæ¯çš„äº‹åŠ¡æ¶ˆæ¯æ ‡å¿—<code>TRANS_MSG=true</code>ã€‚æ‰€ä»¥è¿™ä¸ªæ¶ˆæ¯å‘å‡ºå»ååœ¨brokerç«¯åˆä¼šèµ°äº‹åŠ¡æ¶ˆæ¯çš„æµç¨‹ï¼Œå¹¶ä¸”è¿˜æ˜¯å¸¦å»¶æ—¶çš„ã€‚è¿™ä¼šå¯¼è‡´çœŸå®çš„TOPICä¸¢æ‰ã€‚</p><p>ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ä¸€ä¸‹ï¼š</p><p><img src="https://files.catbox.moe/ssraef.png"></p><p>äº‹åŠ¡æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œtopicè½¬ä¸º<code>%RETRY%xxxx</code>å‘é€åˆ°brokerï¼Œç”±äºäº‹åŠ¡æ¶ˆæ¯æ ‡å¿—æ²¡æœ‰è¢«æ¸…é™¤ï¼Œäºæ˜¯topicè½¬æˆäº†<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ã€‚åˆç”±äºdelayå‚æ•°æ²¡æœ‰è¢«æ¸…é™¤ï¼Œtopicæœ€åè¢«è½¬ä¸ºäº†<code>schedule_topic_xxxx</code>ã€‚ç­‰åˆ°scheduleæ‰§è¡Œæ—¶ï¼Œæ¶ˆæ¯ä¼šå‘åˆ°<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ä¸­ã€‚ç”±äºä¸æ˜¯Producerå‘çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œæ‰€ä»¥æ‹¿ä¸åˆ°LocalTransactionStateã€‚åªèƒ½ç­‰å¾…äº‹åŠ¡æ¶ˆæ¯å›æŸ¥ã€‚</p><p>è¿™æ—¶åˆšå¥½åˆç¢°åˆ°æˆ‘ä»¬çš„LocalTransactionListenerçš„ä¸€ä¸ªé—®é¢˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt messageExt)</span> </span>&#123;</span><br><span class="line">  Object msg = HessianUtils.decode(messageExt.getBody());</span><br><span class="line">  String topic = messageExt.getTopic();</span><br><span class="line">  String tag = messageExt.getTags();</span><br><span class="line">  <span class="comment">//ç”±äºæ‹¿ç€rmq_sys_trans_half_topicæ¥è·å–handleræ‰€ä»¥è‚¯å®šè·å–ä¸åˆ°ã€‚</span></span><br><span class="line">  LocalTransactionHandler localTransacationHandler = getLocalTransacationHandler(topic, tag);</span><br><span class="line"></span><br><span class="line">  String msgId = messageExt.getMsgId();</span><br><span class="line">  <span class="keyword">if</span>( localTransacationHandler == <span class="keyword">null</span> )&#123;</span><br><span class="line">    logger.error(<span class="string">&quot;localTransacationHandler is empty should never happened! msgId=&#123;&#125;, arg=&#123;&#125;&quot;</span>, msgId, JSON.toJSONString(msg));</span><br><span class="line">    <span class="comment">//äºæ˜¯è¿™ä¸ªåœ°æ–¹ä¼šè¿”å›COMMIT_MESSAGE</span></span><br><span class="line">    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">boolean</span> checkResult = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    checkResult = localTransacationHandler.localTransactionCheck(msgId, msg);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;localTransacationCheck failed! msgId=&#123;&#125;, arg=&#123;&#125;&quot;</span>, msgId, JSON.toJSONString(msg), e);</span><br><span class="line">    checkResult = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> checkResult ? LocalTransactionState.COMMIT_MESSAGE : LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Brokeræ”¶åˆ°<code>COMMIT_MESSAGE</code>åä¼šå°†æ¶ˆæ¯å†™å¾€REAL_TOPICä¸­ã€‚è€Œæ­¤æ—¶REAL_TOPICæ—©å·²å˜æˆäº†<code>RMQ_SYS_TRANS_HALF_TOPIC</code>ã€‚å°±è¿™æ ·ï¼Œ<code>RMQ_SYS_TRANS_HALF_TOPIC </code>çˆ†æ‰äº†ã€‚</p></li></ol><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h2><ol><li><p>é¦–å…ˆæˆ‘ä»¬å°†handlerä¸ºç©ºæ—¶è¿”å›<code>COMMIT_MESSAGE</code>ï¼Œæ”¹ä¸ºäº†<code>ROLLBACK_MESSAGE</code>ã€‚</p></li><li><p>å‡çº§stoneä¸­RocketMQä¸º4.6.1ï¼Œå¯ä»¥çœ‹åˆ°åœ¨Catchä»£ç ä¸­å¤šäº†ä¸€è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageAccessor.clearProperty(newMsg, &quot;TRAN_MSG&quot;);</span><br></pre></td></tr></table></figure></li><li><p>æœ‰é—®é¢˜çš„consumerå°†tagæ‹†åˆ†</p><p>ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥åªèƒ½è§£å†³<code>RMQ_SYS_TRANS_HALF_TOPIC</code>çˆ†æ‰çš„é—®é¢˜ã€‚ä½†æ˜¯topicè¶…é•¿è¿˜æ˜¯ä¼šæœ‰é—®é¢˜ã€‚æ‰€ä»¥ç›®å‰æš‚æ—¶æ˜¯å°†consumerçš„tagæ‹†å¼€ã€‚</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç°è±¡&quot;&gt;&lt;a href=&quot;#ç°è±¡&quot; class=&quot;headerlink&quot; title=&quot;ç°è±¡&quot;&gt;&lt;/a&gt;ç°è±¡&lt;/h2&gt;&lt;p&gt;SaaSé¡¹ç›®ä¸œéƒ­ååº”ï¼Œé¡¹ç›®ä¸­å‘çš„äº‹åŠ¡æ¶ˆæ¯ä¸€ç›´åœ¨&lt;code&gt;RMQ_SYS_TRANS_HALF_TOPIC&lt;/code&gt;ä¸­ï¼Œå¹¶ä¸”ä¸æ–­å¢é•¿ã€‚éšå³æˆ‘ä»¬æŸ¥çœ‹RocketMQæ—¥å¿—å‘ç°å¦‚ä¸‹æƒ…å†µï¼š&lt;img src=&quot;https://files.catbox.moe/gdp5ap.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæœ¬æ¥æ˜¯RocketMQæ­£å¸¸çš„é€»è¾‘ï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯åæ²¡æœ‰æäº¤çŠ¶æ€çš„è¯ï¼Œå½“è¾¾åˆ°è¶…æ—¶æ—¶é—´åï¼ŒRocketMQä¼šå›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€ã€‚è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯å›æŸ¥çš„æ¬¡æ•°è¶…é™ï¼Œæ¶ˆæ¯è¢«ç§»åˆ°äº†&lt;code&gt;TRANS_CHECK_MAXTIME_TOPIC&lt;/code&gt;ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¸æ­£å¸¸çš„æ˜¯&lt;code&gt;REAL_TOPIC&lt;/code&gt;å˜æˆäº†&lt;code&gt;RMQ_SYS_TRANS_HALF_TOPIC&lt;/code&gt;ï¼Œæ­£å¸¸åº”è¯¥æ˜¯åŸå§‹çš„ä¸šåŠ¡æ¶ˆæ¯TOPICæ‰å¯¹ã€‚äºæ˜¯æˆ‘ä»¬å¸¦ç€è¿™ä¸ªé—®é¢˜å¼€å§‹æ’æŸ¥èµ·æ¥ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Java" scheme="https://jingzhouzhao.github.io/tags/Java/"/>
    
    <category term="RocketMQ" scheme="https://jingzhouzhao.github.io/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>è¯»å–Jarä¸­æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</title>
    <link href="https://jingzhouzhao.github.io/archives/f728629b.html"/>
    <id>https://jingzhouzhao.github.io/archives/f728629b.html</id>
    <published>2020-03-19T03:47:54.000Z</published>
    <updated>2022-02-22T07:31:09.015Z</updated>
    
    <content type="html"><![CDATA[<p>è¯»å–Jarä¸­æ–‡ä»¶ä½¿ç”¨ç±»ä¼¼getResourceAsStreamç­‰ä»¥æµçš„æ–¹å¼è·å–å³å¯ã€‚ä½†æ˜¯æƒ³è¦è¯»å–Jarä¸­æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å´ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚</p><span id="more"></span><h2 id="ç¬¬ä¸€ç§æ–¹å¼"><a href="#ç¬¬ä¸€ç§æ–¹å¼" class="headerlink" title="ç¬¬ä¸€ç§æ–¹å¼"></a>ç¬¬ä¸€ç§æ–¹å¼</h2><p>é¦–å…ˆè¦è¯»å–Jarä¸­çš„ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¾—å…ˆææ¸…æ¥šJarä¸­çš„ç›®å½•ç»“æ„ï¼Œä¾‹å¦‚å¸¸è§çš„SpringBootæ‰“åŒ…åçš„Jarä¸­ç›®å½•å¦‚ä¸‹ï¼š</p><p><img src="/archives/f728629b/1.png" alt="1"></p><p>å‡å¦‚æˆ‘ä»¬è¦è¯»å–çš„ç›®å½•æ˜¯<code>BOOT-INF/classes/processes</code>ï¼ˆå¯¹åº”æºæ–‡ä»¶ç›®å½•æ˜¯<code>resources/processes</code>ï¼‰</p><p><img src="/archives/f728629b/2.png" alt="2"></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–å½“å‰Jaræ–‡ä»¶è·¯å¾„</span></span><br><span class="line">URL url = <span class="keyword">this</span>.getClass().getClassLoader().getResource(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    String jarPath = url.toString().substring(<span class="number">0</span>, url.toString().indexOf(<span class="string">&quot;!/&quot;</span>) + <span class="number">2</span>);</span><br><span class="line">    log.info(<span class="string">&quot;jarPath:&#123;&#125;&quot;</span>, jarPath);</span><br><span class="line">    URL jarURL = <span class="keyword">new</span> URL(jarPath);</span><br><span class="line">    JarURLConnection jarCon = (JarURLConnection) jarURL.openConnection();</span><br><span class="line">    JarFile jarFile = jarCon.getJarFile();</span><br><span class="line"><span class="comment">//è·å–Jarä¸‹æ‰€æœ‰æ–‡ä»¶</span></span><br><span class="line">    Enumeration&lt;JarEntry&gt; entries = jarFile.entries();</span><br><span class="line"><span class="comment">//éå†æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">        JarEntry jarEntry = entries.nextElement();</span><br><span class="line">      <span class="comment">//è·å–æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        String innerPath = jarEntry.getName();</span><br><span class="line">        log.info(<span class="string">&quot;jarEntry Name:&#123;&#125;&quot;</span>, innerPath);</span><br><span class="line">      <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†çš„ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ŒPROCESSES=BOOT-INF/classes/processes</span></span><br><span class="line">        <span class="keyword">if</span> (innerPath.startsWith(PROCESSES) &amp;&amp; !jarEntry.isDirectory()) &#123;</span><br><span class="line">          <span class="comment">//è·å–åˆ°æ–‡ä»¶æµ</span></span><br><span class="line">            InputStream inputStream = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(innerPath);</span><br><span class="line">          <span class="comment">//doSomething</span></span><br><span class="line">          <span class="comment">//......</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹å¼ä¼˜ç¼ºç‚¹ï¼šæ— ç¬¬ä¸‰æ–¹åº“ä¾èµ–ï¼Œç”¨çš„éƒ½æ˜¯JDK ç›¸å…³APIã€‚ä½†æ˜¯åªèƒ½åœ¨jaræ¨¡å¼ä¸‹è¿è¡Œï¼Œæœ¬åœ°è°ƒè¯•ä¼šå‡ºé”™ã€‚</p><h2 id="ç¬¬äºŒç§æ–¹å¼"><a href="#ç¬¬äºŒç§æ–¹å¼" class="headerlink" title="ç¬¬äºŒç§æ–¹å¼"></a>ç¬¬äºŒç§æ–¹å¼</h2><p>å¦‚æœæœ‰ä½¿ç”¨åˆ°Springï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯æ‰“æˆJarè¿è¡Œè¿˜æ˜¯æœ¬åœ°è¿è¡Œï¼Œè·å–æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å°±å¾ˆç®€å•äº†ã€‚ä¸»è¦æ˜¯åˆ©ç”¨äº†Spring çš„<code>ResourcePatternResolver</code>ï¼Œè¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    List&lt;Resource&gt; resourceList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//PROCESS_DEFINITION_LOCATION_SUFFIXES = Arrays.asLIst(&quot;**.bpmn20.xml&quot;,&quot;**.bpmn&quot;)</span></span><br><span class="line">    <span class="keyword">for</span> (String suffix : PROCESS_DEFINITION_LOCATION_SUFFIXES) &#123;</span><br><span class="line">      <span class="comment">//PROCESS_DEFINITION_LOCATION_SUFFIXES = classpath://processes/</span></span><br><span class="line">        <span class="comment">//æ‹¼æ¥è·¯å¾„pattern</span></span><br><span class="line">        String path = PROCESS_DEFINITION_LOCATION_PREFIX + suffix;</span><br><span class="line">      <span class="comment">//é€šè¿‡ResourcePatternResolverè·å–èµ„æºæ–‡ä»¶,</span></span><br><span class="line">        <span class="comment">//resourceLoader = @Autowired ResourcePatternResolver resourceLoader</span></span><br><span class="line">        Resource[] resources = resourceLoader.getResources(path);</span><br><span class="line">        <span class="keyword">if</span> (resources != <span class="keyword">null</span> &amp;&amp; resources.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            resourceList.addAll(Arrays.asList(resources));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//é€šè¿‡resource.getInputStream()å³å¯è·å–æ–‡ä»¶æµ</span></span><br><span class="line"><span class="comment">//doSomething</span></span><br><span class="line"><span class="comment">//......</span></span><br></pre></td></tr></table></figure><p>æ­¤æ–¹å¼ä¼˜ç¼ºç‚¹ï¼Œä¾èµ–äº†Springæ¡†æ¶ï¼Œä½†æ˜¯å¯¹è¿è¡Œç¯å¢ƒæ²¡æœ‰è¦æ±‚ã€‚</p><p>æ€»ç»“ï¼š</p><p>æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œæ¯•ç«Ÿç°åœ¨åŸºæœ¬ä¸Šéƒ½ä¼šä½¿ç”¨åˆ°Springã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¯»å–Jarä¸­æ–‡ä»¶ä½¿ç”¨ç±»ä¼¼getResourceAsStreamç­‰ä»¥æµçš„æ–¹å¼è·å–å³å¯ã€‚ä½†æ˜¯æƒ³è¦è¯»å–Jarä¸­æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å´ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>tk.mybatisä¸Activitiå…±å­˜é—®é¢˜è§£å†³</title>
    <link href="https://jingzhouzhao.github.io/archives/7008e148.html"/>
    <id>https://jingzhouzhao.github.io/archives/7008e148.html</id>
    <published>2020-03-05T12:53:07.000Z</published>
    <updated>2022-02-22T07:31:09.011Z</updated>
    
    <content type="html"><![CDATA[<p>ç”±äºtk.mybatisä¾èµ–äº†persistence-apiï¼Œä¼šè®©Activitiè£…é…JpaProcessEngineAutoConfigurationï¼Œå› ä¸ºå…¶@conditonalOnclass(name = â€œjavax.persistence.EntityManagerFactoryâ€)ã€‚</p><p>ä½†å®é™…æ²¡æœ‰ä½¿ç”¨JPAï¼Œå¯¼è‡´å¯åŠ¨æŠ¥é”™ã€‚å¦‚æœæ’é™¤persistence-apiï¼Œåˆä¼šå¯¼è‡´tk.mybatisæŠ¥é”™ã€‚</p><p>å‚è€ƒäº†ä¸€ç•ªå…¶å®ƒçš„äººåšæ³•ï¼Œæ— è®ºæ˜¯å„ç§æ’é™¤è¿˜æ˜¯æ·»åŠ ä¾èµ–éƒ½æ— æ•ˆã€‚</p><p>æœ€ç»ˆè‡ªå·±çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š</p><p>é¦–å…ˆæ’é™¤activiti jpaçš„è‡ªåŠ¨è£…é…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication(exclude=&#123;JpaProcessEngineAutoConfiguration.class&#125;)ã€‚</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰¾åˆ°activitiä¸­çš„<code>DataSourceProcessEngineAutoConfiguration.class</code> å¤åˆ¶å‡ºæºç ï¼Œåœ¨è‡ªå·±çš„é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªåŒåæ–‡ä»¶ï¼ˆä¸åŒåä¹Ÿè¡Œï¼‰ã€‚ç„¶åç²˜è´´å†…å®¹åˆ°æ–°å»ºçš„æ–‡ä»¶ä¸­ã€‚æœ€ååˆ æ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ConditionalOnMissionClass(name = &quot;javax.persistence.EntityManagerFactory&quot;)</span><br></pre></td></tr></table></figure><p>Ok,æå®šï¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç”±äºtk.mybatisä¾èµ–äº†persistence-apiï¼Œä¼šè®©Activitiè£…é…JpaProcessEngineAutoConfigurationï¼Œå› ä¸ºå…¶@conditonalOnclass(name = â€œjavax.persistence.EntityManage</summary>
      
    
    
    
    <category term="Javaéšè®°" scheme="https://jingzhouzhao.github.io/categories/Java%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="Activiti" scheme="https://jingzhouzhao.github.io/tags/Activiti/"/>
    
  </entry>
  
</feed>
